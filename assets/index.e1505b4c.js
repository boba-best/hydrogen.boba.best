var Hr=Object.defineProperty,zr=Object.defineProperties;var Gr=Object.getOwnPropertyDescriptors;var ft=Object.getOwnPropertySymbols;var As=Object.prototype.hasOwnProperty,xs=Object.prototype.propertyIsEnumerable;var Ns=(n,e,t)=>e in n?Hr(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,yt=(n,e)=>{for(var t in e||(e={}))As.call(e,t)&&Ns(n,t,e[t]);if(ft)for(var t of ft(e))xs.call(e,t)&&Ns(n,t,e[t]);return n},Vs=(n,e)=>zr(n,Gr(e));var Ps=(n,e)=>{var t={};for(var s in n)As.call(n,s)&&e.indexOf(s)<0&&(t[s]=n[s]);if(n!=null&&ft)for(var s of ft(n))e.indexOf(s)<0&&xs.call(n,s)&&(t[s]=n[s]);return t};import{a as Us,b as Ge,c as Ds,p as Jr,o as Qr,d as Yr,e as Xr}from"./vendor.5ddfd232.js";function se(...n){const e={};for(const t of n)e[t]=t;return Object.freeze(e)}function Bs(n){try{return new URL(n).origin}catch{return new URL(`https://${n}`).origin}}async function Zr(n,e){const t={format:"json",timeout:3e4,method:"GET"};try{const s=`${n}/.well-known/matrix/client`;return await e(s,t).response()}catch(s){if(s.name==="ConnectionError")return null;throw s}}async function en(n,e){var s;n=Bs(n);const t=await Zr(n,e);if(t&&t.status===200){const{body:i}=t,r=(s=i["m.homeserver"])==null?void 0:s.base_url;typeof r=="string"&&(n=Bs(r))}return n}class J extends Error{get name(){return"AbortError"}}class Ot{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}}class Ue extends Ot{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new sn(Promise.resolve(this.get())):new tn(this,e)}flatMap(e){return new rn(this,e)}}class tn{constructor(e,t){this._promise=new Promise((s,i)=>{this._reject=i,this._subscription=e.subscribe(r=>{t(r)&&(this._reject=null,s(r),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new J),this._reject=null)}}class sn{constructor(e){this.promise=e}dispose(){}}class Q extends Ue{constructor(e){super();this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class Ft extends Q{constructor(e,t){super(e);this._freeCallback=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this._freeCallback()}}class rn extends Ue{constructor(e,t){super();this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();if(!e)return;const t=this.mapper(e);return t==null?void 0:t.get()}}class Ls{constructor(e){this._abortable=void 0;const t=i=>(this._abortable=i,i);this._progress=new Q(void 0);const s=i=>{this._progress.set(i)};this.result=e(t,s)}get progress(){return this._progress}abort(){var e;(e=this._abortable)==null||e.abort(),this._abortable=void 0}}const nn={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},Ks="application/octet-stream";class Se{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",nn[t]||(t=Ks),new Se(new Blob([e],{type:t}),e)}static fromBlob(e){return new Se(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise((s,i)=>{e.addEventListener("load",r=>s(r.target.result)),e.addEventListener("error",r=>i(r.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||Ks}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}function Os(n){return Object.entries(n||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function on(n){if(n instanceof Se){const e=n;return{mimeType:e.mimeType,body:e}}else if(typeof n=="object"){const e=JSON.stringify(n);return{mimeType:"application/json",body:e}}else throw new Error("Unknown body type: "+n)}class Fs extends Error{constructor(e,t){super(`${e}: ${t.message}`);this.cause=t}get name(){return"WrappedError"}}class $s extends Error{constructor(e,t,s,i){super(`${s?s.error:i} on ${e} ${t}`);this.errcode=s?s.errcode:null,this.retry_after_ms=s?s.retry_after_ms:0,this.statusCode=i}get name(){return"HomeServerError"}}class ue extends Error{constructor(e,t){super(e||"ConnectionError");this.isTimeout=t}get name(){return"ConnectionError"}}class an{constructor(e,t,s,i){let r;if(i==null?void 0:i.log){const o=i==null?void 0:i.log;r=o.child({t:"network",url:t,method:e},o.level.Info)}this._log=r,this._sourceRequest=s,this._promise=s.response().then(o=>{var a,c;if(r==null||r.set("status",o.status),o.status>=200&&o.status<300||((a=i==null?void 0:i.allowedStatusCodes)==null?void 0:a.includes(o.status)))return r==null||r.finish(),o.body;if(o.status>=500){const h=new ue("Internal Server Error");throw r==null||r.catch(h),h}else if(o.status>=400&&!((c=o.body)==null?void 0:c.errcode)){const h=new ue(`HTTP error status ${o.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw r==null||r.catch(h),h}else{const h=new $s(e,t,o.body,o.status);throw r==null||r.set("errcode",h.errcode),r==null||r.catch(h),h}},o=>{if(o.name==="AbortError"&&this._sourceRequest){const a=new ue("Service worker aborted, either updating or hit #187.");throw r==null||r.catch(a),a}else throw o.name==="ConnectionError"&&(r==null||r.set("timeout",o.isTimeout)),r==null||r.catch(o),o})}abort(){var e;this._sourceRequest&&((e=this._log)==null||e.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}async responseCode(){return(await this._sourceRequest.response()).status}}const wt="/_matrix/client/r0",cn="/_matrix/client/v3",$t="/_matrix/client/unstable/org.matrix.msc2697.v2";class Ie{constructor({homeserver:e,accessToken:t,request:s,reconnector:i}){this._homeserver=e,this._accessToken=t,this._requestFn=s,this._reconnector=i}_url(e,t=wt){return this._homeserver+t+e}_baseRequest(e,t,s,i,r,o){const a=Os(s);t=`${t}?${a}`;let c;const h=new Map;if(o&&h.set("Authorization",`Bearer ${o}`),h.set("Accept","application/json"),i){const u=on(i);h.set("Content-Type",u.mimeType),c=u.body}const l=this._requestFn(t,{method:e,headers:h,body:c,timeout:r==null?void 0:r.timeout,uploadProgress:r==null?void 0:r.uploadProgress,format:"json",cache:e!=="GET"}),d=new an(e,t,l,r);return this._reconnector&&d.response().catch(u=>{u.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),d}_unauthedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r)}_authedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r,this._accessToken)}_post(e,t,s,i){return this._authedRequest("POST",this._url(e,(i==null?void 0:i.prefix)||wt),t,s,i)}_put(e,t,s,i){return this._authedRequest("PUT",this._url(e,(i==null?void 0:i.prefix)||wt),t,s,i)}_get(e,t,s,i){return this._authedRequest("GET",this._url(e,(i==null?void 0:i.prefix)||wt),t,s,i)}sync(e,t,s,i){return this._get("/sync",{since:e,timeout:s,filter:t},void 0,i)}context(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/context/${encodeURIComponent(t)}`,{filter:i,limit:s})}messages(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,s)}members(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,s)}send(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}redact(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}receipt(e,t,s,i){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},{},i)}state(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},void 0,i)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}register(e,t,s,i,r=!0,o={}){o.allowedStatusCodes=[401];const a={auth:i,password:t,initial_device_displayname:s,inhibit_login:r};return e&&(a.username=e),this._unauthedRequest("POST",this._url("/register",cn),void 0,a,o)}passwordLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:s},i)}tokenLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:s},i)}createFilter(e,t,s){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,s)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,s){let i="/keys/upload";return e&&(i=i+`/${encodeURIComponent(e)}`),this._post(i,{},t,s)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,s,i){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(s)}`,{},t,i)}roomKeysVersion(e,t){let s="";return e&&(s=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${s}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,s,i){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{version:e},void 0,i)}uploadRoomKeysToBackup(e,t,s){return this._put("/room_keys/keys",{version:e},t,s)}uploadAttachment(e,t,s){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,s)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e={}){return e.prefix=$t,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t={}){return t.prefix=$t,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t={}){return t.prefix=$t,this._post("/dehydrated_device/claim",{},{device_id:e},t)}profile(e,t){return this._get(`/profile/${encodeURIComponent(e)}`)}createRoom(e,t){return this._post("/createRoom",{},e,t)}setAccountData(e,t,s,i){return this._put(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,{},s,i)}}var qs;(function(n){n[n.start=2e3]="start"})(qs||(qs={}));class js{constructor(e){this._start=2e3,this._current=2e3;const t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof J))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var De;(function(n){n[n.Waiting=0]="Waiting",n[n.Reconnecting=1]="Reconnecting",n[n.Online=2]="Online"})(De||(De={}));class hn{constructor({retryDelay:e,createMeasure:t,onlineStatus:s}){this._onlineStatus=s,this._retryDelay=e,this._createTimeMeasure=t,this._state=new Q(2),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe(s=>{s&&this.tryNow()});try{await this._reconnectLoop(e)}catch(s){console.error(s)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(1);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}}async function ln(n,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:s}=n,{base64:i}=n.encoding;var r=i.decode(t.iv),o=i.encode(i.decode(t.hashes.sha256));const a=await s.digest("SHA-256",e);if(i.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var c;return t.v=="v1"||t.v=="v2"?c=64:c=128,await s.aes.decryptCTR({jwkKey:t.key,iv:r,data:e,counterLength:c})}async function dn(n,e){const{crypto:t}=n,{base64:s}=n.encoding,i=await t.aes.generateIV(),r=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:r,iv:i,data:o}),c=await t.digest("SHA-256",a);return{blob:n.createBlob(a,"application/octet-stream"),info:{v:"v2",key:r,iv:s.encodeUnpadded(i),hashes:{sha256:s.encodeUnpadded(c)}}}}class un{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,s,i){const r=this._parseMxcUrl(e);if(r){const[o,a]=r;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+Os({width:Math.round(t),height:Math.round(s),method:i})}return null}mxcUrl(e){const t=this._parseMxcUrl(e);if(t){const[s,i]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(s)}/${encodeURIComponent(i)}`}else return null}_parseMxcUrl(e){const t="mxc://";return e.startsWith(t)?e.substr(t.length).split("/",2):null}async downloadEncryptedFile(e,t=!1){const s=this.mxcUrl(e.url),{body:i}=await this._platform.request(s,{method:"GET",format:"buffer",cache:t}).response(),r=await ln(this._platform,i,e);return this._platform.createBlob(r,e.mimetype)}async downloadPlaintextFile(e,t,s=!1){const i=this.mxcUrl(e),{body:r}=await this._platform.request(i,{method:"GET",format:"buffer",cache:s}).response();return this._platform.createBlob(r,t)}async downloadAttachment(e,t=!1){var s;return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,(s=e.info)==null?void 0:s.mimetype,t)}}class mn{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((s,i)=>{this.responseResolve=s,this.responseReject=i})}abort(){var e;this._requestResult?this._requestResult.abort():(this.responseReject(new J),(e=this.responseCodeReject)==null||e.call(this,new J))}response(){return this._responsePromise}responseCode(){return this.requestResult?this.requestResult.responseCode():(this._responseCodePromise||(this._responseCodePromise=new Promise((e,t)=>{this.responseCodeResolve=e,this.responseCodeReject=t})),this._responseCodePromise)}async setRequestResult(e){var i,r;this._requestResult=e;const t=await((i=this._requestResult)==null?void 0:i.response());this.responseResolve(t);const s=await((r=this._requestResult)==null?void 0:r.responseCode());this.responseCodeResolve(s)}get requestResult(){return this._requestResult}}class Ws{constructor(e){this._scheduler=e}}for(const n of Object.getOwnPropertyNames(Ie.prototype))n!=="constructor"&&!n.startsWith("_")&&(Ws.prototype[n]=function(...e){return this._scheduler._hsApiRequest(n,e)});class _n{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new Ws(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const s=new mn(e,t);return this._doSend(s),s}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const s=this._hsApi[e.methodName].apply(this._hsApi,e.args);await e.setRequestResult(s);return}catch(s){if(s instanceof $s&&s.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(s.retry_after_ms)?await this._clock.createTimeout(s.retry_after_ms).elapsed():(t||(t=new js(this._clock.createTimeout)),await t.waitForRetry());else{e.responseReject(s);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}const pn=3e4,S=se("InitialSync","CatchupSync","Syncing","Stopped");function gn(n){var e;try{const t=(e=n==null?void 0:n.timeline)==null?void 0:e.events;return Array.isArray(t)&&t.length===0}catch{return!0}}class fn{constructor({hsApi:e,session:t,storage:s,logger:i}){this._hsApi=e,this._logger=i,this._session=t,this._storage=s,this._currentRequest=null,this._status=new Q(S.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==S.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(S.CatchupSync):this._status.set(S.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==S.Stopped;){let t,s,i=this._status.get()===S.CatchupSync||this._status.get()===S.InitialSync;await this._logger.run("sync",async r=>{r.set("token",e),r.set("status",this._status.get());try{const o=this._status.get()===S.Syncing?pn:0,a=await this._syncRequest(e,o,r);e=a.syncToken,t=a.roomStates,s=a.sessionChanges,this._status.get()!==S.Syncing&&a.hadToDeviceMessages?this._status.set(S.CatchupSync):this._status.set(S.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(r.error=o,r.logLevel=r.level.Fatal),r.set("stopping",!0),this._status.set(S.Stopped)}this._status.get()!==S.Stopped&&await r.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(s,t,o))},this._logger.level.Info,(r,o)=>o.durationWithoutType("network")>=2e3||o.error||i?r.minLevel(o.level.Detail):r.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,s){const i=this._status.get()===S.CatchupSync,r=(async()=>{try{await s.wrap("session",c=>this._session.afterSyncCompleted(e,i,c),s.level.Detail)}catch{}})(),a=t.filter(c=>c.room.needsAfterSyncCompleted(c.changes)).map(async c=>{try{await s.wrap("room",h=>c.room.afterSyncCompleted(c.changes,h),s.level.Detail)}catch{}});await Promise.all(a.concat(r))}async _syncRequest(e,t,s){var m;let{syncFilterId:i}=this._session;typeof i!="string"&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:s}),i=(await this._currentRequest.response()).filter_id);const r=t+80*1e3;this._currentRequest=this._hsApi.sync(e,i,t,{timeout:r,log:s});const o=await this._currentRequest.response(),a=!e,c=new yn,h=this._parseInvites(o.rooms),{roomStates:l,archivedRoomStates:d}=await this._parseRoomsResponse(o.rooms,h,a,s);try{c.lock=await s.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(o)),await s.wrap("prepare",_=>this._prepareSync(c,l,o,_)),await s.wrap("afterPrepareSync",_=>Promise.all(l.map(p=>p.room.afterPrepareSync(p.preparation,_)))),await s.wrap("write",async _=>this._writeSync(c,h,l,d,o,i,a,_))}finally{c.dispose()}s.wrap("after",_=>this._afterSync(c,h,l,d,_));const u=(m=o.to_device)==null?void 0:m.events;return{syncToken:o.next_batch,roomStates:l,sessionChanges:c.changes,hadToDeviceMessages:Array.isArray(u)&&u.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,s,i){var a,c;const r=await this._openPrepareSyncTxn();e.preparation=await i.wrap("session",h=>this._session.prepareSync(s,e.lock,r,h));const o=(a=e.preparation)==null?void 0:a.newKeysByRoom;if(o){const{hasOwnProperty:h}=Object.prototype;for(const l of o.keys())if(!(((c=s.rooms)==null?void 0:c.join)&&h.call(s.rooms.join,l))){let u=this._session.rooms.get(l);u&&t.push(new Hs(u,!1,{},u.membership))}}await Promise.all(t.map(async h=>{const l=o==null?void 0:o.get(h.room.id);h.preparation=await i.wrap("room",async d=>(h.isNewRoom&&await h.room.load(null,r,d),h.room.prepareSync(h.roomResponse,h.membership,l,r,d)),i.level.Detail)})),await r.complete()}async _writeSync(e,t,s,i,r,o,a,c){const h=await this._openSyncTxn();try{e.changes=await c.wrap("session",l=>this._session.writeSync(r,o,e.preparation,h,l)),await Promise.all(t.map(async l=>{l.changes=await c.wrap("invite",d=>l.invite.writeSync(l.membership,l.roomResponse,h,d))})),await Promise.all(s.map(async l=>{l.changes=await c.wrap("room",d=>l.room.writeSync(l.roomResponse,a,l.preparation,h,d))})),await Promise.all(i.map(async l=>{var u;const d=(u=l.roomState)==null?void 0:u.summaryChanges;l.changes=await c.wrap("archivedRoom",m=>l.archivedRoom.writeSync(d,l.roomResponse,l.membership,h,m))}))}catch(l){throw h.abort(c),h.getCause(l)}await h.complete(c)}_afterSync(e,t,s,i,r){r.wrap("session",o=>this._session.afterSync(e.changes,o),r.level.Detail);for(let o of i)r.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},r.level.Detail);for(let o of s)r.wrap("room",a=>o.room.afterSync(o.changes,a),r.level.Detail);for(let o of t)r.wrap("invite",a=>o.invite.afterSync(o.changes,a),r.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,s,i,r)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceIdentities,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions])}async _parseRoomsResponse(e,t,s,i){const r=[],o=[];if(e){const a=["join","leave"];for(const c of a){const h=e[c];if(h)for(const[l,d]of Object.entries(h)){if(s&&gn(d))continue;const u=this._session.invites.get(l);u&&t.push(new zs(u,!1,null,c));const m=this._createRoomSyncState(l,d,c,s);m&&r.push(m);const _=await this._createArchivedRoomSyncState(l,m,d,c,s,i);_&&o.push(_)}}}return{roomStates:r,archivedRoomStates:o}}_createRoomSyncState(e,t,s,i){let r=!1,o=this._session.rooms.get(e);if(!o&&(s==="join"||i&&s==="leave")&&(o=this._session.createJoinedRoom(e),r=!0),o)return new Hs(o,r,t,s)}async _createArchivedRoomSyncState(e,t,s,i,r,o){let a;if((t==null?void 0:t.shouldAdd)&&!r?a=this._session.createOrGetArchivedRoomForSync(e):i==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new wn(a,t,s,i)}_parseInvites(e){const t=[];if(e==null?void 0:e.invite)for(const[s,i]of Object.entries(e.invite)){let r=this._session.invites.get(s),o=!1;r||(r=this._session.createInvite(s),o=!0),t.push(new zs(r,o,i,"invite"))}return t}stop(){this._status.get()!==S.Stopped&&(this._status.set(S.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class yn{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){var e;(e=this.lock)==null||e.release()}}class Hs{constructor(e,t,s,i){this.room=e,this.isNewRoom=t,this.roomResponse=s,this.membership=i,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){var e;return(e=this.changes)==null?void 0:e.summaryChanges}}class wn{constructor(e,t,s,i,r){this.archivedRoom=e,this.roomState=t,this.roomResponse=s,this.membership=i,this.isInitialSync=r,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}}class zs{constructor(e,t,s,i){this.invite=e,this.isNewInvite=t,this.membership=i,this.roomResponse=s,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}}class vt{constructor(){this._handlersByName={}}emit(e,t){const s=this._handlersByName[e];s&&s.forEach(i=>i(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let s=this._handlersByName[e];s||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=s=new Set),s.add(t)}off(e,t){const s=this._handlersByName[e];s&&(s.delete(t),s.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}const Ee=se("Sync","Timeline","Retry"),K="e2ee:",qt="m.olm.v1.curve25519-aes-sha2",Y="m.megolm.v1.aes-sha2";class x extends Error{constructor(e,t,s=null){super(`Decryption error ${e}${s?": "+JSON.stringify(s):""}`);this.code=e,this.event=t,this.details=s}}const Gs="ed25519";function Js(n,e,t,s,i,r=void 0){var h,l;const o=Object.assign({},i);delete o.unsigned,delete o.signatures;const a=Us.stringify(o),c=(l=(h=i==null?void 0:i.signatures)==null?void 0:h[e])==null?void 0:l[`${Gs}:${t}`];try{if(!c)throw new Error("no signature");return n.ed25519_verify(s,a,c),!0}catch(d){if(r){const u=r.log({l:"Invalid signature, ignoring.",ed25519Key:s,canonicalJson:a,signature:c});u.error=d,u.logLevel=r.level.Warn}return!1}}function vn(){return{type:"m.room.encryption",state_key:"",content:{algorithm:Y,rotation_period_ms:6048e5,rotation_period_msgs:100}}}function bn(n,e,t,s,i){return e.length&&(n=e.reduce((r,o)=>kn(r,o,t,s,i),n)),n}function Qs(n,e,t){var r,o;const s=(r=n==null?void 0:n.state)==null?void 0:r.events;Array.isArray(s)&&(t=s.reduce(e,t));const i=(o=n==null?void 0:n.timeline)==null?void 0:o.events;return Array.isArray(i)&&(t=i.reduce((a,c)=>(typeof c.state_key=="string"&&(t=e(t,c)),t),t)),t}function Sn(n,e,t,s){e.summary&&(n=Rn(n,e.summary)),t!==n.membership&&(n=n.cloneIfNeeded(),n.membership=t),e.account_data&&(n=e.account_data.events.reduce(En,n)),n=Qs(e,(r,o)=>Ys(r,o,s),n);const i=e.unread_notifications;return i&&(n=In(n,i)),n}function In(n,e){const t=e.highlight_count||0;t!==n.highlightCount&&(n=n.cloneIfNeeded(),n.highlightCount=t);const s=e.notification_count;return s!==n.notificationCount&&(n=n.cloneIfNeeded(),n.notificationCount=s),n}function En(n,e){var t;if((e==null?void 0:e.type)==="m.tag"){let s=(t=e==null?void 0:e.content)==null?void 0:t.tags;(!s||Array.isArray(s)||typeof s!="object")&&(s=null),n=n.cloneIfNeeded(),n.tags=s}return n}function Ys(n,e,t){var s,i,r;if(e.type==="m.room.create")n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.origin_server_ts;else if(e.type==="m.room.encryption"){const o=(s=e.content)==null?void 0:s.algorithm;!n.encryption&&o===Y&&(n=n.cloneIfNeeded(),n.encryption=e.content)}else if(e.type==="m.room.name"){const o=(i=e.content)==null?void 0:i.name;o!==n.name&&(n=n.cloneIfNeeded(),n.name=o)}else if(e.type==="m.room.avatar"){const o=(r=e.content)==null?void 0:r.url;o!==n.avatarUrl&&(n=n.cloneIfNeeded(),n.avatarUrl=o)}else if(e.type==="m.room.canonical_alias"){const o=e.content;n=n.cloneIfNeeded(),n.canonicalAlias=o.alias}else if(e.type==="m.room.member"){const o=e.content;if(o.is_direct===!0&&o.membership==="invite"&&!n.isDirectMessage){let a;e.sender===t?a=e.state_key:e.state_key===t&&(a=e.sender),a&&(n=n.cloneIfNeeded(),n.isDirectMessage=!0,n.dmUserId=a)}else o.membership==="leave"&&n.isDirectMessage&&n.dmUserId===e.state_key&&(n=n.cloneIfNeeded(),n.isDirectMessage=!1,n.dmUserId=null)}return n}function kn(n,e,t,s,i){return e.eventType==="m.room.message"&&((!n.lastMessageTimestamp||e.timestamp>n.lastMessageTimestamp)&&(n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.timestamp),!t&&e.sender!==i&&s&&(n=n.cloneIfNeeded(),n.isUnread=!0)),n}function Rn(n,e){const t=e["m.heroes"],s=e["m.joined_member_count"],i=e["m.invited_member_count"];return t&&Array.isArray(t)&&(n=n.cloneIfNeeded(),n.heroes=t),Number.isInteger(i)&&(n=n.cloneIfNeeded(),n.inviteCount=i),Number.isInteger(s)&&(n=n.cloneIfNeeded(),n.joinCount=s),n}class ie{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}diff(e){return Object.getOwnPropertyNames(this).reduce((s,i)=>(i!=="cloned"&&this[i]!==e[i]&&(s[i]=this[i]),s),{})}cloneIfNeeded(){return this.cloned?this:new ie(this)}serialize(){return Object.entries(this).reduce((e,[t,s])=>(t!=="cloned"&&s!==null&&(e[t]=s),e),{})}applyTimelineEntries(e,t,s,i){return bn(this,e,t,s,i)}applySyncResponse(e,t,s){return Sn(this,e,t,s)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}}class Cn{constructor(e){this._data=null,this.applyChanges(new ie(null,e))}get data(){return this._data}writeClearUnread(e){const t=new ie(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const s=new ie(this._data);return s.hasFetchedMembers=e,t.roomSummary.set(s.serialize()),s}writeIsTrackingMembers(e,t){const s=new ie(this._data);return s.isTrackingMembers=e,t.roomSummary.set(s.serialize()),s}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const s=await t.readWriteTxn([t.storeNames.roomSummary]);try{s.roomSummary.set(e.serialize())}catch(i){throw s.abort(),i}return await s.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new ie(e))}}var I;(function(n){n.session="session",n.roomState="roomState",n.roomSummary="roomSummary",n.archivedRoomSummary="archivedRoomSummary",n.invites="invites",n.roomMembers="roomMembers",n.timelineEvents="timelineEvents",n.timelineRelations="timelineRelations",n.timelineFragments="timelineFragments",n.pendingEvents="pendingEvents",n.userIdentities="userIdentities",n.deviceIdentities="deviceIdentities",n.olmSessions="olmSessions",n.inboundGroupSessions="inboundGroupSessions",n.outboundGroupSessions="outboundGroupSessions",n.groupSessionDecryptions="groupSessionDecryptions",n.operations="operations",n.accountData="accountData"})(I||(I={}));const Je=Object.values(I);class re extends Error{constructor(e,t=null){super(e);t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const C={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};class T{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new T(this.fragmentId+1,C.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new T(this.fragmentId,this.eventIndex-1)}nextKey(){return new T(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new T(C.maxStorageKey,C.maxStorageKey)}static get minKey(){return new T(C.minStorageKey,C.minStorageKey)}static get defaultLiveKey(){return T.defaultFragmentKey(C.minStorageKey)}static defaultFragmentKey(e){return new T(e,C.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===(e==null?void 0:e.fragmentId)&&this.eventIndex===(e==null?void 0:e.eventIndex)}}const jt=Number.MAX_SAFE_INTEGER;class Xs{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===jt?1:e.fragmentId===jt?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new T(this.fragmentId,this.entryIndex)}}function Wt(n){var e;return((e=n.unsigned)==null?void 0:e.prev_content)||n.prev_content}const X="m.room.redaction";function Ht(n){var e;return!!((e=n==null?void 0:n.unsigned)==null?void 0:e.redacted_because)}var k;(function(n){n[n.None=1]="None",n[n.BeingCreated=2]="BeingCreated",n[n.Invited=4]="Invited",n[n.Joined=8]="Joined",n[n.Replaced=16]="Replaced",n[n.Archived=32]="Archived"})(k||(k={}));var L;(function(n){n[n.DirectMessage=0]="DirectMessage",n[n.Private=1]="Private",n[n.Public=2]="Public"})(L||(L={}));const Mn="m.reaction",me="m.annotation";function Tn(n,e){return{"m.relates_to":{event_id:n,key:e,rel_type:me}}}function zt(n){var e;return n.event_id||((e=n["m.in_reply_to"])==null?void 0:e.event_id)}function Zs(n,e){n.event_id!==void 0?n.event_id=e:n["m.in_reply_to"]&&(n["m.in_reply_to"].event_id=e)}function An(n){if(n.type===X)return n.redacts;{const e=pe(n);if(e)return zt(e)}return null}function _e(n){return n==null?void 0:n["m.relates_to"]}function pe(n){return _e(n.content)}class xn{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce((t,s)=>!t||s.pendingEvent.queueIndex>t.pendingEvent.queueIndex?s:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}}function ei(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Nn(n){switch(n){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function Vn(n){return n==="m.emote"?"* ":""}function Pn(n,e,t,s){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:s,"m.relates_to":{"m.in_reply_to":{event_id:n}}}}function Un(n,e,t){const s=Nn(n.content.msgtype),i=Vn(n.content.msgtype),r=n.sender,o=n.displayName||r,a=s||n.content.formatted_body||n.content.body&&ei(n.content.body)||"",c=`<mx-reply><blockquote>In reply to ${i}<a href="https://matrix.to/#/${r}">${o}</a><br />${a}</blockquote></mx-reply>`,l=(s||n.content.body||"").split(`
`);l[0]=`> ${i}<${r}> ${l[0]}`;const u=l.join(`
> `)+`

`+t,m=c+ei(t);return Pn(n.id,e,u,m)}class ti extends Xs{constructor(e){super(e);this._pendingRedactions=null,this._pendingAnnotations=null,this._contextEntry=null,this._contextForEntries=null}get isReply(){var e;return!!((e=this.relation)==null?void 0:e["m.in_reply_to"])}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===X}get redactionReason(){var e;return this._pendingRedactions?(e=this._pendingRedactions[0].content)==null?void 0:e.reason:null}setContextEntry(e){this._contextEntry=e,e._setAsContextOf(this)}_setAsContextOf(e){this._contextForEntries||(this._contextForEntries=[]),this._contextForEntries.push(e)}get contextForEntries(){return this._contextForEntries}get contextEntry(){return this._contextEntry}addLocalRelation(e){if(e.eventType===X&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===me&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){var t;if(e.eventType===X&&e.isRelatedToId(this.id)&&this._pendingRedactions){const s=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(i=>i!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,s!==0))return"isRedacted"}else{const s=e.redactingEntry||e;if(s.isRelatedToId(this.id)&&((t=s.relation)==null?void 0:t.rel_type)===me&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s||(s=new xn,this._pendingAnnotations.set(t,s)),s.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s.remove(e)&&s.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return Tn(this.id,e)}reply(e,t){return Un(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){var r,o,a;const t=((o=(r=this.annotations)==null?void 0:r[e])==null?void 0:o.me)||!1,s=(a=this.pendingAnnotations)==null?void 0:a.get(e),i=(s==null?void 0:s.willAnnotate)||!1;return t&&(!s||i)||!t&&i}get relation(){return _e(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class Dn extends ti{constructor({pendingEvent:e,member:t,clock:s,redactingEntry:i}){super(null);this._pendingEvent=e,this._member=t,this._timestamp=s.now()-(100-e.queueIndex),this._redactingEntry=i}get fragmentId(){return jt}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){var e;return(e=this._member)==null?void 0:e.userId}get displayName(){var e;return(e=this._member)==null?void 0:e.name}get avatarUrl(){var e;return(e=this._member)==null?void 0:e.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}get contextEventId(){var e;return this.isReply?(e=this._pendingEvent.relatedEventId)!=null?e:this._pendingEvent.relatedTxnId:null}}const v=se("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),si=["m.relates_to"];class Bn{constructor({data:e,remove:t,emitUpdate:s,attachments:i}){this._data=e,this._attachments=i,this._emitUpdate=s,this._removeFromQueueCallback=t,this._aborted=!1,this._status=v.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((r,o)=>r+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=_e(this.content);return e?zt(e):this._data.relatedEventId}setRelatedEventId(e){const t=_e(this.content);t?Zs(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=v.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of si)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const s of si)t[s]!==void 0&&(e[s]=t[s])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=v.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=v.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===v.Sending||this._status===v.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=v.EncryptingAttachments,this._emitUpdate("status");for(const i of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",i.size),i.encrypt())),this.aborted)throw new J}this._status=v.UploadingAttachments,this._emitUpdate("status");const s=Object.entries(this._attachments);s.sort(([,i],[,r])=>i.size-r.size);for(const[i,r]of s)await t.wrap("upload",o=>(o.set("size",r.size),r.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),r.applyToContent(i,this.content);this._data.needsUpload=!1}async abort(){var e;if(!this._aborted){if(this._aborted=!0,this._attachments)for(const t of Object.values(this._attachments))t.abort();(e=this._sendRequest)==null||e.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=v.Sending,this._emitUpdate("status");const s=this._data.encryptedEventType||this._data.eventType,i=this._data.encryptedContent||this._data.content;s===X?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,i,{log:t}):this._sendRequest=e.send(this.roomId,s,this.txnId,i,{log:t});const r=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=r.event_id,t.set("id",this._data.remoteId),this._status=v.Sent,this._emitUpdate("status")}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}class O extends ti{constructor(e,t){super(t);this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new O(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&!this._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&!this._decryptionError&&(this._decryptionError=e._decryptionError),this._contextForEntries=e.contextForEntries,this._contextEntry=e.contextEntry}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.content)||this._eventEntry.event.content}get prevContent(){return Wt(this._eventEntry.event)}get eventType(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.type)||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){var e;return!!((e=this._decryptionResult)==null?void 0:e.event)}get isVerified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isVerified)}get isUnverified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isUnverified)}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return An(this.event)}get isRedacted(){return super.isRedacted||Ht(this._eventEntry.event)}get redactionReason(){var t,s;const e=(t=this._eventEntry.event.unsigned)==null?void 0:t.redacted_because;return e?(s=e.content)==null?void 0:s.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&_e(e)||_e(this.content)}get contextEventId(){return this.isReply?this.relatedEventId:null}}function ii(n,e,t){return{fragmentId:n.fragmentId,eventIndex:n.eventIndex,roomId:e,event:t}}function Qe(n,e,t){t.isForward?n.push(e):n.unshift(e)}function Ln(n,e,t){return t.isForward?n.concat(e):e.concat(n)}const F="m.room.member";class E{constructor(e){this._data=e}static fromUserId(e,t,s){return new E({roomId:e,userId:t,membership:s})}static fromMemberEvent(e,t){const s=t==null?void 0:t.state_key;if(typeof s!="string")return;const i=t.content,r=Wt(t),o=i==null?void 0:i.membership,a=(i==null?void 0:i.displayname)||(r==null?void 0:r.displayname),c=(i==null?void 0:i.avatar_url)||(r==null?void 0:r.avatar_url);return this._validateAndCreateMember(e,s,o,a,c)}static fromReplacingMemberEvent(e,t){const s=t&&t.state_key;if(typeof s!="string")return;const i=Wt(t);return this._validateAndCreateMember(e,s,i==null?void 0:i.membership,i==null?void 0:i.displayname,i==null?void 0:i.avatar_url)}static _validateAndCreateMember(e,t,s,i,r){if(typeof s=="string")return new E({roomId:e,userId:t,membership:s,avatarUrl:r,displayName:i})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,s=e._data;return t.roomId===s.roomId&&t.userId===s.userId&&t.membership===s.membership&&t.displayName===s.displayName&&t.avatarUrl===s.avatarUrl}}class ri{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}}function Gt(n){return typeof n=="number"}const Kn=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(n,e){return n[e]=1,n},{}),On={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};function Fn(n,e){for(const i of Object.keys(e))Kn[i]||delete e[i];const{content:t}=e,s=On[e.type];for(const i of Object.keys(t))(s==null?void 0:s[i])||delete t[i];e.unsigned=e.unsigned||{},e.unsigned.redacted_because=n}function $n(n,e){const t=[];for(;Gt(n.previousId);){const s=e.get(n.previousId);if(!s)break;if(s.nextId!==n.id)throw new Error(`Previous fragment ${s.id} doesn't point back to ${n.id}`);e.delete(n.previousId),t.unshift(s),n=s}return t}function qn(n,e){const t=[];for(;Gt(n.nextId);){const s=e.get(n.nextId);if(!s)break;if(s.previousId!==n.id)throw new Error(`Next fragment ${s.id} doesn't point back to ${n.id}`);e.delete(n.nextId),t.push(s),n=s}return t}function jn(n){const e=new Map;for(let s of n)e.set(s.id,s);const t=[];for(;e.size;){const s=e.values().next().value;e.delete(s.id);const i=$n(s,e),r=qn(s,e),o=i.concat(s,r);t.push(o)}return t.map(s=>new Wn(s))}class Jt{constructor(e,t,s){this.id=e,this.previousId=t,this.nextId=s}}class Wn{constructor(e){this._idToSortIndex=new Map,e.forEach((t,s)=>{this._idToSortIndex.set(t.id,s)})}compare(e,t){const s=this._idToSortIndex.get(e);if(s===void 0)throw new Error(`first id ${e} isn't part of this island`);const i=this._idToSortIndex.get(t);if(i===void 0)throw new Error(`second id ${t} isn't part of this island`);return s-i}get fragmentIds(){return this._idToSortIndex.keys()}}class ni extends Error{get name(){return"CompareError"}}class Hn{constructor(e){this._fragmentsById=e.reduce((t,s)=>(t.set(s.id,s),t),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(t===void 0)throw new ni(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const s=this._getIsland(e),i=this._getIsland(t);if(s!==i)throw new ni(`${e} and ${t} are on different islands, can't tell order`);return s.compare(e,t)}rebuild(e){const t=jn(e);this._idToIsland=new Map;for(let s of t)for(let i of s.fragmentIds)this._idToIsland.set(i,s)}add(e){const t=new Jt(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const s=new Jt(e,t,null),i=this._fragmentsById.get(t);i&&(i.nextId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}prepend(e,t){const s=new Jt(e,null,t),i=this._fragmentsById.get(t);i&&(i.previousId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}}(function(){const e=document.createElement("link").relList;return e&&e.supports&&e.supports("modulepreload")?"modulepreload":"preload"})();function zn(n){return"objectStore"in n?`${n.objectStore.name}.${n.name}`:n.name}function Gn(n){var e,t,s,i,r;return"objectStore"in n?(s=(t=(e=n.objectStore)==null?void 0:e.transaction)==null?void 0:t.db)==null?void 0:s.name:(r=(i=n.transaction)==null?void 0:i.db)==null?void 0:r.name}class oi extends re{constructor(e,t,s=null){const i=t&&"source"in t?t.source:t,r=i?zn(i):"",o=i?Gn(i):"";let a=`${e} on ${o}.${r}`;s&&(a+=": ",typeof s.name=="string"&&(a+=`(name: ${s.name}) `),typeof s.code=="number"&&(a+=`(code: ${s.code}) `)),s&&(a+=s.message);super(a,s);this.storeName=r,this.databaseName=o}}class Qt extends oi{constructor(e){const t=e.target,s=t.source,i=t.error;super("IDBRequest failed",s,i);this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class ne extends oi{constructor(e,t,s,i){super(`${e}(${i.map(r=>JSON.stringify(r)).join(", ")}) failed`,t,s)}}const ai={done:!0},Z={done:!1};function bt(n){const e=n.toString(16);return"0".repeat(8-e.length)+e}function Yt(n){return parseInt(n,16)}function Xt(n,e,t,s=window.indexedDB){const i=s.open(n,t);return i.onupgradeneeded=async r=>{const o=r.target,a=o.result,c=o.transaction,h=r.oldVersion;try{await e(a,c,h,t)}catch{try{c.abort()}catch{}}},N(i)}function N(n){return new Promise((e,t)=>{n.addEventListener("success",s=>{e(s.target.result)}),n.addEventListener("error",s=>{const i=new Qt(s);t(i)})})}function Ye(n){return new Promise((e,t)=>{n.addEventListener("complete",()=>{e()}),n.addEventListener("abort",s=>{t(new J)})})}function M(n,e){return new Promise((t,s)=>{n.onerror=i=>{s(new Qt(i))},n.onsuccess=i=>{const r=i.target.result;if(!r){t(!1);return}const o=e(r.value,r.key,r),a=o==null?void 0:o.done,c=o==null?void 0:o.jumpTo;a?t(!0):c?r.continue(c):r.continue()}}).catch(t=>{throw new re("iterateCursor failed",t)})}async function Jn(n,e){const t=[];return await M(n,s=>(t.push(s),{done:e(t)})),t}class ci{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}count(e){return N(this._target.count(e))}get(e){return N(this._target.get(e))}getKey(e){return this._target.supports("getKey")?N(this._target.getKey(e)):N(this._target.get(e)).then(t=>{if(t){let s=this._target.keyPath;return typeof s=="string"&&(s=[s]),s.reduce((i,r)=>i[r],t)}})}reduce(e,t,s){return this._reduce(e,t,s,"next")}reduceReverse(e,t,s){return this._reduce(e,t,s,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const s=this._openCursor(e,t),i=[];return await M(s,r=>(i.push(r),Z)),i}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let s;return await M(t,(i,r)=>(s=r,ai)),s}async iterateValues(e,t){const s=this._target.openCursor(e,"next");await M(s,(i,r,o)=>({done:t(i,r,o)}))}async iterateKeys(e,t){const s=this._target.openKeyCursor(e,"next");await M(s,(i,r,o)=>({done:t(r,o)}))}async findExistingKeys(e,t,s){const i=(d,u)=>t?-this.idbFactory.cmp(d,u):this.idbFactory.cmp(d,u),r=e.slice().sort(i),o=r[0],a=r[r.length-1],c=t?"prev":"next",h=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),c);let l=0;await M(h,(d,u,m)=>{for(;l<r.length&&i(r[l],u)<0;)l+=1;let _=!1;if(r[l]===u){const p=m.primaryKey;_=s(u,p),l+=1}return _||l>=r.length?ai:{done:!1,jumpTo:r[l]}})}_reduce(e,t,s,i){let r=s;const o=this._openCursor(e,i);return M(o,a=>(r=t(r,a),Z))}_selectLimit(e,t,s){return this._selectUntil(e,i=>i.length===t,s)}async _selectUntil(e,t,s){const i=this._openCursor(e,s),r=[];return await M(i,o=>(r.push(o),{done:t(r,o)})),r}async _selectWhile(e,t,s){const i=this._openCursor(e,s),r=[];return await M(i,o=>{const a=t(o);return a&&r.push(o),{done:!a}}),r}async iterateWhile(e,t){const s=this._openCursor(e,"next");await M(s,i=>({done:!t(i)}))}async _find(e,t,s){const i=this._openCursor(e,s);let r;if(await M(i,a=>{const c=t(a);return c&&(r=a),{done:c}}))return r}}const ge=!1;function fe(n,e,t){var r,o;const s=t==null?void 0:t.name,i=(o=(r=t==null?void 0:t.transaction)==null?void 0:r.db)==null?void 0:o.name;console.info(`${i}.${s}.${n}(${e.map(a=>JSON.stringify(a)).join(", ")})`)}class hi{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(ge&&fe("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(ge&&fe("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(s){throw new ne("openKeyCursor",this._qt,s,[e,t])}}openCursor(e,t){try{return ge&&fe("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(s){throw new ne("openCursor",this._qt,s,[e,t])}}put(e,t){try{return ge&&fe("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(s){throw new ne("put",this._qt,s,[e,t])}}add(e,t){try{return ge&&fe("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(s){throw new ne("add",this._qt,s,[e,t])}}get(e){try{return ge&&fe("get",[e],this._qt),this._qt.get(e)}catch(t){throw new ne("get",this._qt,t,[e])}}getKey(e){try{return ge&&fe("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new ne("getKey",this._qt,t,[e])}}delete(e){try{return ge&&fe("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new ne("delete",this._qt,t,[e])}}count(e){try{return this._qt.count(e)}catch(t){throw new ne("count",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new ne("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class li extends ci{constructor(e,t){super(new hi(e),t)}get _idbStore(){return this._target}index(e){return new ci(new hi(this._idbStore.index(e)),this._transaction)}put(e,t){const s=this._idbStore.put(e);this._prepareErrorLog(s,t,"put",void 0,e)}add(e,t){const s=this._idbStore.add(e);this._prepareErrorLog(s,t,"add",void 0,e)}async tryAdd(e,t){try{return await N(this._idbStore.add(e)),!0}catch(s){if(s instanceof Qt)return t.log({l:"could not write",id:this._getKeys(e),e:s},t.level.Warn),s.preventTransactionAbort(),!1;throw s}}delete(e,t){const s=this._idbStore.delete(e);this._prepareErrorLog(s,t,"delete",e,void 0)}_prepareErrorLog(e,t,s,i,r){t&&t.ensureRefId(),N(e).catch(o=>{let a;r?a=this._getKeys(r):i&&(a=[i]),this._transaction.addWriteError(o,t,s,a)})}_getKeys(e){const t=[],{keyPath:s}=this._idbStore;try{t.push(this._readKeyPath(e,s))}catch{console.warn("could not read keyPath",s)}for(const i of this._idbStore.indexNames)try{const r=this._idbStore.index(i);t.push(this._readKeyPath(e,r.keyPath))}catch{console.warn("could not read index",i)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let s=e;for(const i of t)if(typeof s=="object")s=s[i];else break;return s}else return e[t]}}function Qn(n){return JSON.stringify(di(n))}function Yn(n){return ui(JSON.parse(n))}function di(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(n.byteLength)return{_type:n.constructor.name,value:Array.from(n)};let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=di(n[t]));return e}else return n}function ui(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(typeof n._type=="string")switch(n._type){case"Int8Array":return Int8Array.from(n.value);case"Uint8Array":return Uint8Array.from(n.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(n.value);case"Int16Array":return Int16Array.from(n.value);case"Uint16Array":return Uint16Array.from(n.value);case"Int32Array":return Int32Array.from(n.value);case"Uint32Array":return Uint32Array.from(n.value);case"Float32Array":return Float32Array.from(n.value);case"Float64Array":return Float64Array.from(n.value);case"BigInt64Array":return BigInt64Array.from(n.value);case"BigUint64Array":return BigUint64Array.from(n.value);default:return n.value}let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=ui(n[t]));return e}else return n}class Zt{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return`${this._sessionStore.databaseName}.session.`}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const s=this._localStorageKeyPrefix+e,i=Qn(t);this._localStorage.setItem(s,i)}catch(s){console.error("could not write to localStorage",s)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith(K)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const s=this._localStorageKeyPrefix,i=s+K;for(let r=0;r<this._localStorage.length;r+=1){const o=this._localStorage.key(r);if(o.startsWith(i)){const a=Yn(this._localStorage.getItem(o)),c=o.substr(s.length),h=await this._sessionStore.getKey(c)===c;e.set(c,!h),h||(this._sessionStore.put({key:c,value:a}),t=!0)}}return t}set(e,t){e.startsWith(K)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith(K)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith(K)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class mi{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){const t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}}class Xn{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}var q;(function(n){n[n.All=1]="All",n[n.Debug=2]="Debug",n[n.Detail=3]="Detail",n[n.Info=4]="Info",n[n.Warn=5]="Warn",n[n.Error=6]="Error",n[n.Fatal=7]="Fatal",n[n.Off=8]="Off"})(q||(q={}));class es{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}function St(){}class Zn{constructor(){this.item=new eo(this)}log(){}run(e,t){return t(this.item)}wrapOrRun(e,t,s){return e?e.wrap(t,s):this.run(t,s)}runDetached(e,t){return new Promise(s=>s(t(this.item))).then(St,St),this.item}async export(){}get level(){return q}}class eo{constructor(e){this.logger=e}wrap(e,t){return t(this)}log(){return this}set(){return this}runDetached(e,t){return new Promise(s=>s(t(this))).then(St,St),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return q}get duration(){return 0}catch(e){return e}child(){return this}finish(){}serialize(){}}const to=new Zn;function j(n,e,t){return`${n}|${bt(e)}|${bt(t)}`}function so(n){const[e,t,s]=n.split("|");return{roomId:e,eventKey:new T(Yt(t),Yt(s))}}function It(n,e){return`${n}|${e}`}function _i(n){const[e,t]=n.split("|");return{roomId:e,eventId:t}}class Et{constructor(e,t,s,i,r=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=s,this._upper=i,this._lowerOpen=r,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(j(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(j(e,this._lower.fragmentId,this._lower.eventIndex),j(e,this._lower.fragmentId,C.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(j(e,this._upper.fragmentId,C.minStorageKey),j(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(j(e,this._lower.fragmentId,this._lower.eventIndex),j(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new re("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}}class io{constructor(e){this._timelineStore=e}onlyRange(e){return new Et(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new Et(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new Et(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,s=!1,i=!1){return new Et(this._timelineStore.IDBKeyRange,void 0,e,t,s,i)}async lastEvents(e,t,s){const i=T.maxKey;return i.fragmentId=t,this.eventsBefore(e,i,s)}async firstEvents(e,t,s){const i=T.minKey;return i.fragmentId=t,this.eventsAfter(e,i,s)}eventsAfter(e,t,s){const i=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(i,s)}async eventsBefore(e,t,s){const i=this.upperBoundRange(t,!0).asIDBKeyRange(e),r=await this._timelineStore.selectLimitReverse(i,s);return r.reverse(),r}async getEventKeysForIds(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(o=>It(e,o)),r=new Map;return await s.findExistingKeys(i,!1,(o,a)=>{const{eventId:c}=_i(o),{eventKey:h}=so(a);return r.set(c,h),!1}),r}async findFirstOccurringEventId(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(c=>It(e,c)),r=new Array(i.length);let o;function a(){for(let c=0;c<r.length;++c){if(r[c]===void 0)return;if(r[c]===!0)return i[c]}}return await s.findExistingKeys(i,!1,(c,h)=>{const l=i.indexOf(c);return r[l]=h,o=a(),!!o}),o&&_i(o).eventId}tryInsert(e,t){return e.key=j(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=It(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(j(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(It(e,t))}removeAllForRoom(e){const t=j(e,C.minStorageKey,C.minStorageKey),s=j(e,C.maxStorageKey,C.maxStorageKey),i=this._timelineStore.IDBKeyRange.bound(t,s);this._timelineStore.delete(i)}}const U="\0",A="\u{10FFFF}";function ee(n,e,t,s){return`${n}|${e}|${t}|${s}`}function pi(n){const[e,t,s,i]=n.split("|");return{roomId:e,targetEventId:t,relType:s,sourceEventId:i}}class ro{constructor(e){this._store=e}add(e,t,s,i){this._store.add({key:ee(e,t,s,i)})}remove(e,t,s,i){this._store.delete(ee(e,t,s,i))}removeAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(ee(e,t,U,U),ee(e,t,A,A),!0,!0);this._store.delete(s)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ee(e,U,U,U),ee(e,A,A,A),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,s){const i=this._store.IDBKeyRange.bound(ee(e,t,s,U),ee(e,t,s,A),!0,!0);return(await this._store.selectAll(i)).map(o=>pi(o.key))}async getAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(ee(e,t,U,U),ee(e,t,A,A),!0,!0);return(await this._store.selectAll(s)).map(r=>pi(r.key))}}function gi(n,e,t){return`${n}|${e}|${t}`}class no{constructor(e){this._roomStateStore=e}get(e,t,s){const i=gi(e,t,s);return this._roomStateStore.get(i)}set(e,t){const s=gi(e,t.type,t.state_key),i={roomId:e,event:t,key:s};this._roomStateStore.put(i)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${A}`,!0,!0);this._roomStateStore.delete(t)}}function kt(n,e){return`${n}|${e}`}function oo(n){const[e,t]=n.split("|");return{roomId:e,userId:t}}class fi{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(kt(e,t))}set(e){e.key=kt(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(kt(e,""));return this._roomMembersStore.selectWhile(t,s=>s.roomId===e)}async getAllUserIds(e){const t=[],s=this._roomMembersStore.IDBKeyRange.lowerBound(kt(e,""));return await this._roomMembersStore.iterateKeys(s,i=>{const r=oo(i);return r.roomId===e?(t.push(r.userId),!1):!0}),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${A}`,!0,!0);this._roomMembersStore.delete(t)}}function Rt(n,e){return`${n}|${bt(e)}`}class ao{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(Rt(e,C.minStorageKey),Rt(e,C.maxStorageKey))}catch(t){throw new re(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=Rt(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(Rt(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function ke(n,e){return`${n}|${bt(e)}`}function co(n){const[e,t]=n.split("|"),s=Yt(t);return{roomId:e,queueIndex:s}}class ho{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(ke(e,C.minStorageKey),ke(e,C.maxStorageKey),!1,!1),s=await this._eventStore.findMaxKey(t);if(s)return co(s).queueIndex}remove(e,t){const s=this._eventStore.IDBKeyRange.only(ke(e,t));this._eventStore.delete(s)}async exists(e,t){const s=this._eventStore.IDBKeyRange.only(ke(e,t));return!!await this._eventStore.getKey(s)}add(e){e.key=ke(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=ke(e,C.minStorageKey),s=ke(e,C.maxStorageKey),i=this._eventStore.IDBKeyRange.bound(t,s);this._eventStore.delete(i)}}class lo{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function Re(n,e){return`${n}|${e}`}function uo(n){const[e,t]=n.split("|");return{userId:e,deviceId:t}}class mo{constructor(e){this._store=e}getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(Re(e,""));return this._store.selectWhile(t,s=>s.userId===e)}async getAllDeviceIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(Re(e,""));return await this._store.iterateKeys(s,i=>{const r=uo(i);return r.userId===e?(t.push(r.deviceId),!1):!0}),t}get(e,t){return this._store.get(Re(e,t))}set(e){e.key=Re(e.userId,e.deviceId),this._store.put(e)}getByCurve25519Key(e){return this._store.index("byCurve25519Key").get(e)}remove(e,t){this._store.delete(Re(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(Re(e,U),Re(e,A),!0,!0);this._store.delete(t)}}function Xe(n,e){return`${n}|${e}`}function _o(n){const[e,t]=n.split("|");return{senderKey:e,sessionId:t}}class po{constructor(e){this._store=e}async getSessionIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(Xe(e,""));return await this._store.iterateKeys(s,i=>{const r=_o(i);return r.senderKey===e?(t.push(r.sessionId),!1):!0}),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(Xe(e,""));return this._store.selectWhile(t,s=>s.senderKey===e)}get(e,t){return this._store.get(Xe(e,t))}set(e){e.key=Xe(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(Xe(e,t))}}var Ze;(function(n){n[n.NotBackedUp=0]="NotBackedUp",n[n.BackedUp=1]="BackedUp"})(Ze||(Ze={}));var Be;(function(n){n[n.DeviceMessage=1]="DeviceMessage",n[n.Backup=2]="Backup",n[n.Outbound=3]="Outbound"})(Be||(Be={}));function Le(n,e,t){return`${n}|${e}|${t}`}class go{constructor(e){this._store=e}async has(e,t,s){const i=Le(e,t,s),r=await this._store.getKey(i);return i===r}get(e,t,s){return this._store.get(Le(e,t,s))}set(e){const t=e;t.key=Le(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(Le(e,U,U),Le(e,A,A));this._store.delete(t)}countNonBackedUpSessions(){return this._store.index("byBackup").count(this._store.IDBKeyRange.only(0))}getFirstNonBackedUpSessions(e){return this._store.index("byBackup").selectLimit(this._store.IDBKeyRange.only(0),e)}async markAsBackedUp(e,t,s){const i=await this._store.get(Le(e,t,s));i&&(i.backup=1,this._store.put(i))}async markAllAsNotBackedUp(){const e=this._store.IDBKeyRange.only(1);let t=0;return await this._store.index("byBackup").iterateValues(e,(s,i,r)=>(s.backup=0,r.update(s),t+=1,!1)),t}}class fo{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function Ct(n,e,t){return`${n}|${e}|${t}`}class yo{constructor(e){this._store=e}get(e,t,s){return this._store.get(Ct(e,t,s))}set(e,t,s,i){i.key=Ct(e,t,s),this._store.put(i)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(Ct(e,U,U),Ct(e,A,A));this._store.delete(t)}}function et(n,e){return`${n}|${e}`}class wo{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const s=et(t,e),i=[];return await this._store.index("byScopeAndType").iterateWhile(s,r=>r.scopeTypeKey!==s?!1:(i.push(r),!0)),i}add(e){e.scopeTypeKey=et(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(et(e,U),et(e,A));await this._store.index("byScopeAndType").iterateValues(t,(i,r,o)=>(o.delete(),!0))}}class vo{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}}class bo{constructor(e,t,s,i){this.error=e,this.refItem=t,this.operationName=s,this.keys=i}}class yi{constructor(e,t,s){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=s,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new re(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new li(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const s=this._idbStore(e);this._stores[e]=t(s)}return this._stores[e]}get session(){return this._store(I.session,e=>new Zt(e,this._storage.localStorage))}get roomSummary(){return this._store(I.roomSummary,e=>new mi(e))}get archivedRoomSummary(){return this._store(I.archivedRoomSummary,e=>new mi(e))}get invites(){return this._store(I.invites,e=>new Xn(e))}get timelineFragments(){return this._store(I.timelineFragments,e=>new ao(e))}get timelineEvents(){return this._store(I.timelineEvents,e=>new io(e))}get timelineRelations(){return this._store(I.timelineRelations,e=>new ro(e))}get roomState(){return this._store(I.roomState,e=>new no(e))}get roomMembers(){return this._store(I.roomMembers,e=>new fi(e))}get pendingEvents(){return this._store(I.pendingEvents,e=>new ho(e))}get userIdentities(){return this._store(I.userIdentities,e=>new lo(e))}get deviceIdentities(){return this._store(I.deviceIdentities,e=>new mo(e))}get olmSessions(){return this._store(I.olmSessions,e=>new po(e))}get inboundGroupSessions(){return this._store(I.inboundGroupSessions,e=>new go(e))}get outboundGroupSessions(){return this._store(I.outboundGroupSessions,e=>new fo(e))}get groupSessionDecryptions(){return this._store(I.groupSessionDecryptions,e=>new yo(e))}get operations(){return this._store(I.operations,e=>new wo(e))}get accountData(){return this._store(I.accountData,e=>new vo(e))}async complete(e){try{await Ye(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof re&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e==null||e.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,s,i){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new bo(e,t,s,i))}_logWriteErrors(e){const t=i=>{e||i.set("allowedStoreNames",this._allowedStoreNames);for(const r of this._writeErrors)i.wrap({l:r.operationName,id:r.keys},o=>{r.refItem&&o.refDetached(r.refItem),o.catch(r.error)})},s=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(s,t):this.logger.run(s,t)}}const wi="782rh281re38-boguskey";class So{constructor(e,t,s,i,r,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=s,this._hasWebkitEarlyCloseTxnBug=i,this.storeNames=I,this.localStorage=r,this.logger=o}_validateStoreNames(e){const t=e.findIndex(s=>!Je.includes(s));if(t!==-1)throw new re(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await N(t.objectStore(e[0]).get(wi)),new yi(t,e,this)}catch(t){throw new re("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await N(t.objectStore(e[0]).get(wi)),new yi(t,e,this)}catch(t){throw new re("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}}async function Io(n){const e=n.transaction(Je,"readonly"),t={};return await Promise.all(Je.map(async s=>{const i=t[s]=[],r=e.objectStore(s);await M(r.openCursor(),o=>(i.push(o),Z))})),t}async function Eo(n,e){const t=n.transaction(Je,"readwrite");for(const s of Je){const i=t.objectStore(s);for(const r of e[s])i.add(r)}await Ye(t)}const ts=0,vi=1;function bi(n,e,t){if(n){if(!n.roomIds.includes(t))return n.roomIds.push(t),n}else return n={userId:e,roomIds:[t],deviceTrackingStatus:ts},n}function ko(n){var s;const e=n.device_id;return{userId:n.user_id,deviceId:e,ed25519Key:n.keys[`ed25519:${e}`],curve25519Key:n.keys[`curve25519:${e}`],algorithms:n.algorithms,displayName:(s=n.unsigned)==null?void 0:s.device_display_name}}class Ro{constructor({storage:e,getSyncToken:t,olmUtil:s,ownUserId:i,ownDeviceId:r}){this._storage=e,this._getSyncToken=t,this._identityChangedForRoom=null,this._olmUtil=s,this._ownUserId=i,this._ownDeviceId=r}async writeDeviceChanges(e,t,s){const{userIdentities:i}=t;s.set("changed",e.length),await Promise.all(e.map(async r=>{const o=await i.get(r);o&&(s.log({l:"outdated",id:r}),o.deviceTrackingStatus=ts,i.set(o))}))}writeMemberChanges(e,t,s){return Promise.all(Array.from(t.values()).map(async i=>this._applyMemberChange(i,s)))}async trackRoom(e,t){if(e.isTrackingMembers||!e.isEncrypted)return;const s=await e.loadMemberList(t);try{const i=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities]);let r;try{r=e.writeIsTrackingMembers(!0,i);const o=Array.from(s.members.values());t.set("members",o.length),await this._writeJoinedMembers(o,i)}catch(o){throw i.abort(),o}await i.complete(),e.applyIsTrackingMembersChanges(r)}finally{s.release()}}async _writeJoinedMembers(e,t){await Promise.all(e.map(async s=>{s.membership==="join"&&await this._writeMember(s,t)}))}async _writeMember(e,t){const{userIdentities:s}=t,i=await s.get(e.userId),r=bi(i,e.userId,e.roomId);r&&s.set(r)}async _removeRoomFromUserIdentity(e,t,s){const{userIdentities:i,deviceIdentities:r}=s,o=await i.get(t);o&&(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(i.remove(t),r.removeAllForUser(t)):i.set(o))}async _applyMemberChange(e,t){if(e.hasJoined)await this._writeMember(e.member,t);else if(e.hasLeft){const{roomId:s}=e;if(e.userId===this._ownUserId){const i=await t.roomMembers.getAllUserIds(s);await Promise.all(i.map(r=>this._removeRoomFromUserIdentity(s,r,t)))}else await this._removeRoomFromUserIdentity(s,e.userId,t)}}async _queryKeys(e,t,s){const i=await t.queryKeys({timeout:1e4,device_keys:e.reduce((c,h)=>(c[h]=[],c),{}),token:this._getSyncToken()},{log:s}).response(),r=s.wrap("verify",c=>this._filterVerifiedDeviceKeys(i.device_keys,c)),o=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceIdentities]);let a;try{a=(await Promise.all(r.map(async({userId:h,verifiedKeys:l})=>{const d=l.map(ko);return await this._storeQueriedDevicesForUserId(h,d,o)}))).reduce((h,l)=>h.concat(l),[]),s.set("devices",a.length)}catch(c){throw o.abort(),c}return await o.complete(),a}async _storeQueriedDevicesForUserId(e,t,s){const i=await s.deviceIdentities.getAllDeviceIds(e);for(const c of i)t.every(h=>h.deviceId!==c)&&s.deviceIdentities.remove(e,c);const r=[],o=[];t=await Promise.all(t.map(async c=>{if(i.includes(c.deviceId)){const h=await s.deviceIdentities.get(c.userId,c.deviceId);h.ed25519Key!==c.ed25519Key&&r.push(h)}r.push(c),o.push(c)}));for(const c of o)s.deviceIdentities.set(c);const a=await s.userIdentities.get(e);return a.deviceTrackingStatus=vi,s.userIdentities.set(a),r}_filterVerifiedDeviceKeys(e,t){const s=new Set;return Object.entries(e).map(([r,o])=>{const c=Object.entries(o).filter(([h,l])=>{var b,R;const d=l.device_id;if(l.user_id!==r||d!==h)return!1;const m=(b=l.keys)==null?void 0:b[`ed25519:${h}`],_=(R=l.keys)==null?void 0:R[`curve25519:${h}`];if(typeof m!="string"||typeof _!="string")return!1;if(s.has(_))return t.log({l:"ignore device with duplicate curve25519 key",keys:l},t.level.Warn),!1;s.add(_);const p=this._hasValidSignature(l,t);return p||t.log({l:"ignore device with invalid signature",keys:l},t.level.Warn),p}).map(([,h])=>h);return{userId:r,verifiedKeys:c}})}_hasValidSignature(e,t){var o;const s=e.device_id,i=e.user_id,r=(o=e==null?void 0:e.keys)==null?void 0:o[`${Gs}:${s}`];return Js(this._olmUtil,i,s,r,e,t)}async devicesForTrackedRoom(e,t,s){const i=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),r=await i.roomMembers.getAllUserIds(e);return await this._devicesForUserIds(e,r,i,t,s)}async devicesForRoomMembers(e,t,s,i){const r=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIds(e,t,r,s,i)}async _devicesForUserIds(e,t,s,i,r){const a=(await Promise.all(t.map(p=>s.userIdentities.get(p)))).filter(p=>p&&p.roomIds.includes(e)),c=a.filter(p=>p.deviceTrackingStatus===vi),h=a.filter(p=>p.deviceTrackingStatus===ts);r.set("uptodate",c.length),r.set("outdated",h.length);let l;h.length&&(l=await this._queryKeys(h.map(p=>p.userId),i,r));const d=await this._storage.readTxn([this._storage.storeNames.deviceIdentities]);let m=(await Promise.all(c.map(p=>d.deviceIdentities.getAllForUserId(p.userId)))).reduce((p,b)=>p.concat(b),[]);return l&&l.length&&(m=m.concat(l)),m.filter(p=>!(p.userId===this._ownUserId&&p.deviceId===this._ownDeviceId))}async getDeviceByCurve25519Key(e,t){return await t.deviceIdentities.getByCurve25519Key(e)}}const Si=[Mo,To,Ao,xo,No,Vo,Po,Uo,Do,Bo,Lo,Ko,Oo,Fo,$o,qo];function Co(n){return{databaseName:n.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}}}function Mo(n){n.createObjectStore("session",{keyPath:"key"}),n.createObjectStore("roomSummary",{keyPath:"roomId"}),n.createObjectStore("timelineFragments",{keyPath:"key"}),n.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),n.createObjectStore("roomState",{keyPath:"key"}),n.createObjectStore("pendingEvents",{keyPath:"key"})}async function To(n,e){const t=new fi(n.createObjectStore("roomMembers",{keyPath:"key"})),s=e.objectStore("roomState");await M(s.openCursor(),i=>{if(i.event.type===F){s.delete(i.key);const r=E.fromMemberEvent(i.roomId,i.event);r&&t.set(r.serialize())}return Z})}async function Ao(n,e,t){const s=e.objectStore("session");try{const i=1,r=await N(s.get(i));if(r){s.delete(i);const{syncToken:o,syncFilterId:a,serverVersions:c}=r.value,h=new Zt(s,t);h.set("sync",{token:o,filterId:a}),h.set("serverVersions",c)}}catch(i){e.abort(),console.error("could not migrate session",i.stack)}}function xo(n){n.createObjectStore("userIdentities",{keyPath:"userId"}),n.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),n.createObjectStore("olmSessions",{keyPath:"key"}),n.createObjectStore("inboundGroupSessions",{keyPath:"key"}),n.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),n.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),n.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function No(n,e){var r;const t=e.objectStore("roomSummary"),s=e.objectStore("roomState"),i=[];await M(t.openCursor(),o=>(i.push(o),Z));for(const o of i){const a=await N(s.get(`${o.roomId}|m.room.encryption|`));a&&(o.encryption=(r=a==null?void 0:a.event)==null?void 0:r.content,delete o.isEncrypted,t.put(o))}}function Vo(n){n.createObjectStore("accountData",{keyPath:"type"})}function Po(n){n.createObjectStore("invites",{keyPath:"roomId"})}function Uo(n){n.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function Do(n,e){try{const t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await M(t.openCursor(),(s,i,r)=>{const{typeScopeKey:o}=s;delete s.typeScopeKey;const[a,c]=o.split("|");return s.scopeTypeKey=et(c,a),r.update(s),Z}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function Bo(n){n.createObjectStore("timelineRelations",{keyPath:"key"})}async function Lo(n,e,t,s){const i=e.objectStore("roomSummary"),r=[];await M(i.openCursor(),h=>(h.isTrackingMembers&&r.push(h.roomId),Z));const o=e.objectStore("outboundGroupSessions"),a=e.objectStore("userIdentities"),c=e.objectStore("roomMembers");for(const h of r){let l=!1;const d=[],u=IDBKeyRange.bound(h,`${h}|${A}`,!0,!0);await s.wrap({l:"room",id:h},async m=>{var _;await M(c.openCursor(u),p=>(p.membership==="join"&&d.push(p.userId),Z)),m.set("joinedUserIds",d.length);for(const p of d){const b=await N(a.get(p)),R=(_=b==null?void 0:b.roomIds)==null?void 0:_.length,G=bi(b,p,h);G&&(m.log({l:"fixing up",id:p,roomsBefore:R,roomsAfter:G.roomIds.length}),a.put(G),l=!0)}m.set("foundMissing",l),l&&o.delete(h)})}}async function Ko(n,e){const t=e.objectStore("session"),s=await N(t.get("ssssKey"));s&&t.put({key:`${K}ssssKey`,value:s.value})}async function Oo(n,e,t,s){const i=e.objectStore("session"),r=new Zt(new li(i,Co(n)),t);r.writeE2EEIdentityToLocalStorage();const o=await r.tryRestoreE2EEIdentityFromLocalStorage(s);s.set("restored",o)}async function Fo(n,e){for(const t of n.objectStoreNames){const s=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await M(s.openCursor(),(i,r,o)=>(r.startsWith(K)||o.delete(),Z));break}default:{s.clear();break}}}}async function $o(n,e,t,s){e.objectStore("inboundGroupSessions").createIndex("byBackup","backup",{unique:!1})}async function qo(n,e,t,s){const i=e.objectStore("inboundGroupSessions");let r=0,o=0;await M(i.openCursor(),(a,c,h)=>(a.session?(a.backup=Ze.NotBackedUp,a.source=Be.DeviceMessage,h.update(a),r+=1):o+=1,Z)),s.set("countWithoutSession",o),s.set("countWithSession",r)}async function jo(n){const e="hydrogen_webkit_test_inactive_txn_bug";try{const t=await Xt(e,r=>{r.createObjectStore("test",{keyPath:"key"})},1,n),s=t.transaction(["test"],"readonly");await N(s.objectStore("test").get("somekey")),await new Promise(r=>setTimeout(r,0));const i=t.transaction(["test"],"readwrite");await Promise.resolve(),i.objectStore("test").add({key:"somekey",value:"foo"}),await Ye(i),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}const Ii=n=>`hydrogen_session_${n}`,ss=function(n,e,t,s){const i=(r,o,a,c)=>zo(r,o,a,c,t,s);return Xt(Ii(n),i,Si.length,e)};async function Wo(){var e,t;const n=this;if((t=(e=n==null?void 0:n.navigator)==null?void 0:e.storage)==null?void 0:t.persist)return await n.navigator.storage.persist();if(n==null?void 0:n.document.requestStorageAccess)try{return await n.document.requestStorageAccess(),!0}catch{return!1}else return!1}class Ho{constructor(e,t=window.indexedDB,s=window.IDBKeyRange,i=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=s,this._localStorage=i}async create(e,t){var r;await((r=this._serviceWorkerHandler)==null?void 0:r.preventConcurrentSessionAccess(e)),Wo().then(o=>{o||console.warn("no persisted storage, database can be evicted by browser")});const s=await jo(this._idbFactory),i=await ss(e,this._idbFactory,this._localStorage,t);return new So(i,this._idbFactory,this._IDBKeyRange,s,this._localStorage,t.logger)}delete(e){const t=Ii(e),s=this._idbFactory.deleteDatabase(t);return N(s)}async export(e,t){const s=await ss(e,this._idbFactory,this._localStorage,t);return await Io(s)}async import(e,t,s){const i=await ss(e,this._idbFactory,this._localStorage,s);return await Eo(i,t)}}async function zo(n,e,t,s,i,r){const o=t||0;return r.wrap({l:"storage migration",oldVersion:t,version:s},async a=>{for(let c=o;c<s;++c){const h=Si[c];await a.wrap(`v${c+1}`,l=>h(n,e,i,l))}})}class Ei{constructor({roomId:e,ownUserId:t,fragmentIdComparer:s}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=s}async writeRelation(e,t,s){const{relatedEventId:i}=e;if(i){const r=pe(e.event);r&&r.rel_type&&t.timelineRelations.add(this._roomId,r.event_id,r.rel_type,e.id);const o=await t.timelineEvents.getByEventId(this._roomId,i);if(o){const a=await this._applyRelation(e,o,t,s);if(a)return a.map(c=>(t.timelineEvents.update(c),new O(c,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,s,i){const r=new O(e,this._fragmentIdComparer),o=await this.writeRelation(r,s,i);if(t.isBackward&&!Ht(e.event)){const a=await s.timelineRelations.getAllForTarget(this._roomId,r.id);if(a.length)for(const c of a){const h=await s.timelineEvents.getByEventId(this._roomId,c.sourceEventId);if(h){const l=new O(h,this._fragmentIdComparer);await this._applyRelation(l,e,s,i)}}}return o}async _applyRelation(e,t,s,i){if(e.eventType===X)return i.wrap("redact",async r=>{const o=t.event,a=pe(o);if(this._applyRedaction(e.event,t,s,r)){const h=[t];if(a){const l=await this._reaggregateRelation(o,a,s,r);l&&h.push(l)}return h}return null});{const r=pe(e.event);if(r&&!Ht(t.event)&&r.rel_type===me&&i.wrap("react",c=>this._aggregateAnnotation(e.event,t,c)))return[t]}return null}_applyRedaction(e,t,s,i){const r=t.event;i.set("redactionId",e.event_id),i.set("id",r.event_id);const o=pe(r);return o&&o.rel_type&&s.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,r.event_id),s.timelineRelations.removeAllForTarget(this._roomId,r.event_id),Fn(e,r),delete t.annotations,!0}_aggregateAnnotation(e,t){const s=pe(e);if(!s)return!1;let{annotations:i}=t;i||(t.annotations=i={});let r=i[s.key];r||(i[s.key]=r={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const o=e.sender===this._ownUserId;return r.me=r.me||o,r.count+=1,r.firstTimestamp=Math.min(r.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,s,i){return t.rel_type===me?i.wrap("reaggregate annotations",r=>this._reaggregateAnnotation(t.event_id,t.key,s,r)):null}async _reaggregateAnnotation(e,t,s,i){const r=await s.timelineEvents.getByEventId(this._roomId,e);if(!r||!r.annotations)return null;i.set("id",e);const o=await s.timelineRelations.getForTargetAndType(this._roomId,e,me);return i.set("relations",o.length),delete r.annotations[t],Go(r.annotations)&&delete r.annotations,await Promise.all(o.map(async a=>{const c=await s.timelineEvents.getByEventId(this._roomId,a.sourceEventId);c||i.log({l:"missing annotation",id:a.sourceEventId}),pe(c.event).key===t&&this._aggregateAnnotation(c.event,r,i)})),r}}function Go(n){for(const e in n)if(n.hasOwnProperty(e))return!1;return!0}class oe{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?oe.Backward:oe.Forward}static get Forward(){return Jo}static get Backward(){return Qo}}const Jo=new oe(!0),Qo=new oe(!1);class W extends Xs{constructor(e,t,s){super(s);this._fragment=e,this._isFragmentStart=t}static start(e,t){return new W(e,!0,t)}static end(e,t){return new W(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?C.minStorageKey:C.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return Gt(this.linkedFragmentId)}get direction(){return this.started?oe.Backward:oe.Forward}withUpdatedFragment(e){return new W(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new W(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}function Yo(n){const e=new Set;return n.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}class Xo{constructor({roomId:e,fragmentIdComparer:t,memberWriter:s,relationWriter:i}){this._roomId=e,this._memberWriter=s,this._relationWriter=i,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s){const[i]=await e.timelineEvents.lastEvents(this._roomId,s.id,1),r=i?i.eventIndex:T.defaultLiveKey.eventIndex;this._lastLiveKey=new T(s.id,r)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s)return s;{t||(t=null);const i={roomId:this._roomId,id:T.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(i),this._fragmentIdComparer.add(i),i}}async _replaceLiveFragment(e,t,s,i){const r=await i.timelineFragments.get(this._roomId,e);if(!r)throw new Error(`old live fragment doesn't exist: ${e}`);r.nextId=t,i.timelineFragments.update(r);const o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:s,nextToken:null};return i.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:r,newFragment:o}}async _ensureLiveFragment(e,t,s,i,r){if(e){if(s.limited){const o=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:a,newFragment:c}=await this._replaceLiveFragment(o,e.fragmentId,s.prev_batch,i);t.push(W.end(a,this._fragmentIdComparer)),t.push(W.start(c,this._fragmentIdComparer)),r.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(i,s.prev_batch);e=new T(o.id,T.defaultLiveKey.eventIndex),t.push(W.start(o,this._fragmentIdComparer)),r.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,s){let i=0;for(const r of e)r.type!==F&&(t.roomState.set(this._roomId,r),i+=1);s.set("stateEvents",i)}async _writeTimeline(e,t,s,i,r,o){const a=[],c=[];if(e==null?void 0:e.length){i=await this._ensureLiveFragment(i,a,t,r,o),o.set("timelineEvents",e.length);let h=0;for(const l of e){i=i.nextKey();const d=ii(i,this._roomId,l);let u=await s.lookupMemberAtEvent(l.sender,l,r);if(u&&(d.displayName=u.displayName,d.avatarUrl=u.avatarUrl),!await r.timelineEvents.tryInsert(d,o))continue;const _=new O(d,this._fragmentIdComparer);a.push(_);const p=await this._relationWriter.writeRelation(_,r,o);p&&c.push(...p),typeof l.state_key=="string"&&l.type!==F&&(h+=1,r.roomState.set(this._roomId,l))}o.set("timelineStateEventCount",h)}return{currentKey:i,entries:a,updatedEntries:c}}async _handleRejoinOverlap(e,t,s){if(this._lastLiveKey){const{fragmentId:i}=this._lastLiveKey,[r]=await t.timelineEvents.lastEvents(this._roomId,i,1);if(r){const o=r.event.event_id,{events:a}=e,c=a.findIndex(h=>h.event_id===o);if(c!==-1)return s.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(c+1)})}}return e.limited?e:(s.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,s,i,r){let{timeline:o}=e;r.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,i,r));let a;Array.isArray(o==null?void 0:o.events)&&(a=Yo(o.events));const{state:c}=e;let h;Array.isArray(c==null?void 0:c.events)&&(h=c.events);const l=this._memberWriter.prepareMemberSync(h,a,s);h&&await this._writeStateEvents(h,i,r);const{currentKey:d,entries:u,updatedEntries:m}=await this._writeTimeline(a,o,l,this._lastLiveKey,i,r),_=await l.write(i);return{entries:u,updatedEntries:m,newLiveKey:d,memberChanges:_}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class ki{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let s=t?this._entries.findIndex(t):-1;this._entries.unshift(e),s===-1?this._entries.length>this.limit&&(s=this._entries.length-1):s+=1,s!==-1&&(this.onEvictEntry(this._entries[s]),this._entries.splice(s,1))}onEvictEntry(e){}}class Zo extends ki{constructor(e,t){super(e);this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){const t=this._keyFn(e);this._set(e,s=>this._keyFn(s)===t)}}class ea{constructor(e){this._roomId=e,this._cache=new Zo(5,t=>t.userId)}prepareMemberSync(e,t,s){return new ta(this,e,t,s)}async _writeMember(e,t){let s=this._cache.get(e.userId);if(!s){const i=await t.roomMembers.get(this._roomId,e.userId);i&&(s=new E(i))}if(!s||!s.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new ri(e,s==null?void 0:s.membership)}async lookupMember(e,t){let s=this._cache.get(e);if(!s){const i=await t.roomMembers.get(this._roomId,e);i&&(s=new E(i),this._cache.set(s))}return s}}class ta{constructor(e,t,s,i){this._memberWriter=e,this._timelineEvents=s,this._hasFetchedMembers=i,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const s of e)if(s.type===F){const i=E.fromMemberEvent(this._roomId,s);i&&(t||(t=new Map),t.set(i.userId,i))}return t}_timelineEventsToMembers(e){let t;for(let s=e.length-1;s>=0;s--){const i=e[s],r=i.state_key;if(i.type===F&&!(t==null?void 0:t.has(r))){const o=E.fromMemberEvent(this._roomId,i);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,s){var r;let i;return this._timelineEvents&&(i=this._findPrecedingMemberEventInTimeline(e,t),i)||(i=(r=this._newStateMembers)==null?void 0:r.get(e),i)?i:await this._memberWriter.lookupMember(e,s)}async write(e){const t=new Map;let s;if(this._timelineEvents&&(s=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(const i of this._newStateMembers.values())if(!(s==null?void 0:s.has(i.userId))){const r=await this._memberWriter._writeMember(i,e);r&&(!this._hasFetchedMembers&&!r.previousMembership&&(r.previousMembership=i.membership),t.set(r.userId,r))}}if(s)for(const i of s.values()){const r=await this._memberWriter._writeMember(i,e);r&&t.set(r.userId,r)}return t}_findPrecedingMemberEventInTimeline(e,t){let s=-1;for(let i=this._timelineEvents.length-1;i>=0;i--)if(this._timelineEvents[i].event_id===t.event_id){s=i;break}for(let i=s-1;i>=0;i--){const r=this._timelineEvents[i];if(r.type===F&&r.state_key===e){const o=E.fromMemberEvent(this._roomId,r);if(o)return o}}}}class sa{constructor({roomId:e,storage:t,fragmentIdComparer:s,relationWriter:i}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._relationWriter=i}async _findOverlappingEvents(e,t,s,i){const r=t.map(h=>h.event_id),o=await s.timelineEvents.getEventKeysForIds(this._roomId,r);i.set("existingEvents",o.size);const a=t.filter(h=>!o.has(h.event_id));i.set("nonOverlappingEvents",a.length);let c;if(e.hasLinkedFragment){i.set("linkedFragmentId",e.linkedFragmentId);for(const h of o.values())if(h.fragmentId===e.linkedFragmentId){i.set("foundLinkedFragment",!0);const l=await s.timelineFragments.get(this._roomId,e.linkedFragmentId);c=e.createNeighbourEntry(l);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:c}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:s,direction:i}=e,r=await this._findFragmentEdgeEvent(s,i,t);return r?new T(r.fragmentId,r.eventIndex):T.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,s){if(t.isBackward){const[i]=await s.timelineEvents.firstEvents(this._roomId,e,1);return i}else{const[i]=await s.timelineEvents.lastEvents(this._roomId,e,1);return i}}async _storeEvents(e,t,s,i,r,o){const a=[],c=[];let h=t;for(let l=0;l<e.length;++l){const d=e[l];h=h.nextKeyForDirection(s);const u=ii(h,this._roomId,d),m=this._findMember(d.sender,i,e,l,s);m&&(u.displayName=m.displayName,u.avatarUrl=m.avatarUrl);const _=await this._relationWriter.writeGapRelation(u,s,r,o);if(_&&c.push(..._),await r.timelineEvents.tryInsert(u,o)){const p=new O(u,this._fragmentIdComparer);Qe(a,p,s)}}return{entries:a,updatedEntries:c}}_findMember(e,t,s,i,r){function o(h){return h.type===F&&h.state_key===e}const a=r.isBackward?1:-1;for(let h=i+a;h>=0&&h<s.length;h+=a){const l=s[h];if(o(l))return E.fromMemberEvent(this._roomId,l)}for(let h=i;h>=0&&h<s.length;h-=a){const l=s[h];if(o(l))return E.fromReplacingMemberEvent(this._roomId,l)}const c=t==null?void 0:t.find(o);if(c)return E.fromMemberEvent(this._roomId,c)}async _updateFragments(e,t,s,i,r,o){const{direction:a}=e,c=[];return Qe(i,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,r.timelineFragments.update(t.fragment),Qe(i,t,a),c.push(e.fragment),c.push(t.fragment)):e.token=s,r.timelineFragments.update(e.fragment),c}async writeFragmentFill(e,t,s,i){const{fragmentId:r,direction:o}=e,{chunk:a,start:c,state:h}=t;let{end:l}=t;if(!Array.isArray(a))throw new Error("Invalid chunk in response");if(typeof l!="string")throw new Error("Invalid end token in response");const d=await s.timelineFragments.get(this._roomId,r);if(!d)throw new Error(`Unknown fragment: ${r}`);if(e=e.withUpdatedFragment(d),e.token!==c)throw new Error("start is not equal to prev_batch or next_batch");if(a.length===0)return e.edgeReached=!0,await s.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let u=await this._findFragmentEdgeEventKey(e,s);i.set("lastKey",u.toString());const{nonOverlappingEvents:m,neighbourFragmentEntry:_}=await this._findOverlappingEvents(e,a,s,i),{entries:p,updatedEntries:b}=await this._storeEvents(m,u,o,h,s,i),R=await this._updateFragments(e,_,l,p,s,i);return{entries:p,updatedEntries:b,fragments:R}}}class Ke extends Ot{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t,this)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s,this)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t,this)}emitMove(e,t,s){for(let i of this._handlers)i.onMove(e,t,s,this)}}/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function ye(n,e,t){let s=0,i=n.length;for(;s<i;){let r=s+i>>>1,o=t(e,n[r]);o>0?s=r+1:o<0?i=r:s=i=r}return i}class Oe extends Ot{emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t)}emitUpdate(e,t,...s){for(let i of this._handlers)i.onUpdate(e,t,...s)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t)}[Symbol.iterator](){throw new Error("unimplemented")}get size(){throw new Error("unimplemented")}get(e){throw new Error("unimplemented")}}class tt extends Oe{constructor(e){super();this._values=new Map(e)}update(e,t){const s=this._values.get(e);return s!==void 0?(this._values.set(e,s),this.emitUpdate(e,s,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class ia extends Ke{constructor(e,t){super();this._sourceMap=e,this._comparator=(s,i)=>t(s.value,i.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const s={key:e,value:t},i=ye(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,0,s),this.emitAdd(i,t)}onRemove(e,t){const s={key:e,value:t},i=ye(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,1),this.emitRemove(i,t)}onUpdate(e,t,s){if(!this._sortedPairs)return;const i=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(i,1);const r={key:e,value:t},o=ye(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(o,0,r),i!==o&&this.emitMove(i,o,t),this.emitUpdate(o,t,s)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,s]of this._sourceMap)this._sortedPairs[e]={key:t,value:s},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class ra extends Oe{constructor(e,t){super();this._source=e,this._filter=t,this._included=null,this._subscription=null}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){const t=this._included;this._included=this._included||new Map;for(const[s,i]of this._source){const r=this._filter(i,s);if(this._included.set(s,r),!e){const o=t?t.get(s):!0;this._emitForUpdate(o,r,s,i)}}}else{if(this._included&&!e)for(const[t,s]of this._source)this._included.get(t)||this.emitAdd(t,s);this._included=null}}onAdd(e,t){if(this._filter){const s=this._filter(t,e);if(this._included.set(e,s),!s)return}this.emitAdd(e,t)}onRemove(e,t){const s=!this._filter||this._included.get(e);this._included.delete(e),s&&this.emitRemove(e,t)}onUpdate(e,t,s){if(!!this._included)if(this._filter){const i=this._included.get(e),r=this._filter(t,e);this._included.set(e,r),this._emitForUpdate(i,r,e,t,s)}else this.emitUpdate(e,t,s)}_emitForUpdate(e,t,s,i,r=null){e&&!t?this.emitRemove(s,i):!e&&t?this.emitAdd(s,i):e&&t&&this.emitUpdate(s,i,r)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=null,this._subscription=this._subscription()}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new na(this._source,this._included)}get size(){let e=0;return this._included.forEach(t=>{t&&(e+=1)}),e}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class na{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(;;){const e=this._sourceIterator.next();if(e.done)return e;const t=e.value[0];if(this._included.get(t))return e}}}class oa extends Oe{constructor(e,t,s){super();this._source=e,this._mapper=t,this._updater=s,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const s=this._mappedValues.get(e);s&&this.emitUpdate(e,s,t)}onAdd(e,t){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i),this.emitAdd(e,i)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&this.emitRemove(e,t)}onUpdate(e,t,s){var r;if(!this._mappedValues)return;const i=this._mappedValues.get(e);i!==void 0&&((r=this._updater)==null||r.call(this,i,s,t),this.emitUpdate(e,i,s))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription(),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class aa extends Oe{constructor(e){super();this._sources=e,this._subscriptions=null}onAdd(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitRemove(t,i),this.emitAdd(t,s)}}onRemove(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,s);const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitAdd(t,i)}}onUpdate(e,t,s,i){!this._subscriptions||this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,s,i)}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new ha(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const s=this._sources.indexOf(e);for(let i=0;i<s;i+=1)if(this._sources[i].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){const s=this._sources.indexOf(e);for(let i=s+1;i<this._sources.length;i+=1){const o=this._sources[i].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){super.onUnsubscribeLast();for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new ca(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(const t of this._sources){const s=t.get(e);if(s)return s}return null}}class ca{constructor(e){this._sources=e,this._sourceIndex=-1,this._currentIterator=null,this._encounteredKeys=new Set}next(){let e;for(;!e;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const t=this._currentIterator.next();if(t.done){this._currentIterator=null;continue}else{const s=t.value[0];this._encounteredKeys.has(s)||(this._encounteredKeys.add(s),e=t)}}return e}}class ha{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=null}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription=this._subscription()}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,s){this._joinedMap.onUpdate(this._source,e,t,s)}onReset(){this._joinedMap.onReset(this._source)}}class la extends Ke{constructor(e=[]){super();this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let s of t)this.insert(e,s),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[s]=this._items.splice(e,1);this._items.splice(t,0,s),this.emitMove(e,t,s)}}update(e,t,s=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,s))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function Ri(n,e,t,s){const i=e.findIndex(n);if(i!==-1){const r=e[i],o=s(r);return o!==!1&&t.emitUpdate(i,r,o),!0}return!1}class is extends Ke{constructor(e){super();this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return Ri(e,this._items,this,t)}getAndUpdate(e,t,s=null){const i=this.indexOf(e);if(i!==-1){const r=this._items[i],o=t(r,e);this._items[i]=o,this.emitUpdate(i,o,s)}}update(e,t=null){const s=this.indexOf(e);s!==-1&&(this._items[s]=e,this.emitUpdate(s,e,t))}indexOf(e){const t=ye(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=ye(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const s=ye(this._items,e,this._comparator);s>=this._items.length||this._comparator(this._items[s],e)!==0?(this._items.splice(s,0,e),this.emitAdd(s,e)):(this._items[s]=e,this.emitUpdate(s,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new da(this)}}class da{constructor(e){this._sortedArray=e,this._current=null}next(){if(this._sortedArray){if(this._current?this._current=this._sortedArray._getNext(this._current):this._current=this._sortedArray.get(0),this._current)return{value:this._current};this._sortedArray=null}if(!this._sortedArray)return{done:!0}}}class ua extends Ke{constructor(e,t,s,i){super();this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=s,this._removeCallback=i}findAndUpdate(e,t){return Ri(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}function ma(n,e,t){n._mappedValues.splice(e,0,t),n.emitAdd(e,t)}function _a(n,e,t,s){const i=n._mappedValues[e];n._updater&&n._updater(i,s,t),n.emitUpdate(e,i,s)}function pa(n,e){const t=n._mappedValues[e];n._mappedValues.splice(e,1),n._removeCallback&&n._removeCallback(t),n.emitRemove(e,t)}function ga(n,e,t){const s=n._mappedValues[e];n._mappedValues.splice(e,1),n._mappedValues.splice(t,0,s),n.emitMove(e,t,s)}function fa(n){n._mappedValues=[],n.emitReset()}class ya extends ua{constructor(){super(...arguments);this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new Ci(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new Sa),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new Ci(e,t)),this._flush())}onUpdate(e,t,s){this._eventQueue&&(this._eventQueue.push(new wa(e,t,s)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new va(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new ba(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class Ci{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);ma(e,this.index,t)}}class wa{constructor(e,t,s){this.index=e,this.value=t,this.params=s}async run(e){_a(e,this.index,this.value,this.params)}}class va{constructor(e){this.index=e}async run(e){pa(e,this.index)}}class ba{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){ga(e,this.fromIdx,this.toIdx)}}class Sa{async run(e){fa(e)}}class Ia extends Ke{constructor(...e){super();this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let s=0;for(let i=0;i<t;++i)s+=this._sourceLists[i].length;return s}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,s){this.emitAdd(this._offsetForSource(s)+e,t)}onUpdate(e,t,s,i){!this._sourceUnsubscribes||this.emitUpdate(this._offsetForSource(i)+e,t,s)}onRemove(e,t,s){this.emitRemove(this._offsetForSource(s)+e,t)}onMove(e,t,s,i){const r=this._offsetForSource(i);this.emitMove(r+e,r+t,s)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let s=t.next();for(;s.done;){if(e+=1,e>=this._sourceLists.length)return s;t=this._sourceLists[e][Symbol.iterator](),s=t.next()}return s}}}}Object.assign(Oe.prototype,{sortValues(n){return new ia(this,n)},mapValues(n,e){return new oa(this,n,e)},filterValues(n){return new ra(this,n)},join(...n){return new aa([this].concat(n))}});function rs(n){typeof n=="function"?n():n.dispose()}function Ea(n){return n&&(typeof n=="function"||typeof n.dispose=="function")}class ns{constructor(){this._disposables=[]}track(e){if(!Ea(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),rs(e),e):(this._disposables.push(e),e)}untrack(e){if(this.isDisposed)return console.warn("Disposables already disposed, cannot untrack"),null;const t=this._disposables.indexOf(e);return t>=0&&this._disposables.splice(t,1),null}dispose(){if(this._disposables){for(const e of this._disposables)rs(e);this._disposables=null}}get isDisposed(){return this._disposables===null}disposeTracked(e){if(e==null||this.isDisposed)return null;const t=this._disposables.indexOf(e);if(t!==-1){const[s]=this._disposables.splice(t,1);rs(s)}else console.warn("disposable not found, did it leak?",e);return null}}class Mi{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}async function ka(n,e,t,s,i,r){let o=[];const a=r.timelineEvents,c=r.timelineFragments;for(;o.length<s&&e;){let h;t.isForward?h=await a.eventsAfter(n,e,s):h=await a.eventsBefore(n,e,s);let l=h.map(d=>new O(d,i));if(o=Ln(o,l,t),o.length<s){const d=await c.get(n,e.fragmentId);let u=new W(d,t.isBackward,i);if(Qe(o,u,t),!u.token&&u.hasLinkedFragment){const m=await c.get(n,u.linkedFragmentId);i.add(m);const _=new W(m,t.isForward,i);Qe(o,_,t),e=_.asEventKey()}else e=null}}return o}class Ti{constructor({roomId:e,storage:t,fragmentIdComparer:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,s,i){return new Mi(async(r,o)=>{const a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,s,r,a,o)},i)}readFromEnd(e,t=null,s){return new Mi(async(i,r)=>{const o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId);let c;if(!a)c=[];else{this._fragmentIdComparer.add(a);const h=W.end(a,this._fragmentIdComparer),l=h.asEventKey();c=await this._readFrom(l,oe.Backward,e,i,o,r),c.unshift(h)}return c},s)}async readById(e,t){let s=[this._storage.storeNames.timelineEvents];this._decryptEntries&&s.push(this._storage.storeNames.inboundGroupSessions);const i=await this._storage.readTxn(s),r=await i.timelineEvents.getByEventId(this._roomId,e);if(r){const o=new O(r,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o],i,t).complete(),o}}async _readFrom(e,t,s,i,r,o){const a=await ka(this._roomId,e,t,s,this._fragmentIdComparer,r);if(this._decryptEntries){i.decryptRequest=this._decryptEntries(a,r,o);try{await i.decryptRequest.complete()}finally{i.decryptRequest=null}}return a}}class Ra extends O{get fragmentId(){throw new Error("Cannot access fragmentId for non-persisted EventEntry")}get entryIndex(){throw new Error("Cannot access entryIndex for non-persisted EventEntry")}get isNonPersisted(){return!0}get isRedacting(){return!1}get isRedacted(){return super.isRedacting}}class Ca{constructor(e){this._userId=e}get id(){return this._userId}}class Mt{constructor({roomId:e,storage:t,closeCallback:s,fragmentIdComparer:i,pendingEvents:r,clock:o,powerLevelsObservable:a,hsApi:c}){this._roomId=e,this._storage=t,this._closeCallback=s,this._fragmentIdComparer=i,this._disposables=new ns,this._pendingEvents=r,this._clock=o,this._remoteEntries=new is((h,l)=>h.compare(l)),this._ownMember=null,this._timelineReader=new Ti({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this._contextEntriesNotInTimeline=new Map,this._decryptEntries=null,this._hsApi=c,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,s){const i=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),r=await i.roomMembers.get(this._roomId,e.id);r?this._ownMember=new E(r):this._ownMember=E.fromUserId(this._roomId,e.id,t);const o=this._disposables.track(this._timelineReader.readFromEnd(20,i,s));try{const a=await o.complete();this._loadContextEntriesWhereNeeded(a),this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new ya(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,s)=>{t.notifyUpdate(s)},t=>this._applyAndEmitLocalRelationChange(t,s=>s.removeLocalRelation(t))):this._localEntries=new la,this._allEntries=new Ia(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===X&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const s=new Dn({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._loadContextEntriesWhereNeeded([s]),this._applyAndEmitLocalRelationChange(s,i=>i.addLocalRelation(s)),s}_applyAndEmitLocalRelationChange(e,t){var i,r;const s=o=>{const a=t(o);return a||!1};if(this._findAndUpdateEntryById(e.pendingEvent.relatedTxnId,e.relatedEventId,s),e.redactingEntry){const o=(i=e.redactingEntry.pendingEvent)==null?void 0:i.relatedTxnId;this._findAndUpdateEntryById(o,e.redactingEntry.relatedEventId,s),(r=e.redactingEntry.contextForEntries)==null||r.forEach(a=>this._emitUpdateForEntry(a,"contextEntry"))}}_findAndUpdateEntryById(e,t,s){let i=!1;e&&(i=this._localEntries.findAndUpdate(r=>r.id===e,s)),!i&&t&&this._remoteEntries.findAndUpdate(r=>r.id===t,s)}async getOwnAnnotationEntry(e,t){const s=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),i=await s.timelineRelations.getForTargetAndType(this._roomId,e,me);for(const r of i){const o=await s.timelineEvents.getByEventId(this._roomId,r.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&pe(o.event).key===t){const a=new O(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){var t;if(!!((t=this._localEntries)==null?void 0:t.hasSubscriptions))for(const s of this._localEntries){if(s.relatedEventId){const i=e.find(r=>r.id===s.relatedEventId);i==null||i.addLocalRelation(s)}if(s.redactingEntry){const i=s.redactingEntry.relatedEventId,r=e.find(o=>o.id===i);r==null||r.addLocalRelation(s)}}}static _entryUpdater(e,t){var s;return(s=e.contextForEntries)==null||s.forEach(i=>i.setContextEntry(t)),t.updateFrom(e),t}replaceEntries(e){var t;this._addLocalRelationsToNewRemoteEntries(e);for(const s of e)try{this._remoteEntries.getAndUpdate(s,Mt._entryUpdater);const i=this._contextEntriesNotInTimeline.get(s.id);i&&(Mt._entryUpdater(i,s),this._contextEntriesNotInTimeline.set(s.id,s)),(t=s.contextForEntries)==null||t.forEach(r=>this._emitUpdateForEntry(r,"contextEntry"))}catch(i){if(i.name==="CompareError")continue;throw i}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._updateEntriesFetchedFromHomeserver(e),this._moveEntryToRemoteEntries(e),this._loadContextEntriesWhereNeeded(e),this._remoteEntries.setManySorted(e)}_updateEntriesFetchedFromHomeserver(e){var t;for(const s of e){const i=this._contextEntriesNotInTimeline.get(s.relatedEventId);(i==null?void 0:i.isNonPersisted)&&(i==null?void 0:i.addLocalRelation(s))&&((t=i.contextForEntries)==null||t.forEach(r=>this._emitUpdateForEntry(r,"contextEntry")))}}_moveEntryToRemoteEntries(e){for(const t of e){const s=this._contextEntriesNotInTimeline.get(t.id);s&&(s.contextForEntries.forEach(i=>{i.setContextEntry(t),this._emitUpdateForEntry(i,"contextEntry")}),this._contextEntriesNotInTimeline.delete(t.id))}}_emitUpdateForEntry(e,t){const s=e.isPending?e.id:null,i=e.isPending?null:e.id;this._findAndUpdateEntryById(s,i,()=>t)}async _loadContextEntriesWhereNeeded(e){for(const t of e){if(!t.contextEventId)continue;const s=t.contextEventId;let i=e.find(r=>r.id===s);i||(i=this._findLoadedEventById(s)),i?t.setContextEntry(i):this._loadContextEntryNotInTimeline(t)}}async _loadContextEntryNotInTimeline(e){const t=e.contextEventId;let s=await this._getEventFromStorage(t);s||(s=await this._getEventFromHomeserver(t)),s&&(this._contextEntriesNotInTimeline.set(t,s),e.setContextEntry(s),this._emitUpdateForEntry(e,"contextEntry"))}_findLoadedEventById(e){var t;return(t=this.getByEventId(e))!=null?t:this._contextEntriesNotInTimeline.get(e)}async _getEventFromStorage(e){return await this._timelineReader.readById(e)}async _getEventFromHomeserver(e){const t=await this._hsApi.context(this._roomId,e,0).response(),s=t.event.sender,i=t.state.find(a=>a.type===F&&a.user_id===s),r={event:t.event,displayName:i.content.displayname,avatarUrl:i.content.avatar_url},o=new Ra(r,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o]).complete(),o}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find(i=>!!i.eventType);if(!t)return!0;const s=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),oe.Backward,e));try{const i=await s.complete();return this.addEntries(i),i.length<e}finally{this._disposables.disposeTracked(s)}}async _getOrLoadEntry(e,t){var s;if(e){for(const i of this._localEntries)if(i.id===e)return i}return t?(s=this.getByEventId(t))!=null?s:await this._getEventFromStorage(t):null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const s=this._remoteEntries.get(t);if(s.id===e)return s}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._decryptEntries=e,this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function Ma({roomId:n,storage:e}){return(await(await e.readTxn([e.storeNames.roomMembers])).roomMembers.getAll(n)).map(i=>new E(i))}async function Ta({summary:n,syncToken:e,roomId:t,hsApi:s,storage:i,setChangedMembersMap:r},o){const a=new Map;r(a);const c=await s.members(t,{at:e},{log:o}).response(),h=await i.readWriteTxn([i.storeNames.roomSummary,i.storeNames.roomMembers]);let l,d;try{l=n.writeHasFetchedMembers(!0,h);const{roomMembers:u}=h,m=c.chunk;if(!Array.isArray(m))throw new Error("malformed");o.set("members",m.length),d=await Promise.all(m.map(async _=>{const p=_==null?void 0:_.state_key;if(!p)throw new Error("malformed");const b=a.get(p);if(b)return b;{const R=E.fromMemberEvent(t,_);return R&&u.set(R.serialize()),R}}))}catch(u){throw h.abort(),u}finally{r(null)}return await h.complete(),n.applyChanges(l),d}async function Aa(n,e){const{summary:t}=n;return t.data.hasFetchedMembers?Ma(n):e.wrapOrRun(n.log,"fetchMembers",s=>Ta(n,s))}async function xa(n,e){const t=await Na(n),{summary:s}=n;return!s.data.hasFetchedMembers&&!t?e.wrapOrRun(n.log,"fetchMember",i=>Va(n,i)):t}async function Na({roomId:n,userId:e,storage:t}){const i=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(n,e);return i?new E(i):null}async function Va({roomId:n,userId:e,hsApi:t,storage:s},i){let r;try{r=await t.state(n,"m.room.member",e,{log:i}).response()}catch(c){if(c.name==="HomeServerError"&&c.errcode==="M_NOT_FOUND")return null;throw c}const o=new E({roomId:n,userId:e,membership:r.membership,avatarUrl:r.avatar_url,displayName:r.displayname}),a=await s.readWriteTxn([s.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(c){throw a.abort(),c}return await a.complete(),o}class Pa{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}}class Ua extends Pa{constructor({members:e,closeCallback:t}){super(t);this._members=new tt;for(const s of e)this._members.add(s.userId,s)}afterSync(e){for(const[t,s]of e.entries())this._members.set(t,s.member)}get members(){return this._members}}function os(n,e,t){const s=e.joinCount+e.inviteCount-1;if(n.length>=s)if(n.length>1){const i=n[n.length-1];return n.slice(0,n.length-1).map(o=>o.name).join(", ")+" and "+i.name}else{const i=n[0];return i?i.name:(t.log({l:"could get get other member name",length:n.length,otherMember:!!i,otherMemberMembership:i==null?void 0:i.membership}),"Unknown DM Name")}else return n.length<s?n.map(i=>i.name).join(", ")+` and ${s} others`:null}class as{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,s){const i=new Map,r=[];for(const o of this._members.keys())e.indexOf(o)===-1&&r.push(o);for(const[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&i.set(o,a.member);for(const o of e)if(!this._members.has(o)&&!i.has(o)){const a=await s.roomMembers.get(this._roomId,o);if(a){const c=new E(a);i.set(c.userId,c)}}return{updatedHeroMembers:i.values(),removedUserIds:r}}applyChanges({updatedHeroMembers:e,removedUserIds:t},s,i){for(const o of t)this._members.delete(o);for(const o of e)this._members.set(o.userId,o);const r=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=os(r,s,i)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(const e of this._members.keys())return e;return null}}class Da{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let s=this._map.get(e);return s||(s=new Ba(this,t,e),this._map.set(e,s)),s}updateEvents(e){for(let t=0;t<e.length;t+=1){const s=e[t],i=this._map.get(s.id);i==null||i.update(s)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}}class Ba extends Ue{constructor(e,t,s){super();this._eventMap=e,this._entry=t,this._id=s,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}function La(n){return n||to.item}const Ka="m.room.power_levels";class Tt{constructor({powerLevelEvent:e,createEvent:t,ownUserId:s,membership:i}){this._plEvent=e,this._createEvent=t,this._ownUserId=s,this._membership=i}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){var t,s,i,r;if(this._plEvent){let o=(s=(t=this._plEvent.content)==null?void 0:t.users)==null?void 0:s[e];if(typeof o!="number"&&(o=(i=this._plEvent.content)==null?void 0:i.users_default),typeof o=="number")return o}else if(this._createEvent&&e===((r=this._createEvent.content)==null?void 0:r.creator))return 100;return 0}_getActionLevel(e){var s;const t=(s=this._plEvent)==null?void 0:s.content[e];return typeof t=="number"?t:50}_getEventTypeLevel(e){var s,i,r;const t=(i=(s=this._plEvent)==null?void 0:s.content.events)==null?void 0:i[e];if(typeof t=="number")return t;{const o=(r=this._plEvent)==null?void 0:r.content.events_default;return typeof o=="number"?o:0}}}const Oa="m.room.encrypted";class Ai extends vt{constructor({roomId:e,storage:t,hsApi:s,mediaRepository:i,emitCollectionChange:r,user:o,createRoomEncryption:a,getSyncToken:c,platform:h}){super();this._roomId=e,this._storage=t,this._hsApi=s,this._mediaRepository=i,this._summary=new Cn(e),this._fragmentIdComparer=new Hn([]),this._emitCollectionChange=r,this._timeline=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=c,this._platform=h,this._observedEvents=null,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null}async _eventIdsToEntries(e,t){const s=[];return await Promise.all(e.map(async i=>{const r=await t.timelineEvents.getByEventId(this._roomId,i);r&&s.push(new O(r,this._fragmentIdComparer))})),s}_getAdditionalTimelineRetryEntries(e,t){let s=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const i=e.reduce((r,o)=>(r.add(o.id),r),new Set);return s=s.filter(r=>!i.has(r.id)),s}async notifyRoomKey(e,t,s){var o;if(!this._roomEncryption)return;const i=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let r=await this._eventIdsToEntries(t,i);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(r,[e]);r=r.concat(a)}if(r.length){await this._decryptEntries(Ee.Retry,r,i,s).complete(),(o=this._timeline)==null||o.replaceEntries(r);const c=this._summary.data.applyTimelineEntries(r,!1,!1);await this._summary.writeAndApplyData(c,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,Ee.Timeline)),!0):!1}_decryptEntries(e,t,s,i=null){return new Fa(async(o,a)=>{if(s||(s=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;const c=t.filter(_=>_.eventType===Oa).map(_=>_.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(c,null,e,s),o.cancelled)return;const h=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;const l=[this._storage.storeNames.groupSessionDecryptions],d=this._isTimelineOpen;d&&l.push(this._storage.storeNames.deviceIdentities);const u=await this._storage.readWriteTxn(l);let m;try{m=await h.write(u,a),d&&await m.verifySenders(u)}catch(_){throw u.abort(),_}await u.complete(),m.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t)},La(i))}async _getSyncRetryDecryptEntries(e,t,s){let r=(await Promise.all(e.map(async o=>{const a=await t.getEventIdsForMissingKey(o,s);if(a)return this._eventIdsToEntries(a,s)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(r,e).map(c=>c.clone());r=r.concat(a)}return r}async load(e,t,s){s.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const i=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(i)}if(this._summary.data.needsHeroes){this._heroes=new as(this._roomId);const i=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(i,this._summary.data,s)}}catch(i){throw new Fs(`Could not load room ${this._roomId}`,i)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const s=await xa({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!s)return null;const i=new Ft(s,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,i),i}async loadMemberList(e=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const t=await Aa({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,syncToken:this._getSyncToken(),setChangedMembersMap:s=>this._changedMembersDuringSync=s,log:e},this._platform.logger);return this._memberList=new Ua({members:t,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,s=null){return this._platform.logger.wrapOrRun(s,"fillGap",async i=>{if(i.set("id",this.id),i.set("fragment",e.fragmentId),i.set("dir",e.direction.asApiString()),e.edgeReached){i.set("edgeReached",!0);return}const r=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:i}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let a,c;try{a=await this._writeGapFill(r.chunk,o,i);const h=new Ei({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});c=await new sa({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:h}).writeFragmentFill(e,r,o,i)}catch(h){throw o.abort(),h}await o.complete(),this._roomEncryption&&await this._decryptEntries(Ee.Timeline,c.entries,null,i).complete();for(const h of c.fragments)this._fragmentIdComparer.add(h);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(c.updatedEntries),this._timeline.addEntries(c.entries))})}async _writeGapFill(e,t,s){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}isDirectMessageForUserId(e){if(this._summary.data.dmUserId===e)return!0;{const{heroes:t,joinCount:s,inviteCount:i}=this._summary.data;if(t&&t.includes(e)&&s+i===2)return!0}return!1}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new Tt({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const s=await e.roomState.get(this._roomId,"m.room.create","");if(s)return new Tt({createEvent:s.event,ownUserId:this._user.id,membership:this.membership});{const i=this.membership;return new Tt({ownUserId:this._user.id,membership:i})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new Ft(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableKeyBackup(e){var t;(t=this._roomEncryption)==null||t.enableKeyBackup(e),this._timeline&&e&&this._platform.logger.run("enableKeyBackup",s=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,s))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}openTimeline(e=null){return this._platform.logger.wrapOrRun(e,"open timeline",async t=>{if(t.set("id",this.id),this._timeline)throw new Error("not dealing with load race here for now");this._timeline=new Mt({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels(),hsApi:this._hsApi});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,Ee.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(s){throw this._timeline.dispose(),s}return this._timeline})}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new Da(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const s=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(i=>{s.update(i)}).catch(i=>{console.warn(`could not load event ${e} from storage`,i)}),s}async _readEventById(e){return await new Ti({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}).readById(e)}dispose(){var e,t;(e=this._roomEncryption)==null||e.dispose(),(t=this._timeline)==null||t.dispose()}}class Fa{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",s=>e(this,s))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}function At(){const e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return"t"+"0".repeat(14-e.length)+e}function xi(n){return n.startsWith("t")&&n.length===15}class $a{constructor({roomId:e,storage:t,hsApi:s,pendingEvents:i}){i=i||[],this._roomId=e,this._storage=t,this._hsApi=s,this._pendingEvents=new is((r,o)=>r.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(i.map(r=>this._createPendingEvent(r))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){const s=new Bn({data:e,remove:()=>this._removeEvent(s),emitUpdate:i=>this._pendingEvents.update(s,i),attachments:t});return s}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(const s of this._pendingEvents)await t.wrap("send event",async i=>{i.set("queueIndex",s.queueIndex);try{this._currentQueueIndex=s.queueIndex,await this._sendEvent(s,i)}catch(r){r instanceof ue?(this._offline=!0,i.set("offline",!0),s.setWaiting()):(i.catch(r),r.name==="HomeServerError"&&(r.statusCode===400||r.statusCode===403||r.statusCode===404)?(i.set("remove",!0),await s.abort()):s.setError(r))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",s=>e.uploadAttachments(this._hsApi,s)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const s=e.contentForEncryption,{type:i,content:r}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,s,this._hsApi,o));e.setEncrypted(i,r),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,s),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,s)}catch(i){throw s.abort(),i}await s.complete()}}async _resolveRemoteIdInPendingRelations(e,t,s){const i=this._pendingEvents.array.filter(r=>r.relatedTxnId===e&&r.relatedEventId!==t);for(const r of i)r.setRelatedEventId(t),await this._tryUpdateEventWithTxn(r,s);return i}async removeRemoteEchos(e,t,s){const i=[];for(const r of e){const o=r.unsigned&&r.unsigned.transaction_id;let a;if(o?a=this._pendingEvents.array.findIndex(c=>c.txnId===o):a=this._pendingEvents.array.findIndex(c=>c.remoteId===r.event_id),a!==-1){const c=this._pendingEvents.get(a),h=r.event_id;s.log({l:"removeRemoteEcho",queueIndex:c.queueIndex,remoteId:h,txnId:o}),t.pendingEvents.remove(c.roomId,c.queueIndex),i.push(c),await this._resolveRemoteIdInPendingRelations(o,h,t)}}return i}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{s.pendingEvents.remove(e.roomId,e.queueIndex)}catch{s.abort()}await s.complete();const i=this._pendingEvents.array.indexOf(e);i!==-1&&this._pendingEvents.remove(i)}e.dispose()}emitRemovals(e){for(const t of e){const s=this._pendingEvents.array.indexOf(t);s!==-1&&this._pendingEvents.remove(s),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,s,i){const r=_e(t);let o=null;if(r){const a=zt(r);if(xi(a)&&(o=a,Zs(r,null)),r.rel_type===me&&this._pendingEvents.array.some(h=>{const l=_e(h.content);return h.eventType===e&&l&&l.key===r.key&&(h.relatedTxnId===o||l.event_id===r.event_id)})){i.set("already_annotating",!0);return}}await this._enqueueEvent(e,t,s,o,null,i)}async _enqueueEvent(e,t,s,i,r,o){const a=await this._createAndStoreEvent(e,t,i,r,s);this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem)}async enqueueRedaction(e,t,s){if(this._pendingEvents.array.some(a=>a.eventType===X&&(a.relatedTxnId===e||a.relatedEventId===e))){s.set("already_redacting",!0);return}let r,o;if(xi(e)){r=e;const a=e,c=this._pendingEvents.array.find(h=>h.txnId===a);if(c&&!c.remoteId&&c.status!==v.Sending){s.set("remove",r),await c.abort();return}else if(c)o=c.remoteId;else return}else{o=e;const a=this._pendingEvents.array.find(c=>c.remoteId===o);a&&(r=a.txnId)}s.set("relatedTxnId",r),s.set("relatedEventId",o),await this._enqueueEvent(X,{reason:t},null,r,o,s)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(s){throw t.abort(),s}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,s,i,r){const o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let a;try{const c=o.pendingEvents,h=await c.getMaxQueueIndex(this._roomId)||0,d=Math.max(h,this._currentQueueIndex)+1,u=e!==X&&e!==Mn&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:d,eventType:e,content:t,relatedTxnId:s,relatedEventId:i,txnId:At(),needsEncryption:u,needsUpload:!!r},r),c.add(a.data)}catch(c){throw o.abort(),c}return await o.complete(),a}dispose(){for(const e of this._pendingEvents)e.dispose()}}class Ni{constructor({filename:e,blob:t,platform:s}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=s,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){var e;(e=this._uploadRequest)==null||e.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await dn(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,s){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:r=>{this._sentBytes=r,t()},log:s});const{content_uri:i}=await this._uploadRequest.response();this._mxcUrl=i}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let s=e.substr(0,e.lastIndexOf("url"));xt(`${s}info.size`,t,this._transferredBlob.size),xt(`${s}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?xt(`${s}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):xt(`${s}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function xt(n,e,t){const s=n.split(".");let i=e;for(let o=0;o<s.length-1;o+=1){const a=s[o];i[a]||(i[a]={}),i=i[a]}const r=s[s.length-1];i[r]=t}const qa="m.room.encrypted";class ja extends Ai{constructor(e){super(e);const{pendingEvents:t}=e,s=new Ei({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new Xo({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:s,memberWriter:new ea(this.id)}),this._sendQueue=new $a({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}async prepareSync(e,t,s,i,r){var l;r.set("id",this.id),s&&r.set("newKeys",s.length);let o=this._summary.data.applySyncResponse(e,t,this._user.id),a=this._roomEncryption;!a&&o.encryption&&(r.set("enableEncryption",!0),a=this._createRoomEncryption(this,o.encryption));let c,h;if(a){let d=((l=e==null?void 0:e.timeline)==null?void 0:l.events)||[];s&&(c=await this._getSyncRetryDecryptEntries(s,a,i),c.length&&(r.set("retry",c.length),d=d.concat(c.map(u=>u.event)))),d=d.filter(u=>(u==null?void 0:u.type)===qa),d.length&&(h=await a.prepareDecryptAll(d,s,Ee.Sync,i))}return{roomEncryption:a,summaryChanges:o,decryptPreparation:h,decryptChanges:null,retryEntries:c}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async s=>{s.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:s,decryptChanges:i,roomEncryption:r,retryEntries:o},a,c){var Ts;c.set("id",this.id);const h=s.isNewJoin(this._summary.data);h&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));const{entries:l,updatedEntries:d,newLiveKey:u,memberChanges:m}=await c.wrap("syncWriter",be=>this._syncWriter.writeSync(e,h,s.hasFetchedMembers,a,be),c.level.Detail);if(i){const be=await c.wrap("decryptChanges",Wr=>i.write(a,Wr));c.set("decryptionResults",be.results.size),c.set("decryptionErrors",be.errors.size),this._isTimelineOpen&&await be.verifySenders(a),be.applyToEntries(l),(o==null?void 0:o.length)&&(be.applyToEntries(o),d.push(...o))}c.set("newEntries",l.length),c.set("updatedEntries",d.length);let _=!1;r&&this.isTrackingMembers&&(m==null?void 0:m.size)&&(_=await r.writeMemberChanges(m,a,c),c.set("shouldFlushKeyShares",_));const p=l.concat(d);s=s.applyTimelineEntries(p,t,!this._isTimelineOpen,this._user.id),s.membership!=="join"?a.roomSummary.remove(this.id):s=this._summary.writeData(s,a),s&&c.set("summaryChanges",s.diff(this._summary.data));let b;(s==null?void 0:s.needsHeroes)&&(this._heroes||(this._heroes=new as(this._roomId)),b=await this._heroes.calculateChanges(s.heroes,m,a));let R;Array.isArray((Ts=e.timeline)==null?void 0:Ts.events)&&(R=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,c));const G=this._getPowerLevelsEvent(e);return{summaryChanges:s,roomEncryption:r,newEntries:l,updatedEntries:d,newLiveKey:u,removedPendingEvents:R,memberChanges:m,heroChanges:b,powerLevelsEvent:G,shouldFlushKeyShares:_}}afterSync(e,t){const{summaryChanges:s,newEntries:i,updatedEntries:r,newLiveKey:o,removedPendingEvents:a,memberChanges:c,powerLevelsEvent:h,heroChanges:l,roomEncryption:d}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(d),c.size){if(this._changedMembersDuringSync)for(const[m,_]of c.entries())this._changedMembersDuringSync.set(m,_.member);if(this._memberList&&this._memberList.afterSync(c),this._observedMembers&&this._updateObservedMembers(c),this._timeline){for(const[m,_]of c.entries())if(m===this._user.id){this._timeline.updateOwnMember(_.member);break}}}let u=!1;if(s&&(this._summary.applyChanges(s),this._summary.data.needsHeroes||(this._heroes=null),u=!0),this._heroes&&l){const m=this.name;this._heroes.applyChanges(l,this._summary.data,t),m!==this.name&&(u=!0)}h&&this._updatePowerLevels(h),u&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(r),this._timeline.addEntries(i)),this._observedEvents&&(this._observedEvents.updateEvents(r),this._observedEvents.updateEvents(i)),a&&this._sendQueue.emitRemovals(a)}_updateObservedMembers(e){for(const[t,s]of e){const i=this._observedMembers.get(t);i&&i.set(s.member)}}_getPowerLevelsEvent(e){var i,r,o;const t=a=>a.state_key===""&&a.type===Ka;return(o=(i=e.timeline)==null?void 0:i.events.find(t))!=null?o:(r=e.state)==null?void 0:r.events.find(t)}_updatePowerLevels(e){if(this._powerLevels){const t=new Tt({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}needsAfterSyncCompleted({shouldFlushKeyShares:e}){return e}async afterSyncCompleted(e,t){t.set("id",this.id),this._roomEncryption&&await this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,t)}start(e,t){if(this._roomEncryption){const s=e==null?void 0:e.get("share_room_key");s&&t.wrapDetached("flush room keys",i=>(i.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,s,i)))}this._sendQueue.resumeSending(t)}async load(e,t,s){try{await super.load(e,t,s),await this._syncWriter.load(t,s)}catch(i){throw new Fs(`Could not load room ${this._roomId}`,i)}}async _writeGapFill(e,t,s){return await this._sendQueue.removeRemoteEchos(e,t,s)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,s,i=null){return this._platform.logger.wrapOrRun(i,"send",r=>(r.set("id",this.id),this._sendQueue.enqueueEvent(e,t,s,r)))}sendRedaction(e,t,s=null){return this._platform.logger.wrapOrRun(s,"redact",i=>(i.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,i)))}async ensureMessageKeyIsShared(e=null){if(!!this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){var e;return((e=this._heroes)==null?void 0:e.roomAvatarColorId)||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){var t;const e=this._syncWriter.lastMessageKey;if(e){const i=await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,e);return(t=i==null?void 0:i.event)==null?void 0:t.event_id}}async clearUnread(e=null){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async t=>{t.set("id",this.id);const s=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let i;try{i=this._summary.writeClearUnread(s)}catch(r){throw s.abort(),r}await s.complete(),this._summary.applyChanges(i),this._emitUpdate();try{const r=await this._getLastEventId();r&&await this._hsApi.receipt(this._roomId,"m.read",r)}catch(r){if(r.name!=="ConnectionError")throw r}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}_getPendingEvents(){return this._sendQueue.pendingEvents}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new Ni({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class Wa extends Ai{constructor(e){super(e);this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){const s=await t.roomMembers.get(this.id,e);return s?new E(s):E.fromUserId(this.id,e,"join")}async load(e,t,s){const{summary:i,kickDetails:r}=e;return this._kickDetails=r,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(i,t,s)}async writeSync(e,t,s,i,r){if(r.set("id",this.id),s==="leave"){const o=Ha(t,this._user.id);if(o||e){const a=o||this._kickDetails;let c;o&&(c=await this._getKickAuthor(o.sender,i));const h=e||this._summary.data;return i.archivedRoomSummary.set({summary:h.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:c,summaryData:h}}}else s==="join"&&i.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:s},i){i.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),s&&(this._kickedBy=s),this._emitUpdate()}get isKicked(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="leave"}get isBanned(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){var e;return(e=this._kickDetails)==null?void 0:e.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();const s=this._storage.storeNames,i=await this._storage.readWriteTxn([s.roomState,s.archivedRoomSummary,s.roomMembers,s.timelineEvents,s.timelineFragments,s.timelineRelations,s.pendingEvents,s.inboundGroupSessions,s.groupSessionDecryptions,s.operations]);i.roomState.removeAllForRoom(this.id),i.archivedRoomSummary.remove(this.id),i.roomMembers.removeAllForRoom(this.id),i.timelineEvents.removeAllForRoom(this.id),i.timelineFragments.removeAllForRoom(this.id),i.timelineRelations.removeAllForRoom(this.id),i.pendingEvents.removeAllForRoom(this.id),i.inboundGroupSessions.removeAllForRoom(this.id),i.groupSessionDecryptions.removeAllForRoom(this.id),await i.operations.removeAllForScope(this.id),await i.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}}function Ha(n,e){var s,i;const t=Qs(n,(r,o)=>(o.type===F&&o.state_key===e&&o.sender!==o.state_key&&(r=o),r),null);if(t)return{membership:(s=t.content)==null?void 0:s.membership,reason:(i=t.content)==null?void 0:i.reason,sender:t.sender}}async function za(n,e,t){const s=await Promise.all(n.map(async i=>{const r=await e.profile(i,{log:t}).response();return new Ga(i,r.displayname,r.avatar_url)}));return s.sort((i,r)=>i.name.localeCompare(r.name)),s}class Ga{constructor(e,t,s){this.userId=e,this.displayName=t,this.avatarUrl=s}get name(){return this.displayName||this.userId}}class Ja{constructor(e){this.userId=e}get displayName(){}get name(){return this.userId}get avatarUrl(){}}function Qa(n){switch(n){case L.DirectMessage:case L.Private:return!0;case L.Public:return!1}}function Ya(n){switch(n){case L.DirectMessage:return"trusted_private_chat";case L.Private:return"private_chat";case L.Public:return"public_chat"}}class Xa extends vt{constructor(e,t,s,i,r,o){super();var a;if(this.id=e,this.options=t,this.updateCallback=s,this.mediaRepository=i,this.platform=r,this.profiles=[],this._isCancelled=!1,this.isEncrypted=t.isEncrypted===void 0?Qa(t.type):t.isEncrypted,t.name)this._calculatedName=t.name;else{const c={joinCount:1,inviteCount:((a=t.invites)==null?void 0:a.length)||0},h=(t.invites||[]).map(l=>new Ja(l));this._calculatedName=os(h,c,o)}}async create(e,t){try{let s;if(this.options.avatar){const{avatar:o}=this.options,a=new Ni({filename:o.name,blob:o.blob,platform:this.platform});await a.upload(e,()=>{},t),s={info:o.info},a.applyToContent("url",s)}const i={is_direct:this.options.type===L.DirectMessage,preset:Ya(this.options.type),initial_state:[]};this.options.name&&(i.name=this.options.name),this.options.topic&&(i.topic=this.options.topic),this.options.invites&&(i.invite=this.options.invites),this.options.alias&&(i.room_alias_name=this.options.alias),this.options.isFederationDisabled===!0&&(i.creation_content={"m.federate":!1}),this.isEncrypted&&i.initial_state.push(vn()),s&&i.initial_state.push({type:"m.room.avatar",state_key:"",content:s});const r=await e.createRoom(i,{log:t}).response();this._roomId=r.room_id}catch(s){this._error=s}this.emitChange()}async loadProfiles(e,t){try{if(!this.options.name&&this.options.invites){this.profiles=await za(this.options.invites,e,t);const s={joinCount:1,inviteCount:this.options.invites.length};this._calculatedName=os(this.profiles,s,t),this.emitChange()}}catch{}}emitChange(e){this.updateCallback(this,e),this.emit("change")}get avatarColorId(){var e,t,s;return(s=(t=(e=this.options.invites)==null?void 0:e[0])!=null?t:this._roomId)!=null?s:this.id}get avatarUrl(){var e,t;return(t=(e=this.profiles)==null?void 0:e[0])==null?void 0:t.avatarUrl}get avatarBlobUrl(){var e,t;return(t=(e=this.options.avatar)==null?void 0:e.blob)==null?void 0:t.url}get roomId(){return this._roomId}get name(){return this._calculatedName}get isBeingCreated(){return!0}get error(){return this._error}cancel(){this._isCancelled||(this.dispose(),this._isCancelled=!0,this.emitChange("isCancelled"))}get isCancelled(){return this._isCancelled}dispose(){this.options.avatar&&this.options.avatar.blob.dispose()}async adjustDirectMessageMapIfNeeded(e,t,s,i){if(!this.options.invites||this.options.type!==L.DirectMessage)return;const r=this.options.invites[0],o="m.direct";await i.wrap("set "+o,async a=>{try{const c=await t.readWriteTxn([t.storeNames.accountData]);let h;try{h=await c.accountData.get(o),h||(h={type:o,content:{}});const l=h.content;let d=l[r];d||(l[r]=d=[]),d.push(this._roomId),c.accountData.set(h),await c.complete()}catch(l){throw c.abort(),l}await s.setAccountData(e.id,o,h.content,{log:a}).response()}catch(c){a.catch(c)}})}}class Za extends vt{constructor({roomId:e,user:t,hsApi:s,mediaRepository:i,emitCollectionRemove:r,emitCollectionUpdate:o,platform:a}){super();this._roomId=e,this._user=t,this._hsApi=s,this._emitCollectionRemove=r,this._emitCollectionUpdate=o,this._mediaRepository=i,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}isDirectMessageForUserId(e){return this.isDirectMessage&&this._inviter.userId===e}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new E(e.inviter):null}async writeSync(e,t,s,i){var r;if(e==="invite"){i.set("id",this.id),i.set("add",!0);const o=(r=t.invite_state)==null?void 0:r.events;if(!Array.isArray(o))return null;const a=this._createSummaryData(o);let c;!a.name&&!a.canonicalAlias&&(c=await this._createHeroes(o,i));const h=this._getMyInvite(o);if(!h)return null;const l=this._getInviter(h,o),d=this._createData(o,h,l,a,c);return s.invites.set(d),{inviteData:d,inviter:l}}else return i.set("id",this.id),i.set("membership",e),s.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,s,i,r){const o=r?r.roomName:i.name,a=r?r.roomAvatarUrl:i.avatarUrl,c=(r==null?void 0:r.roomAvatarColorId)||this.id;return{roomId:this.id,isEncrypted:!!i.encryption,isDirectMessage:i.isDirectMessage,name:o,avatarUrl:a,avatarColorId:c,canonicalAlias:i.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:s==null?void 0:s.serialize()}}_createSummaryData(e){return e.reduce((t,s)=>Ys(t,s,this._user.id),new ie(null,this.id))}async _createHeroes(e,t){const s=e.filter(l=>l.type===F),i=s.filter(l=>l.state_key!==this._user.id),r=i.reduce((l,d)=>{const u=E.fromMemberEvent(this.id,d);return l.set(u.userId,new ri(u,null)),l},new Map),o=i.map(l=>l.state_key),a=new as(this.id),c=await a.calculateChanges(o,r,null),h=new ie(null,this.id);return h.joinCount=s.reduce((l,d)=>{var u;return l+(((u=d.content)==null?void 0:u.membership)==="join"?1:0)},0),h.inviteCount=s.reduce((l,d)=>{var u;return l+(((u=d.content)==null?void 0:u.membership)==="invite"?1:0)},0),a.applyChanges(c,h,t),a}_getMyInvite(e){return e.find(t=>t.type===F&&t.state_key===this._user.id)}_getInviter(e,t){const s=t.find(i=>i.type===F&&i.state_key===e.sender);if(s)return E.fromMemberEvent(this.id,s)}_getJoinRule(e){var s;const t=e.find(i=>i.type==="m.room.join_rules");return t?(s=t.content)==null?void 0:s.join_rule:null}}class Ce{constructor(e){this._description=e}static httpPusher(e,t,s,i){return new Ce({kind:"http",append:!0,data:Object.assign({},i,{url:e+"/_matrix/push/v1/notify"}),pushkey:s,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const s=Object.assign({},this._description,{kind:null});await e.setPusher(s,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}}function Fe(n,e){return cs(n,e,()=>[],(t,s)=>t.push(s))}function cs(n,e,t,s){return n.reduce((i,r)=>{const o=e(r);let a=i.get(o);return a||(a=t(),i.set(o,a)),s(a,r),i},new Map)}function Vi(n,e){return n.reduce((t,s)=>{const i=e(s);return t[i]?t[i]+=1:t[i]=1,t},{})}class ec{constructor({storage:e}){this._storage=e,this._olmDecryption=null,this._megolmDecryption=null}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){var t;return(t=this._olmDecryption)==null?void 0:t.obtainDecryptionLock(e)}async prepareSync(e,t,s,i){i.set("messageTypes",Vi(e,a=>a.type));const r=e.filter(a=>a.type==="m.room.encrypted");if(!this._olmDecryption){i.log("can't decrypt, encryption not enabled",i.level.Warn);return}const o=r.filter(a=>{var c;return((c=a.content)==null?void 0:c.algorithm)===qt});if(o.length){const a=await this._olmDecryption.decryptAll(o,t,s);i.set("decryptedTypes",Vi(a.results,h=>{var l;return(l=h.event)==null?void 0:l.type}));for(const h of a.errors)i.child("decrypt_error").catch(h);const c=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,i);return new tc(a,c)}}async writeSync(e,t){return e.olmDecryptChanges.write(t),(await Promise.all(e.newRoomKeys.map(i=>this._megolmDecryption.writeRoomKey(i,t)))).some(i=>!!i)}}class tc{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=Fe(t,s=>s.roomId)}}const st=K+"olmAccount",hs=K+"areDeviceKeysUploaded",Nt=K+"serverOTKCount";async function Pi(n,e,t,s,i){const r=n.pickle(e),o=await i.readWriteTxn([i.storeNames.session]);try{o.session.add(st,r),o.session.add(hs,t),o.session.add(Nt,s)}catch(a){throw o.abort(),a}await o.complete()}class Me{static async load({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:o,txn:a}){const c=await a.session.get(st);if(c){const h=new e.Account,l=await a.session.get(hs);h.unpickle(t,c);const d=await a.session.get(Nt);return new Me({pickleKey:t,hsApi:s,account:h,userId:i,deviceId:r,areDeviceKeysUploaded:l,serverOTKCount:d,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:s,hsApi:i,userId:r,olmWorker:o,storage:a}){const c=t.adoptUnpickledOlmAccount(),h=JSON.parse(c.one_time_keys()),d=Object.entries(h.curve25519).length,u=!0;return await Pi(c,s,u,d,a),new Me({pickleKey:s,hsApi:i,account:c,userId:r,deviceId:t.deviceId,areDeviceKeysUploaded:u,serverOTKCount:d,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:o,storage:a}){const c=new e.Account;o?await o.createAccountAndOTKs(c,c.max_number_of_one_time_keys()):(c.create(),c.generate_one_time_keys(c.max_number_of_one_time_keys()));const h=!1,l=0;return a&&await Pi(c,t,h,l,a),new Me({pickleKey:t,hsApi:s,account:c,userId:i,deviceId:r,areDeviceKeysUploaded:h,serverOTKCount:l,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:s,userId:i,deviceId:r,areDeviceKeysUploaded:o,serverOTKCount:a,olm:c,olmWorker:h}){this._olm=c,this._pickleKey=e,this._hsApi=t,this._account=s,this._userId=i,this._deviceId=r,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=h,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,s){var o;const i=JSON.parse(this._account.one_time_keys()),r=Object.entries(i.curve25519);if(r.length||!this._areDeviceKeysUploaded){const a={};if(!this._areDeviceKeysUploaded){s.set("identity",!0);const l=JSON.parse(this._account.identity_keys());a.device_keys=this._deviceKeysPayload(l)}r.length&&(s.set("otks",!0),a.one_time_keys=this._oneTimeKeysPayload(r));const c=t?this._deviceId:void 0,h=await this._hsApi.uploadKeys(c,a,{log:s}).response();this._serverOTKCount=(o=h==null?void 0:h.one_time_key_counts)==null?void 0:o.signed_curve25519,s.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,l=>{r.length&&(this._account.mark_keys_as_published(),l==null||l.set(st,this._account.pickle(this._pickleKey)),l==null||l.set(Nt,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,l==null||l.set(hs,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){const s=this._account.max_number_of_one_time_keys(),i=Math.floor(s/2);if(this._serverOTKCount<i){const r=JSON.parse(this._account.one_time_keys()),a=Object.entries(r.curve25519).length,c=i-a-this._serverOTKCount;return c>0&&await t.wrap("generate otks",h=>{h.set("max",s),h.set("server",this._serverOTKCount),h.set("unpublished",a),h.set("new",c),h.set("limit",i),this._account.generate_one_time_keys(c),this._updateSessionStorage(e,l=>{l.set(st,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){const s=new this._olm.Session;try{return s.create_inbound_from(this._account,e,t),s}catch(i){throw s.free(),i}}async createOutboundOlmSession(e,t){const s=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,s,e,t):s.create_outbound(this._account,e,t),s}catch(i){throw s.free(),i}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set(st,this._account.pickle(this._pickleKey))}writeSync(e,t,s){const i=e.signed_curve25519;if(Number.isSafeInteger(i)&&i!==this._serverOTKCount)return t.session.set(Nt,i),s.set("otkCount",i),i}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_deviceKeysPayload(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[qt,Y],keys:{}};for(const[s,i]of Object.entries(e))t.keys[`${s}:${this._deviceId}`]=i;return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[s,i]of e){const r={key:i};this.signObject(r),t[`signed_curve25519:${s}`]=r}return t}async _updateSessionStorage(e,t){if(e){const s=await e.readWriteTxn([e.storeNames.session]);try{await t(s.session)}catch(i){throw s.abort(),i}await s.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(Us.stringify(e)),e.signatures=t,s!==void 0&&(e.unsigned=s)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}class ls{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){var e;return(e=this._keyDescription)==null?void 0:e.passphrase}get algorithm(){var e;return(e=this._keyDescription)==null?void 0:e.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){const s=this._keyDescription;if(s.mac){const i=await sc(e.binaryKey,s.iv,t);return s.mac===i}else if(s.passphrase){const i=e.description._keyDescription;return i.passphrase?s.passphrase.algorithm===i.passphrase.algorithm&&s.passphrase.iterations===i.passphrase.iterations&&s.passphrase.salt===i.passphrase.salt:!1}}return!1}}class it{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new it(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}async function sc(n,e,t){const{crypto:s,encoding:i}=t,{utf8:r,base64:o}=i,{derive:a,aes:c,hmac:h}=s,l=o.decode(e),d=new Uint8Array(8),u="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",m=r.encode(""),_=await a.hkdf(n,d,m,"SHA-256",512),p=_.slice(0,32),b=_.slice(32),R=await c.encryptCTR({key:p,iv:l,data:r.encode(u)}),G=await h.compute(b,R,"SHA-256");return o.encode(G)}const ic=5e5,rc=256;async function nc(n,e,t){const{passphraseParams:s}=n;if(!s)throw new Error("not a passphrase key");if(s.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${s.algorithm}`);const{utf8:i}=t.encoding,r=await t.crypto.derive.pbkdf2(i.encode(e),s.iterations||ic,i.encode(s.salt),"SHA-512",s.bits||rc);return new it(n,r)}const rt=[139,1];function oc(n,e,t,s){const i=s.encoding.base58.decode(e.replace(/ /g,""));let r=0;for(const a of i)r^=a;if(r!==0)throw new Error("Incorrect parity");for(let a=0;a<rt.length;++a)if(i[a]!==rt[a])throw new Error("Incorrect prefix");if(i.length!==rt.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(i.slice(rt.length,rt.length+t.PRIVATE_KEY_LENGTH));return new it(n,o)}const ds=`${K}ssssKey`,Ui=`${K}keyBackupVersion`;var $e;(function(n){n[n.RecoveryKey=0]="RecoveryKey",n[n.Passphrase=1]="Passphrase"})($e||($e={}));async function Di(n){var r;const e=await n.readTxn([n.storeNames.accountData]),t=await e.accountData.get("m.secret_storage.default_key"),s=(r=t==null?void 0:t.content)==null?void 0:r.key;if(!s)return;const i=await e.accountData.get(`m.secret_storage.key.${s}`);if(!!i)return new ls(s,i.content)}async function ac(n,e,t){const s=await t.session.get(Ui);return t.session.set(Ui,e),t.session.set(ds,{id:n.id,binaryKey:n.binaryKey}),s}async function cc(n){const e=await n.session.get(ds);if(!e)return;const t=await n.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new it(new ls(e.id,t.content),e.binaryKey)}async function hc(n){n.session.remove(ds)}async function lc(n,e,t,s,i){const r=await Di(t);if(!r)throw new Error("Could not find a default secret storage key in account data");return await Bi(n,e,r,s,i)}async function Bi(n,e,t,s,i){let r;if(n===1)r=await nc(t,e,s);else if(n===0)r=oc(t,e,i,s);else throw new Error(`Invalid type: ${n}`);return r}async function dc(n,e,t){const s=await Di(e);if(await(s==null?void 0:s.isCompatible(n,t)))return n.withDescription(s)}const Li="org.matrix.msc2697.v1.olm.libolm_pickle";async function uc(n,e,t,s){try{const i=await n.getDehydratedDevice({log:s}).response();if(i.device_data.algorithm===Li)return new _c(i,e,t)}catch(i){i.name!=="HomeServerError"&&(s.error=i);return}}async function mc(n,e,t,s,i){var a;const o=(await e.createDehydratedDevice({device_data:{algorithm:Li,account:n.pickleWithKey(t.binaryKey.slice()),passphrase:((a=t.description)==null?void 0:a.passphraseParams)||{}},initial_device_display_name:s}).response()).device_id;return n.setDeviceId(o),await n.uploadKeys(void 0,!0,i),o}class _c{constructor(e,t,s){this._dehydratedDevice=e,this._olm=t,this._platform=s}async decrypt(e,t){const s=new ls("dehydrated_device",this._dehydratedDevice.device_data.passphrase),i=await Bi(e,t,s,this._platform,this._olm),r=new this._olm.Account;try{const o=this._dehydratedDevice.device_data.account;return r.unpickle(i.binaryKey.slice(),o),new pc(this._dehydratedDevice,r,i)}catch(o){if(r.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}}class pc{constructor(e,t,s){this._dehydratedDevice=e,this._account=t,this._key=s}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){var e;(e=this._account)==null||e.free(),this._account=void 0}}class gc{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class fc{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function Ki(n,e,t,s){return{session:n.pickle(s),sessionId:n.session_id(),senderKey:e,lastUsed:t}}class Vt{constructor(e,t,s,i=!1){this.data=e,this._olm=s,this._pickleKey=t,this.isNew=i,this.isModified=i}static create(e,t,s,i,r){const o=Ki(t,e,r,i);return new Vt(o,i,s,!0)}get id(){return this.data.sessionId}load(){const e=new this._olm.Session;return e.unpickle(this._pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this._pickleKey),this.isModified=!0}}class Oi{constructor(e,t,s){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=s,this._device=null,this._roomTracked=!0}setDevice(e){this._device=e}setRoomNotTrackedYet(){this._roomTracked=!1}get isVerified(){return this._device?this._device.ed25519Key===this.claimedEd25519Key:!1}get isUnverified(){return this._device?!this.isVerified:!this.isVerificationUnknown}get isVerificationUnknown(){return!this._device&&!this._roomTracked}}const Fi=4;function us(n){return n.type===0}function $i(n){n.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}class yc{constructor({account:e,pickleKey:t,now:s,ownUserId:i,storage:r,olm:o,senderKeyLock:a}){this._account=e,this._pickleKey=t,this._now=s,this._ownUserId=i,this._storage=r,this._olm=o,this._senderKeyLock=a}async obtainDecryptionLock(e){var i;const t=new Set;for(const r of e){const o=(i=r.content)==null?void 0:i.sender_key;o&&t.add(o)}const s=await Promise.all(Array.from(t).map(r=>this._senderKeyLock.takeLock(r)));return new fc(s)}async decryptAll(e,t,s){try{const i=Fe(e,l=>{var d;return(d=l.content)==null?void 0:d.sender_key}),r=this._now(),o=await Promise.all(Array.from(i.entries()).map(([l,d])=>this._decryptAllForSenderKey(l,d,r,s))),a=o.reduce((l,d)=>l.concat(d.results),[]),c=o.reduce((l,d)=>l.concat(d.errors),[]),h=o.map(l=>l.senderKeyDecryption);return new vc(h,a,c,this._account,t)}catch(i){throw t.release(),i}}async _decryptAllForSenderKey(e,t,s,i){const r=await this._getSessions(e,i),o=new wc(e,r,this._olm,s),a=[],c=[];for(const h of t)try{const l=this._decryptForSenderKey(o,h,s);a.push(l)}catch(l){c.push(l)}return{results:a,errors:c,senderKeyDecryption:o}}_decryptForSenderKey(e,t,s){const i=e.senderKey,r=this._getMessageAndValidateEvent(t);let o;try{o=e.decrypt(r)}catch(a){throw new x("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:i,error:a.message})}if(typeof o!="string"&&us(r)){let a;try{a=this._createSessionAndDecrypt(i,r,s)}catch(c){throw new x(`Could not create inbound olm session: ${c.message}`,t,{senderKey:i,error:c})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(c){throw new x("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:c})}return this._validatePayload(a,t),new Oi(a,i,a.keys.ed25519)}else throw new x("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,s){let i;const r=this._account.createInboundOlmSession(e,t.body);try{i=r.decrypt(t.type,t.body);const o=Vt.create(e,r,this._olm,this._pickleKey,s);return o.unload(r),{session:o,plaintext:i}}catch(o){throw r.free(),o}}_getMessageAndValidateEvent(e){var i;const t=(i=e.content)==null?void 0:i.ciphertext;if(!t)throw new x("OLM_MISSING_CIPHERTEXT",e);const s=t==null?void 0:t[this._account.identityKeys.curve25519];if(!s)throw new x("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return s}async _getSessions(e,t){const i=(await t.olmSessions.getAll(e)).map(r=>new Vt(r,this._pickleKey,this._olm));return $i(i),i}_validatePayload(e,t){var s,i,r;if(e.sender!==t.sender)throw new x("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this._ownUserId)throw new x("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(((s=e.recipient_keys)==null?void 0:s.ed25519)!==this._account.identityKeys.ed25519)throw new x("OLM_BAD_RECIPIENT_KEY",t,{key:(i=e.recipient_keys)==null?void 0:i.ed25519});if(!e.type)throw new x("missing type on payload",t,{payload:e});if(typeof((r=e.keys)==null?void 0:r.ed25519)!="string")throw new x("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class wc{constructor(e,t,s,i){this.senderKey=e,this.sessions=t,this._olm=s,this._timestamp=i}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const s=this._decryptWithSession(t,e);if(typeof s=="string")return $i(this.sessions),s}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}_decryptWithSession(e,t){const s=e.load();try{if(us(t)&&!s.matches_inbound(t.body))return;try{const i=s.decrypt(t.type,t.body);return e.save(s),e.lastUsed=this._timestamp,i}catch(i){if(us(t))throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${i.message}`);return}}finally{e.unload(s)}}}class vc{constructor(e,t,s,i,r){this._senderKeyDecryptions=e,this._account=i,this.results=t,this.errors=s,this._lock=r}get hasNewSessions(){return this._senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(const t of this._senderKeyDecryptions){for(const s of t.getModifiedSessions())if(e.olmSessions.set(s.data),s.isNew){const i=s.load();try{this._account.writeRemoveOneTimeKey(i,e)}finally{s.unload(i)}}if(t.sessions.length>Fi){const{senderKey:s,sessions:i}=t;for(let r=i.length-1;r>=Fi;r-=1){const o=i[r];e.olmSessions.remove(s,o.id)}}}}finally{this._lock.release()}}}function bc(n){return n.reduce((e,t)=>!e||t<e?t:e,null)}const qi="signed_curve25519",ji=20;class Sc{constructor({account:e,olm:t,olmUtil:s,ownUserId:i,storage:r,now:o,pickleKey:a,senderKeyLock:c}){this._account=e,this._olm=t,this._olmUtil=s,this._ownUserId=i,this._storage=r,this._now=o,this._pickleKey=a,this._senderKeyLock=c}async encrypt(e,t,s,i,r){let o=[];for(let a=0;a<s.length;a+=ji){const c=s.slice(a,a+ji),h=await this._encryptForMaxDevices(e,t,c,i,r);o=o.concat(h)}return o}async _encryptForMaxDevices(e,t,s,i,r){const o=await Promise.all(s.map(a=>this._senderKeyLock.takeLock(a.curve25519Key)));try{const{devicesWithoutSession:a,existingEncryptionTargets:c}=await this._findExistingSessions(s),h=this._now();let l=[];try{if(a.length){const m=await r.wrap("create sessions",_=>this._createNewSessions(a,i,h,_));l=l.concat(m)}await this._loadSessions(c),l=l.concat(c);const d={l:"encrypt",targets:l.length},u=r.wrap(d,()=>l.map(m=>{const _=this._encryptForDevice(e,t,m);return new Ic(_,m.device)}));return await this._storeSessions(l,h),u}finally{for(const d of l)d.dispose()}}finally{for(const a of o)a.release()}}async _findExistingSessions(e){const t=await this._storage.readTxn([this._storage.storeNames.olmSessions]),s=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(o.curve25519Key))),i=e.filter((o,a)=>{const c=s[a];return!(c==null?void 0:c.length)}),r=e.map((o,a)=>{const c=s[a];if((c==null?void 0:c.length)>0){const h=bc(c);return nt.fromSessionId(o,h)}}).filter(o=>!!o);return{devicesWithoutSession:i,existingEncryptionTargets:r}}_encryptForDevice(e,t,s){const{session:i,device:r}=s,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,r)),a=i.encrypt(o);return{algorithm:qt,sender_key:this._account.identityKeys.curve25519,ciphertext:{[r.curve25519Key]:a}}}_buildPlainTextMessageForDevice(e,t,s){return{keys:{ed25519:this._account.identityKeys.ed25519},recipient_keys:{ed25519:s.ed25519Key},recipient:s.userId,sender:this._ownUserId,content:t,type:e}}async _createNewSessions(e,t,s,i){const r=await i.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(const o of r){const{device:a,oneTimeKey:c}=o;o.session=await this._account.createOutboundOlmSession(a.curve25519Key,c)}await this._storeSessions(r,s)}catch(o){for(const a of r)a.dispose();throw o}return r}async _claimOneTimeKeys(e,t,s){const i=cs(t,c=>c.userId,()=>new Map,(c,h)=>c.set(h.deviceId,h)),r=Array.from(i.entries()).reduce((c,[h,l])=>(c[h]=Array.from(l.values()).reduce((d,u)=>(d[u.deviceId]=qi,d),{}),c),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:r},{log:s}).response();Object.keys(o.failures).length&&s.log({l:"failures",servers:Object.keys(o.failures)},s.level.Warn);const a=o==null?void 0:o.one_time_keys;return this._verifyAndCreateOTKTargets(a,i,s)}_verifyAndCreateOTKTargets(e,t,s){var r;const i=[];for(const[o,a]of Object.entries(e))for(const[c,h]of Object.entries(a)){const[l,d]=Object.entries(h)[0],[u]=l.split(":");if(u===qi){const m=(r=t.get(o))==null?void 0:r.get(c);if(m&&Js(this._olmUtil,o,c,m.ed25519Key,d,s)){const p=nt.fromOTK(m,d.key);i.push(p)}}}return i}async _loadSessions(e){const t=await this._storage.readTxn([this._storage.storeNames.olmSessions]);let s=!1;try{await Promise.all(e.map(async i=>{const r=await t.olmSessions.get(i.device.curve25519Key,i.sessionId);if(r&&!s){const o=new this._olm.Session;o.unpickle(this._pickleKey,r.session),i.session=o}}))}catch(i){s=!0;for(const r of e)r.dispose();throw i}}async _storeSessions(e,t){const s=await this._storage.readWriteTxn([this._storage.storeNames.olmSessions]);try{for(const i of e){const r=Ki(i.session,i.device.curve25519Key,t,this._pickleKey);s.olmSessions.set(r)}}catch(i){throw s.abort(),i}await s.complete()}}class nt{constructor(e,t,s){this.device=e,this.oneTimeKey=t,this.sessionId=s,this.session=null}static fromOTK(e,t){return new nt(e,t,null)}static fromSessionId(e,t){return new nt(e,null,t)}dispose(){this.session&&this.session.free()}}class Ic{constructor(e,t){this.content=e,this.device=t}}class Ec{constructor(e,t,s,i){this._roomId=e,this._results=t,this._errors=s,this._replayEntries=i}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(s){this._errors.set(t.eventId,s)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,s){const{messageIndex:i,sessionId:r,eventId:o,timestamp:a}=t,c=await s.groupSessionDecryptions.get(e,r,i);if(c&&c.eventId!==o){const l=c.timestamp<a?o:c.eventId;throw this._results.delete(o),new x("MEGOLM_REPLAYED_INDEX",event,{messageIndex:i,badEventId:l,otherEventId:c.eventId})}c||s.groupSessionDecryptions.set(e,r,i,{eventId:o,timestamp:a})}}function ms(n,e){if(n)for(const[t,s]of n.entries())e.set(t,s)}class kc{constructor(e,t,s){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=s}async decrypt(){try{const e=this._initialErrors,t=new Map,s=[];return await Promise.all(this._sessionDecryptions.map(async i=>{const r=await i.decryptAll();ms(r.errors,e),ms(r.results,t),s.push(...r.replayEntries)})),new Ec(this._roomId,t,e,s)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class Rc{constructor(e,t,s){this.sessionId=e,this.messageIndex=t,this.event=s}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class Cc{constructor(e,t,s,i){this.key=e,this.events=t,this.olmWorker=s,this.keyLoader=i,this.decryptionRequests=s?[]:void 0}async decryptAll(){const e=[],t=new Map;let s;return await this.keyLoader.useKey(this.key,async i=>{for(const r of this.events)try{const o=r.content.ciphertext;let a;if(this.olmWorker){const d=this.olmWorker.megolmDecrypt(i,o);this.decryptionRequests.push(d),a=await d.response()}else a=i.decrypt(o);const{plaintext:c}=a;let h;try{h=JSON.parse(c)}catch(d){throw new x("PLAINTEXT_NOT_JSON",r,{plaintext:c,err:d})}if(h.room_id!==this.key.roomId)throw new x("MEGOLM_WRONG_ROOM",r,{encryptedRoomId:h.room_id,eventRoomId:this.key.roomId});e.push(new Rc(this.key.sessionId,a.message_index,r));const l=new Oi(h,this.key.senderKey,this.key.claimedEd25519Key);t.set(r.event_id,l)}catch(o){if(o.name==="AbortError")return;s||(s=new Map),s.set(r.event_id,o)}}),{results:t,errors:s,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function _s(n){var e;return(e=n.content)==null?void 0:e.sender_key}function ps(n){var e;return(e=n.content)==null?void 0:e.session_id}function Mc(n){var e;return(e=n.content)==null?void 0:e.ciphertext}function Tc(n){return typeof _s(n)=="string"&&typeof ps(n)=="string"&&typeof Mc(n)=="string"}class Ac{constructor(){this.events=[]}get senderKey(){return _s(this.events[0])}get sessionId(){return ps(this.events[0])}}function gs(n){return cs(n,e=>`${_s(e)}|${ps(e)}`,()=>new Ac,(e,t)=>e.events.push(t))}class Wi{isForSession(e,t,s){return this.roomId===e&&this.senderKey===t&&this.sessionId===s}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function Hi(n,e){return n.first_known_index()<e.first_known_index()}class fs extends Wi{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let s;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(r,o)=>{s=r.pickle(o)},t),this.isBetter===!1)return!1;s||(s=await e.useKey(this,(r,o)=>r.pickle(o)));const i={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:s,backup:this.backupStatus,source:this.keySource,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(i),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,s){if(this.isBetter!==void 0)return this.isBetter;let i=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!i){const r=await Ji(this.roomId,this.senderKey,this.sessionId,s);r&&(r.hasSession?i=r:r.eventIds&&(this._eventIds=r.eventIds))}if(i){const r=i;await e.useKey(this,async o=>{await e.useKey(r,(a,c)=>{this.isBetter=Hi(o,a),r.isBetter=!this.isBetter,this.isBetter&&t&&t(o,c)})})}else this.isBetter=!0;return this.isBetter}get backupStatus(){return Ze.NotBackedUp}}class xc extends fs{constructor(e){super();this._decryptionResult=e}get roomId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_key}get serializationType(){return"create"}get keySource(){return Be.DeviceMessage}loadInto(e){e.create(this.serializationKey)}}class Nc extends fs{constructor(e,t,s){super();this._roomId=e,this.outboundSession=t,this.identityKeys=s,this.isBetter=!0,this._sessionKey=this.outboundSession.session_key()}get roomId(){return this._roomId}get senderKey(){return this.identityKeys.curve25519}get sessionId(){return this.outboundSession.session_id()}get claimedEd25519Key(){return this.identityKeys.ed25519}get serializationKey(){return this._sessionKey}get serializationType(){return"create"}get keySource(){return Be.Outbound}loadInto(e){e.create(this.serializationKey)}}class Vc extends fs{constructor(e,t,s){super();this._roomId=e,this._sessionId=t,this._backupInfo=s}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){var e;return(e=this._backupInfo.sender_claimed_keys)==null?void 0:e.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}get keySource(){return Be.Backup}loadInto(e){e.import_session(this.serializationKey)}get backupStatus(){return Ze.BackedUp}}class zi extends Wi{constructor(e){super();this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function Pc(n){var s;const e=(s=n.event.content)==null?void 0:s.session_key,t=new xc(n);if(typeof t.roomId=="string"&&typeof t.sessionId=="string"&&typeof t.senderKey=="string"&&typeof e=="string")return t}function Gi(n,e,t){var o;const s=t.session_key,i=t.sender_key,r=(o=t.sender_claimed_keys)==null?void 0:o.ed25519;if(typeof n=="string"&&typeof e=="string"&&typeof i=="string"&&typeof s=="string"&&typeof r=="string")return new Vc(n,e,t)}async function Ji(n,e,t,s){const i=await s.inboundGroupSessions.get(n,e,t);if(i)return new zi(i)}class Uc{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,s,i,r){let o=await r.inboundGroupSessions.get(e,t,s);if(!(o==null?void 0:o.session)){if(o){const a=new Set(o.eventIds);for(const c of i)a.add(c);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:s,eventIds:i};r.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);if(r&&!r.session)return r.eventIds}async hasSession(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);return typeof(r==null?void 0:r.session)=="string"}async prepareDecryptAll(e,t,s,i){const r=new Map,o=[];for(const h of t)Tc(h)?o.push(h):r.set(h.event_id,new x("MEGOLM_INVALID_EVENT",h));const a=gs(o),c=[];return await Promise.all(Array.from(a.values()).map(async h=>{const l=await this.getRoomKey(e,h.senderKey,h.sessionId,s,i);if(l)c.push(new Cc(l,h.events,this.olmWorker,this.keyLoader));else for(const d of h.events)r.set(d.event_id,new x("MEGOLM_NO_SESSION",d))})),new kc(e,c,r)}async getRoomKey(e,t,s,i,r){if(i){const c=i.find(h=>h.isForSession(e,t,s));if(c&&await c.checkBetterThanKeyInStorage(this.keyLoader,r))return c}const o=this.keyLoader.getCachedKey(e,t,s);if(o)return o;const a=await Ji(e,t,s,r);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){var i,r;const s=[];for(const o of e)((i=o.event)==null?void 0:i.type)!=="m.room_key"||((r=o.event.content)==null?void 0:r.algorithm)!==Y||t.wrap("room_key",a=>{const c=Pc(o);c?(a.set("roomId",c.roomId),a.set("id",c.sessionId),s.push(c)):(a.logLevel=a.level.Warn,a.set("invalid",!0))},t.level.Detail);return s}roomKeyFromBackup(e,t,s){return Gi(e,t,s)}dispose(){this.keyLoader.dispose()}}class Dc extends ki{constructor(e,t,s){super(s);this.pickleKey=t,this.olm=e}getCachedKey(e,t,s){const i=this.findCachedKeyIndex(e,t,s);if(i!==-1)return this._getByIndexAndMoveUp(i).key}async useKey(e,t){const s=await this.allocateOperation(e);try{return await t(s.session,this.pickleKey)}finally{this.releaseOperation(s)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){const s=this._getByIndexAndMoveUp(t);return s.isForKey(e)?(s.refCount+=1,s):(s.refCount=1,s.key=e,e.loadInto(s.session,this.pickleKey),s)}else{const s=new this.olm.InboundGroupSession;e.loadInto(s,this.pickleKey);const i=new Bc(e,s);return this._set(i),i}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,s){return this._entries.reduce((i,r,o,a)=>{const c=i===-1?void 0:a[i];return r.isBest===!0&&r.isForSameSession(e,t,s)&&(!c||r.isBetter(c))?o:i},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,s,i,r)=>{const o=t===-1?void 0:r[t];return s.refCount===0&&s.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!s.isBetter(o))?i:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}}class Bc{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,s){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===s}isBetter(e){return Hi(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}const Lc="m.megolm_backup.v1.curve25519-aes-sha2";class ys{constructor(e,t){this.encryption=e,this.decryption=t}static fromAuthData(e,t,s){const i=e.public_key,r=new s.PkDecryption,o=new s.PkEncryption;try{const a=r.init_with_private_key(t);if(a!==i)throw new Error(`Bad backup key, public key does not match. Calculated ${a} but expected ${i}`);o.set_recipient_key(a)}catch(a){throw r.free(),a}return new ys(o,r)}decryptRoomKey(e){const t=this.decryption.decrypt(e.ephemeral,e.mac,e.ciphertext);return JSON.parse(t)}encryptRoomKey(e,t){const s={algorithm:Y,sender_key:e.senderKey,sender_claimed_keys:{ed25519:e.claimedEd25519Key},forwarding_curve25519_key_chain:[],session_key:t};return this.encryption.encrypt(JSON.stringify(s))}dispose(){var e,t;(e=this.decryption)==null||e.free(),this.decryption=void 0,(t=this.encryption)==null||t.free(),this.encryption=void 0}}const Kc=200;class ws{constructor(e,t,s,i,r,o,a=1e4){this.backupInfo=e,this.crypto=t,this.hsApi=s,this.keyLoader=i,this.storage=r,this.platform=o,this.maxDelay=a,this.operationInProgress=new Q(void 0),this._stopped=!1,this._needsNewKey=!1,this._hasBackedUpAllKeys=!1}get hasStopped(){return this._stopped}get error(){return this._error}get version(){return this.backupInfo.version}get needsNewKey(){return this._needsNewKey}get hasBackedUpAllKeys(){return this._hasBackedUpAllKeys}async getRoomKey(e,t,s){const i=await this.hsApi.roomKeyForRoomAndSession(this.backupInfo.version,e,t,{log:s}).response();if(!i.session_data)return;const r=this.crypto.decryptRoomKey(i.session_data);if((r==null?void 0:r.algorithm)===Y)return Gi(e,t,r);(r==null?void 0:r.algorithm)&&s.set("unknown algorithm",r.algorithm)}markAllForBackup(e){return e.inboundGroupSessions.markAllAsNotBackedUp()}flush(e){this.operationInProgress.get()||e.wrapDetached("flush key backup",async t=>{if(this._needsNewKey){t.set("needsNewKey",this._needsNewKey);return}this._stopped=!1,this._error=void 0,this._hasBackedUpAllKeys=!1;const s=this._runFlushOperation(t);this.operationInProgress.set(s);try{await s.result,this._hasBackedUpAllKeys=!0}catch(i){this._stopped=!0,i.name==="HomeServerError"&&(i.errcode==="M_WRONG_ROOM_KEYS_VERSION"||i.errcode==="M_NOT_FOUND")?(t.set("wrong_version",!0),this._needsNewKey=!0):(i.name!=="AbortError"||i.name==="StorageError"&&i.errcode==="AbortError")&&(this._error=i),t.catch(i)}this.operationInProgress.set(void 0)})}_runFlushOperation(e){return new Ls(async(t,s)=>{let i=0,r=0;for(;;){const o=this.platform.random()*this.maxDelay,a=this.platform.clock.createTimeout(o);t(a),await a.elapsed();const c=await this.storage.readTxn([I.inboundGroupSessions]);t(c),i=r+await c.inboundGroupSessions.countNonBackedUpSessions(),s(new Qi(i,r));const h=(await c.inboundGroupSessions.getFirstNonBackedUpSessions(Kc)).map(u=>new zi(u));if(h.length===0){e.set("total",i);return}const l=await this.encodeKeysForBackup(h),d=this.hsApi.uploadRoomKeysToBackup(this.backupInfo.version,l,{log:e});t(d),await d.response(),await this.markKeysAsBackedUp(h,t),r+=h.length,s(new Qi(i,r))}})}async encodeKeysForBackup(e){const t={rooms:{}},s=t.rooms;for(const i of e){let r=s[i.roomId];r||(r=s[i.roomId]={sessions:{}}),r.sessions[i.sessionId]=await this.encodeRoomKey(i)}return t}async markKeysAsBackedUp(e,t){const s=await this.storage.readWriteTxn([I.inboundGroupSessions]);t(s);try{await Promise.all(e.map(i=>s.inboundGroupSessions.markAsBackedUp(i.roomId,i.senderKey,i.sessionId)))}catch(i){throw s.abort(),i}await s.complete()}async encodeRoomKey(e){return await this.keyLoader.useKey(e,t=>{const s=t.first_known_index(),i=t.export_session(s);return{first_message_index:s,forwarded_count:0,is_verified:!1,session_data:this.crypto.encryptRoomKey(e,i)}})}dispose(){this.crypto.dispose()}static async fromSecretStorage(e,t,s,i,r,o,a){const c=await s.readSecret("m.megolm_backup.v1",a);if(c){const h=new Uint8Array(e.encoding.base64.decode(c)),l=await i.roomKeysVersion().response();if(l.algorithm===Lc){const d=ys.fromAuthData(l.auth_data,h,t);return new ws(l,d,i,r,o,e)}else throw new Error(`Unknown backup algorithm: ${l.algorithm}`)}}}class Qi{constructor(e,t){this.total=e,this.finished=t}}class Oc{constructor({pickleKey:e,olm:t,account:s,keyLoader:i,storage:r,now:o,ownDeviceId:a}){this._pickleKey=e,this._olm=t,this._account=s,this._keyLoader=i,this._storage=r,this._now=o,this._ownDeviceId=a}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let s=await t.outboundGroupSessions.get(e);if(s){const i=new this._olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,s.session),this._createRoomKeyMessage(i,e)}finally{i.free()}}}createWithheldMessage(e,t,s){return{algorithm:e.algorithm,code:t,reason:s,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let s=new this._olm.OutboundGroupSession;try{const i=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let r;try{let o=await i.outboundGroupSessions.get(e);r=await this._readOrCreateSession(s,o,e,t,i),r&&this._writeSession(this._now(),s,e,i)}catch(o){throw i.abort(),o}return await i.complete(),r}finally{s.free()}}async _readOrCreateSession(e,t,s,i,r){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,i)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const o=this._createRoomKeyMessage(e,s);return await new Nc(s,e,this._account.identityKeys).write(this._keyLoader,r),o}}_writeSession(e,t,s,i){i.outboundGroupSessions.set({roomId:s,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,s,i){let r=new this._olm.OutboundGroupSession;try{const o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let a,c;try{let h=await o.outboundGroupSessions.get(e);a=await this._readOrCreateSession(r,h,e,i,o),c=this._encryptContent(e,r,t,s);const l=a?this._now():h.createdAt;this._writeSession(l,r,e,o)}catch(h){throw o.abort(),h}return await o.complete(),new Fc(c,a)}finally{r&&r.free()}}_needsToRotate(e,t,s){let i=6048e5;Number.isSafeInteger(s==null?void 0:s.rotation_period_ms)&&(i=s==null?void 0:s.rotation_period_ms);let r=100;if(Number.isSafeInteger(s==null?void 0:s.rotation_period_msgs)&&(r=s==null?void 0:s.rotation_period_msgs),this._now()>t+i||e.message_index()>=r)return!0}_encryptContent(e,t,s,i){const r=JSON.stringify({room_id:e,type:s,content:i}),o=t.encrypt(r);return{algorithm:Y,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:Y,chain_index:e.message_index()}}}class Fc{constructor(e,t){this.content=e,this.roomKeyMessage=t}}const Yi="m.room.encrypted",$c=60*1e3;class qc{constructor({room:e,deviceTracker:t,olmEncryption:s,megolmEncryption:i,megolmDecryption:r,encryptionParams:o,storage:a,keyBackup:c,notifyMissingMegolmSession:h,clock:l}){this._room=e,this._deviceTracker=t,this._olmEncryption=s,this._megolmEncryption=i,this._megolmDecryption=r,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._keyBackup=c,this._notifyMissingMegolmSession=h,this._clock=l,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._disposed=!1}enableKeyBackup(e){this._keyBackup&&!!e||(this._keyBackup=e)}async restoreMissingSessionsFromBackup(e,t){const s=e.filter(l=>l.isEncrypted&&!l.isDecrypted&&l.event).map(l=>l.event),i=gs(s),r=Array.from(i.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(r.map(async l=>this._megolmDecryption.hasSession(this._room.id,l.senderKey,l.sessionId,o))),c=r.filter((l,d)=>!a[d]);if(c.length)for(var h=c.length-1;h>=0;h--){const l=c[h];await t.wrap("session",d=>this._requestMissingSessionFromBackup(l.senderKey,l.sessionId,d))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeMemberChanges(e,t,s){let i=!1;const r=Array.from(e.values());return r.some(o=>o.hasLeft)&&(s.log({l:"discardOutboundSession",leftUsers:r.filter(o=>o.hasLeft).map(o=>o.userId)}),this._megolmEncryption.discardOutboundSession(this._room.id,t)),r.some(o=>o.hasJoined)&&(i=await this._addShareRoomKeyOperationForNewMembers(r,t,s)),await this._deviceTracker.writeMemberChanges(this._room,e,t),i}async prepareDecryptAll(e,t,s,i){var c,h,l;const r=new Map,o=[];for(const d of e)d.redacted_because||((c=d.unsigned)==null?void 0:c.redacted_because)||(((h=d.content)==null?void 0:h.algorithm)!==Y&&r.set(d.event_id,new Error("Unsupported algorithm: "+((l=d.content)==null?void 0:l.algorithm))),o.push(d));const a=await this._megolmDecryption.prepareDecryptAll(this._room.id,o,t,i);return new jc(a,r,s,this,e)}async _processDecryptionResults(e,t,s,i,r,o){const a=e.filter(h=>{const l=s.get(h.event_id);return(l==null?void 0:l.code)==="MEGOLM_NO_SESSION"});if(!a.length)return;const c=gs(a);i===Ee.Sync&&await Promise.all(Array.from(c.values()).map(async h=>{const l=h.events.map(d=>d.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,h.senderKey,h.sessionId,l,r)})),!!this._keyBackup&&o.wrapDetached("check key backup",async h=>{if(h.set("source",i),h.set("events",a.length),h.set("sessions",c.size),i===Ee.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const l=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(c).map(async([d,u])=>{await this._megolmDecryption.hasSession(this._room.id,u.senderKey,u.sessionId,l)&&c.delete(d)}))}await Promise.all(Array.from(c.values()).map(l=>h.wrap("session",d=>this._requestMissingSessionFromBackup(l.senderKey,l.sessionId,d))))})}async _verifyDecryptionResult(e,t){let s=this._senderDeviceCache.get(e.senderCurve25519Key);s||(s=await this._deviceTracker.getDeviceByCurve25519Key(e.senderCurve25519Key,t),this._senderDeviceCache.set(e.senderCurve25519Key,s)),s?e.setDevice(s):this._room.isTrackingMembers||e.setRoomNotTrackedYet()}async _requestMissingSessionFromBackup(e,t,s){if(!this._keyBackup){s.set("enabled",!1),this._notifyMissingMegolmSession();return}s.set("id",t),s.set("senderKey",e);try{const i=await this._keyBackup.getRoomKey(this._room.id,t,s);if(i){if(i.senderKey!==e){s.set("wrong_sender_key",i.senderKey),s.logLevel=s.level.Warn;return}let r=!1,o;const a=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{r=await this._megolmDecryption.writeRoomKey(i,a),s.set("isBetter",r),r&&(o=i.eventIds)}catch(c){throw a.abort(),c}await a.complete(),r&&await s.wrap("retryDecryption",c=>this._room.notifyRoomKey(i,o||[],c))}}catch(i){i.name==="HomeServerError"&&i.errcode==="M_NOT_FOUND"?(s.error=i,s.logLevel=s.level.Error):s.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){var s;if(!(((s=this._lastKeyPreShareTime)==null?void 0:s.measure())<$c)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{var r;const i=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);i&&((r=this._keyBackup)==null||r.flush(t),await t.wrap("share key",o=>this._shareNewRoomKey(i,e,o)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,s,i){var o;this._keySharePromise&&(i.set("waitForRunningKeyShare",!0),await this._keySharePromise);const r=await i.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return r.roomKeyMessage&&((o=this._keyBackup)==null||o.flush(i),await i.wrap("share key",a=>this._shareNewRoomKey(r.roomKeyMessage,s,a))),{type:Yi,content:r.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,s){let i=await this._storage.readWriteTxn([this._storage.storeNames.operations]),r;try{r=this._writeRoomKeyShareOperation(e,null,i)}catch(o){throw i.abort(),o}await this._processShareRoomKeyOperation(r,t,s)}async _addShareRoomKeyOperationForNewMembers(e,t,s){const i=e.filter(o=>o.hasJoined).map(o=>o.userId),r=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return r?(s.log({l:"share key for new members",userIds:i,id:r.session_id,chain_index:r.chain_index}),this._writeRoomKeyShareOperation(r,i,t),!0):!1}async flushPendingRoomKeyShares(e,t,s){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(const i of t)i.type==="share_room_key"&&await s.wrap("operation",r=>this._processShareRoomKeyOperation(i,e,r))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,s){const r={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return s.operations.add(r),r}async _processShareRoomKeyOperation(e,t,s){s.set("id",e.id),await this._deviceTracker.trackRoom(this._room,s);let i;if(e.userIds===null){i=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,s);const a=Array.from(i.reduce((c,h)=>c.add(h.userId),new Set));e.userIds=a,await this._updateOperationsStore(c=>c.update(e))}else i=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,s);const r=await s.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,i,t,a)),o=i.filter(a=>!r.some(c=>c.device===a));await s.wrap("send",a=>this._sendMessagesToDevices(Yi,r,t,a)),o.length&&await s.wrap("missingDevices",async a=>{a.set("devices",o.map(l=>l.deviceId));const c=e.userIds.filter(l=>o.some(d=>d.userId===l));a.set("unsentUserIds",c),e.userIds=c,await this._updateOperationsStore(l=>l.update(e));const h=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",h,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(s){throw t.abort(),s}await t.complete()}async _sendSharedMessageToDevices(e,t,s,i,r){const o=Fe(s,h=>h.userId),a={messages:Array.from(o.entries()).reduce((h,[l,d])=>(h[l]=d.reduce((u,m)=>(u[m.deviceId]=t,u),{}),h),{})},c=At();await i.sendToDevice(e,a,c,{log:r}).response()}async _sendMessagesToDevices(e,t,s,i){i.set("messages",t.length);const r=Fe(t,c=>c.device.userId),o={messages:Array.from(r.entries()).reduce((c,[h,l])=>(c[h]=l.reduce((d,u)=>(d[u.device.deviceId]=u.content,d),{}),c),{})},a=At();await s.sendToDevice(e,o,a,{log:i}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(s=>{var i,r;if(s.isEncrypted&&!s.isDecrypted){const{event:o}=s;if(o){const a=(i=o.content)==null?void 0:i.sender_key,c=(r=o.content)==null?void 0:r.session_id;return t.some(h=>a===h.senderKey&&c===h.sessionId)}}return!1})}dispose(){this._disposed=!0}}class jc{constructor(e,t,s,i,r){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async decrypt(){return new Wc(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class Wc{constructor(e,t,s,i,r){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async write(e,t){const{results:s,errors:i}=await this._megolmDecryptionChanges.write(e);return ms(this._extraErrors,i),await this._roomEncryption._processDecryptionResults(this._events,s,i,this._source,e,t),new Hc(s,i,this._roomEncryption)}}class Hc{constructor(e,t,s){this.results=e,this.errors=t,this._roomEncryption=s}applyToEntries(e){for(const t of e){const s=this.results.get(t.id);if(s)t.setDecryptionResult(s);else{const i=this.errors.get(t.id);i&&t.setDecryptionError(i)}}}verifySenders(e){return Promise.all(Array.from(this.results.values()).map(t=>this._roomEncryption._verifyDecryptionResult(t,e)))}}class zc{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new gc,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}}class Gc{constructor({key:e,platform:t}){this._key=e,this._platform=t}async readSecret(e,t){var r,o;const s=await t.accountData.get(e);if(!s)return;const i=(o=(r=s==null?void 0:s.content)==null?void 0:r.encrypted)==null?void 0:o[this._key.id];if(!i)throw new Error(`Secret ${s.type} is not encrypted for key ${this._key.id}`);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(s.type,i);throw new Error(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`)}async _decryptAESSecret(e,t){const{base64:s,utf8:i}=this._platform.encoding,r=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,i.encode(e),"SHA-256",512),o=r.slice(0,32),a=r.slice(32),c=s.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,s.decode(t.mac),c,"SHA-256"))throw new Error("Bad MAC");const l=await this._platform.crypto.aes.decryptCTR({key:o,iv:s.decode(t.iv),data:c});return i.decode(l)}}const Te="DEFAULT_KEY",ot="pusher";class Jc{constructor({storage:e,hsApi:t,sessionInfo:s,olm:i,olmWorker:r,platform:o,mediaRepository:a}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._syncInfo=null,this._sessionInfo=s,this._rooms=new tt,this._roomUpdateCallback=(c,h)=>this._rooms.update(c.id,h),this._activeArchivedRooms=new Map,this._invites=new tt,this._inviteUpdateCallback=(c,h)=>this._invites.update(c.id,h),this._roomsBeingCreatedUpdateCallback=(c,h)=>{c.isCancelled?this._roomsBeingCreated.remove(c.id):this._roomsBeingCreated.update(c.id,h)},this._roomsBeingCreated=new tt,this._user=new Ca(s.userId),this._deviceMessageHandler=new ec({storage:e}),this._olm=i,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._keyLoader=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=r,this._keyBackup=new Q(void 0),this._observedRoomStatus=new Map,i&&(this._olmUtil=new i.Utility,this._deviceTracker=new Ro({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:s.userId,ownDeviceId:s.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsKeyBackup=new Q(!1)}get fingerprintKey(){var e;return(e=this._e2eeAccount)==null?void 0:e.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}_setupEncryption(){const e=new zc,t=new yc({account:this._e2eeAccount,pickleKey:Te,olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownUserId:this._user.id,senderKeyLock:e});this._olmEncryption=new Sc({account:this._e2eeAccount,pickleKey:Te,olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownUserId:this._user.id,olmUtil:this._olmUtil,senderKeyLock:e}),this._keyLoader=new Dc(this._olm,Te,20),this._megolmEncryption=new Oc({account:this._e2eeAccount,pickleKey:Te,olm:this._olm,storage:this._storage,keyLoader:this._keyLoader,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId}),this._megolmDecryption=new Uc(this._keyLoader,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption})}_createRoomEncryption(e,t){var s;if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==Y?null:new qc({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,keyBackup:(s=this._keyBackup)==null?void 0:s.get(),encryptionParams:t,notifyMissingMegolmSession:()=>{this._keyBackup.get()||this.needsKeyBackup.set(!0)},clock:this._platform.clock})}enableSecretStorage(e,t,s=void 0){return this._platform.logger.wrapOrRun(s,"enable secret storage",async i=>{if(!this._olm)throw new Error("olm required");this._keyBackup.get()&&(this._keyBackup.get().dispose(),this._keyBackup.set(null));const r=await lc(e,t,this._storage,this._platform,this._olm),o=await this._storage.readTxn([this._storage.storeNames.accountData]);if(await this._createKeyBackup(r,o,i))return await this._writeSSSSKey(r,i),this._keyBackup.get().flush(i),r;throw new Error("Could not read key backup with the given key")})}async _writeSSSSKey(e,t){const s=this._keyBackup.get();if(!s)return;const i=s.version,r=await this._storage.readWriteTxn([this._storage.storeNames.session,this._storage.storeNames.inboundGroupSessions]);try{const o=await ac(e,i,r);if(t.set("previousBackupVersion",o),t.set("backupVersion",i),!!o&&o!==i){const a=await s.markAllForBackup(r);t.set("amountMarkedForBackup",a)}}catch(o){throw r.abort(),o}await r.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{hc(e)}catch(t){throw e.abort(),t}if(await e.complete(),this._keyBackup.get()){for(const t of this._rooms.values())t.isEncrypted&&t.enableKeyBackup(void 0);this._keyBackup.get().dispose(),this._keyBackup.set(null)}}_createKeyBackup(e,t,s){return s.wrap("enable key backup",async i=>{try{const r=new Gc({key:e,platform:this._platform}),o=await ws.fromSecretStorage(this._platform,this._olm,r,this._hsApi,this._keyLoader,this._storage,t);if(o){for(const a of this._rooms.values())a.isEncrypted&&a.enableKeyBackup(o);return this._keyBackup.set(o),!0}}catch(r){i.catch(r)}return!1})}get keyBackup(){return this._keyBackup}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()),await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t)))}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await Me.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:Te,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return Me.create({hsApi:this._hsApi,olm:this._olm,pickleKey:Te,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async s=>{const i=await this._createNewAccount("temp-device-id");try{const r=await mc(i,this._hsApi,e,"Dehydrated device",s);return s.set("deviceId",r),r}finally{i.dispose()}})}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await Me.load({hsApi:this._hsApi,olm:this._olm,pickleKey:Te,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&(e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()));const s=await this._getPendingEventsByRoom(t),i=await t.invites.getAll(),r=Promise.all(i.map(async c=>{const h=this.createInvite(c.roomId);e.wrap("invite",l=>h.load(c,l)),this._invites.add(h.id,h)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async c=>{const h=this.createJoinedRoom(c.roomId,s.get(c.roomId));await e.wrap("room",l=>h.load(c,t,l)),this._rooms.add(h.id,h)}));await Promise.all([r,a]);for(const[c,h]of this.invites){const l=this.rooms.get(c);l&&l.setInvite(h)}}dispose(){var e,t,s,i;(e=this._olmWorker)==null||e.dispose(),this._olmWorker=void 0,(t=this._keyBackup.get())==null||t.dispose(),this._keyBackup.set(void 0),(s=this._megolmDecryption)==null||s.dispose(),this._megolmDecryption=void 0,(i=this._e2eeAccount)==null||i.dispose(),this._e2eeAccount=void 0;for(const r of this._rooms.values())r.dispose();this._rooms=void 0}async start(e,t,s){var a;if(e){const c=await this._storage.readWriteTxn([this._storage.storeNames.session]);c.session.set("serverVersions",e),await c.complete()}if(!this._keyBackup.get()){t&&await s.wrap("SSSSKeyFromDehydratedDeviceKey",async l=>{const d=await dc(t.key,this._storage,this._platform);d&&(l.set("success",!0),await this._writeSSSSKey(d))});const c=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.accountData]),h=await cc(c);h&&await this._createKeyBackup(h,c,s)&&((a=this._keyBackup.get())==null||a.flush(s)),this._keyBackup.get()||this._keyBackup.set(null)}const r=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),o=Fe(r,c=>c.scope);for(const c of this._rooms.values()){let h;const l=o.get(c.id);l&&(h=Fe(l,d=>d.type)),c.start(h,s)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((s,i)=>{const r=s.get(i.roomId);return r?r.push(i):s.set(i.roomId,[i]),s},new Map)}get rooms(){return this._rooms}findDirectMessageForUserId(e){for(const[,t]of this._rooms)if(t.isDirectMessageForUserId(e))return t;for(const[,t]of this._invites)if(t.isDirectMessageForUserId(e))return t}createJoinedRoom(e,t){return new ja({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform})}_createArchivedRoom(e){const t=new Wa({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new Za({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}get roomsBeingCreated(){return this._roomsBeingCreated}createRoom(e){let t;return this._platform.logger.runDetached("create room",async s=>{const i=`local-${Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER)}`;t=new Xa(i,e,this._roomsBeingCreatedUpdateCallback,this._mediaRepository,this._platform,s),this._roomsBeingCreated.set(i,t);const r=[t.create(this._hsApi,s)];e.loadProfiles!==!1&&r.push(t.loadProfiles(this._hsApi,s)),await Promise.all(r),t.roomId&&(this.rooms.get(t.roomId)&&this._tryReplaceRoomBeingCreated(t.roomId,s),await t.adjustDirectMessageMapIfNeeded(this._user,this._storage,this._hsApi,s))}),t}async obtainSyncLock(e){var s;const t=(s=e.to_device)==null?void 0:s.events;if(Array.isArray(t)&&t.length)return await this._deviceMessageHandler.obtainSyncLock(t)}async prepareSync(e,t,s,i){var o;const r=(o=e.to_device)==null?void 0:o.events;if(Array.isArray(r)&&r.length)return await i.wrap("deviceMsgs",a=>this._deviceMessageHandler.prepareSync(r,t,s,a))}async writeSync(e,t,s,i,r){const o={syncInfo:null,e2eeAccountChanges:null},a=e.next_batch;if(a!==this.syncToken){const d={token:a,filterId:t};i.session.set("sync",d),o.syncInfo=d}const c=e.device_one_time_keys_count;this._e2eeAccount&&c&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(c,i,r));const h=e.device_lists;this._deviceTracker&&Array.isArray(h==null?void 0:h.changed)&&h.changed.length&&await r.wrap("deviceLists",d=>this._deviceTracker.writeDeviceChanges(h.changed,i,d)),s&&(o.hasNewRoomKeys=await r.wrap("deviceMsgs",d=>this._deviceMessageHandler.writeSync(s,i,d)));const l=e.account_data;if(Array.isArray(l==null?void 0:l.events))for(const d of l.events)typeof d.type=="string"&&i.accountData.set(d);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,s){var i;t||await this._e2eeAccount.generateOTKsIfNeeded(this._storage,s)&&await s.wrap("uploadKeys",o=>this._e2eeAccount.uploadKeys(this._storage,!1,o)),e.hasNewRoomKeys&&((i=this._keyBackup.get())==null||i.flush(s))}_tryReplaceRoomBeingCreated(e,t){for(const[,s]of this._roomsBeingCreated)if(s.roomId===e){const i=this._observedRoomStatus.get(s.id);i&&(t.log("replacing room being created").set("localId",s.id).set("roomId",s.roomId),i.set(i.get()|k.Replaced)),s.dispose(),this._roomsBeingCreated.remove(s.id);return}}applyRoomCollectionChangesAfterSync(e,t,s,i){var r,o;for(const a of t)a.shouldAdd?(this._rooms.add(a.id,a.room),this._tryReplaceRoomBeingCreated(a.id,i)):a.shouldRemove&&this._rooms.remove(a.id);for(const a of e)a.shouldAdd?this._invites.add(a.id,a.invite):a.shouldRemove&&this._invites.remove(a.id);if(this._observedRoomStatus.size!==0){for(const a of s)a.shouldAdd&&((r=this._observedRoomStatus.get(a.id))==null||r.set(k.Archived));for(const a of t)a.shouldAdd&&((o=this._observedRoomStatus.get(a.id))==null||o.set(k.Joined));for(const a of e){const c=this._observedRoomStatus.get(a.id);if(c){const h=c.get()|k.Invited;if(a.shouldAdd)c.set(h);else if(a.shouldRemove){const l=h^k.Invited;c.set(l)}}}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set((t.get()|k.Archived)^k.Archived)}get syncToken(){var e;return(e=this._syncInfo)==null?void 0:e.token}get syncFilterId(){var e;return(e=this._syncInfo)==null?void 0:e.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{const t=Ce.createDefaultPayload(this._sessionInfo.id),s=await this._platform.notificationService.enablePush(Ce,t);if(!s)return e.set("no_pusher",!0),!1;await s.enable(this._hsApi,e);const i=await this._storage.readWriteTxn([this._storage.storeNames.session]);return i.session.set(ot,s.serialize()),await i.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();const s=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ot);if(!s)return!0;await new Ce(s).disable(this._hsApi,e);const r=await this._storage.readWriteTxn([this._storage.storeNames.session]);return r.session.remove(ot),await r.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ot):!1}async checkPusherEnabledOnHomeserver(){const t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ot);if(!t)return!1;const s=new Ce(t),i=await this._hsApi.getPushers().response();return((i==null?void 0:i.pushers)||[]).map(o=>new Ce(o)).some(o=>o.equals(s))}async getRoomStatus(e){if(!!this._roomsBeingCreated.get(e))return k.BeingCreated;if(!!this._rooms.get(e))return k.Joined;{const i=!!this._invites.get(e),o=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return i&&o?k.Invited|k.Archived:i?k.Invited:o?k.Archived:k.None}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){const s=await this.getRoomStatus(e);t=new Ft(s,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t)}return t}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async s=>{s.set("id",e);const i=this._activeArchivedRooms.get(e);if(i)return i.retain(),i;const r=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await r.archivedRoomSummary.get(e);if(o){const a=this._createArchivedRoom(e);return await a.load(o,r,s),a}})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async s=>(await this._hsApi.joinIdOrAlias(e,{log:s}).response()).room_id)}}class Qc{constructor({username:e,password:t,homeserver:s}){this._username=e,this._password=t,this.homeserver=s}async login(e,t,s){return await e.passwordLogin(this._username,this._password,t,{log:s}).response()}}class Yc{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,s){return await e.tokenLogin(this._loginToken,At(),t,{log:s}).response()}}class Xc{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${e}`}}class Xi{constructor(e,t){this._session=e,this._params=t}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}}class Zc extends Xi{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.dummy"}}class eh extends Xi{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.terms"}get privacyPolicy(){var e;return(e=this._params)==null?void 0:e.policies.privacy_policy}get termsOfService(){var e;return(e=this._params)==null?void 0:e.policies.terms_of_service}}class th{constructor(e,t,s){this._hsApi=e,this._accountDetails=t,this._flowSelector=s!=null?s:i=>i[0]}async start(){const e=await this._hsApi.register(this._accountDetails.username,this._accountDetails.password,this._accountDetails.initialDeviceDisplayName,void 0,this._accountDetails.inhibitLogin).response();return this.parseStagesFromResponse(e)}async submitStage(e){const t=e.generateAuthenticationData(),{username:s,password:i,initialDeviceDisplayName:r,inhibitLogin:o}=this._accountDetails,a=this._hsApi.register(s,i,r,t,o),c=await a.response(),h=await a.responseCode(),l=Vs(yt({},c),{status:h});return this.parseRegistrationResponse(l,e)}parseStagesFromResponse(e){const{session:t,params:s}=e,i=this._flowSelector(e.flows);if(!i)throw new Error("flowSelector did not return any flow!");let r,o;for(const a of i.stages){const c=this._createRegistrationStage(a,t,s);r?(o.setNextStage(c),o=c):(r=c,o=c)}return r}async parseRegistrationResponse(e,t){var s;switch(e.status){case 200:this._sessionInfo=e;return;case 401:if((s=e.completed)==null?void 0:s.includes(t.type))return t.nextStage;throw new Error("This stage could not be completed!")}}_createRegistrationStage(e,t,s){switch(e){case"m.login.dummy":return new Zc(t,s==null?void 0:s[e]);case"m.login.terms":return new eh(t,s==null?void 0:s[e]);default:throw new Error(`Unknown stage: ${e}`)}}get sessionInfo(){return this._sessionInfo}}const y=se("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),ae=se("Connection","Credentials","Unknown");class vs{constructor(e){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new Q(y.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=e.loadOlm(),this._workerPromise=e.loadOlmWorker(),this._accountSetup=void 0}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===y.NotLoading&&(this._status.set(y.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{const s=await this._platform.sessionInfoStorage.get(e);if(!s)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(s,null,t),t.set("status",this._status.get())}catch(s){t.catch(s),this._error=s,this._status.set(y.Error)}}))}_parseLoginOptions(e,t){const s=e.flows,i={homeserver:t};for(const r of s)r.type==="m.login.password"?i.password=(o,a)=>new Qc({homeserver:t,username:o,password:a}):r.type==="m.login.sso"&&s.find(o=>o.type==="m.login.token")?i.sso=new Xc(t):r.type==="m.login.token"&&(i.token=o=>new Yc({homeserver:t,loginToken:o}));return i}queryLogin(e){return new Ls(async t=>{e=await en(e,(r,o)=>t(this._platform.request(r,o)));const s=new Ie({homeserver:e,request:this._platform.request}),i=await t(s.getLoginFlows()).response();return this._parseLoginOptions(i,e)})}async startRegistration(e,t,s,i){const r=this._platform.request,o=new Ie({homeserver:e,request:r});return new th(o,{username:t,password:s,initialDeviceDisplayName:i})}async startWithLogin(e,{inspectAccountSetup:t}={}){const s=this._status.get();s!==y.LoginFailed&&s!==y.NotLoading&&s!==y.Error||(this._resetStatus(),await this._platform.logger.run("login",async i=>{this._status.set(y.Login);const r=this._platform.clock;let o;try{const c=this._platform.request,h=new Ie({homeserver:e.homeserver,request:c}),l=await e.login(h,"Hydrogen",i),d=this.createNewSessionId();o={id:d,deviceId:l.device_id,userId:l.user_id,homeServer:e.homeserver,homeserver:e.homeserver,accessToken:l.access_token,lastUsed:r.now()},i.set("id",d)}catch(c){this._error=c,c.name==="HomeServerError"?(c.errcode==="M_FORBIDDEN"?this._loginFailure=ae.Credentials:this._loginFailure=ae.Unknown,i.set("loginFailure",this._loginFailure),this._status.set(y.LoginFailed)):c.name==="ConnectionError"?(this._loginFailure=ae.Connection,this._status.set(y.LoginFailed)):this._status.set(y.Error);return}let a;t&&(a=await this._inspectAccountAfterLogin(o,i),a&&(o.deviceId=a.deviceId)),await this._platform.sessionInfoStorage.add(o);try{await this._loadSessionInfo(o,a,i),i.set("status",this._status.get())}catch(c){i.catch(c),a==null||a.dispose(),this._error=c,this._status.set(y.Error)}}))}async _loadSessionInfo(e,t,s){s.set("appVersion",this._platform.version);const i=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(y.Loading),this._reconnector=new hn({onlineStatus:this._platform.onlineStatus,retryDelay:new js(i.createTimeout),createMeasure:i.createMeasure});const r=new Ie({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,s);const o={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer},a=await this._olmPromise;let c=null;this._workerPromise&&(c=await this._workerPromise),this._requestScheduler=new _n({hsApi:r,clock:i}),this._requestScheduler.start();const h=new un({homeserver:e.homeServer,platform:this._platform});if(this._session=new Jc({storage:this._storage,sessionInfo:o,hsApi:this._requestScheduler.hsApi,olm:a,olmWorker:c,mediaRepository:h,platform:this._platform}),await this._session.load(s),t?(await s.wrap("dehydrateIdentity",l=>this._session.dehydrateIdentity(t,l)),await this._session.setupDehydratedDevice(t.key,s)):this._session.hasIdentity||(this._status.set(y.SessionSetup),await s.wrap("createIdentity",l=>this._session.createIdentity(l))),this._sync=new fn({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(l=>{l===De.Online&&this._platform.logger.runDetached("reconnect",async d=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;const u=t;t=void 0,await d.wrap("session start",m=>this._session.start(this._reconnector.lastVersionsResponse,u,m))})}),await s.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(y.Ready),!this._sessionStartedByReconnector)){const l=await r.versions({timeout:1e4,log:s}).response();if(this._isDisposed)return;const d=t;t=void 0,await s.wrap("session start",u=>this._session.start(l,d,u))}}async _waitForFirstSync(){this._sync.start(),this._status.set(y.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>{var t;return e===S.Stopped?((t=this._sync.error)==null?void 0:t.name)!=="ConnectionError":e===S.Syncing});try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===S.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async s=>{var a;this._status.set(y.QueryAccount);const i=new Ie({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),r=await this._olmPromise;let o;try{o=await uc(i,r,this._platform,s)}catch(c){if(c.name==="HomeServerError")s.set("not_supported",!0);else throw c}if(o){let c;const h=new Promise(d=>c=d);this._accountSetup=new sh(o,c),this._status.set(y.AccountSetup),await h;const l=(a=this._accountSetup)==null?void 0:a._dehydratedDevice;return this._accountSetup=null,l}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}startLogout(e){return this._platform.logger.run("logout",async t=>{this._sessionId=e,t.set("id",this._sessionId);const s=await this._platform.sessionInfoStorage.get(this._sessionId);if(!s)throw new Error(`Could not find session for id ${this._sessionId}`);try{await new Ie({homeserver:s.homeServer,accessToken:s.accessToken,request:this._platform.request}).logout({log:t}).response()}catch{}await this.deleteSession(t)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(y.NotLoading),this._error=null,this._loginFailure=null}}class sh{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class w extends vt{constructor(e={}){super();this.disposables=null,this._isDisposed=!1,this._options=e}childOptions(e){const{navigation:t,urlCreator:s,platform:i}=this._options;return Object.assign({navigation:t,urlCreator:s,platform:i},e)}getOption(e){return this._options[e]}track(e){return this.disposables||(this.disposables=new ns),this.disposables.track(e)}untrack(e){return this.disposables?this.disposables.untrack(e):null}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){return this.disposables?this.disposables.disposeTracked(e):null}i18n(e,...t){let s="";for(let i=0;i<e.length;++i)s=s+e[i],i<t.length&&(s=s+t[i]);return s}updateOptions(e){this._options=Object.assign(this._options,e)}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlCreator(){return this._options.urlCreator}get navigation(){return this._options.navigation}}function H(n){let e=n.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=n.charAt(1)),e.toUpperCase()}function ih(n){let e=0,t,s;if(n.length===0)return e;for(t=0;t<n.length;t++)s=n.charCodeAt(t),e=(e<<5)-e+s,e|=0;return Math.abs(e)}function z(n){return ih(n)%8+1}function ce(n,e,t,s){if(n){const i=e*t.devicePixelRatio;return s.mxcUrlThumbnail(n,i,i,"crop")}return null}const Zi=["roomBeingCreated","invite","room"];class bs extends w{constructor(e){super(e);this._isOpen=!1,this._hidden=!1}get hidden(){return this._hidden}set hidden(e){e!==this._hidden&&(this._hidden=e,this.emitChange("hidden"))}close(){this._isOpen&&(this._isOpen=!1,this.emitChange("isOpen"))}open(){this._isOpen||(this._isOpen=!0,this.emitChange("isOpen"))}get isOpen(){return this._isOpen}compare(e){return e.kind!==this.kind?Zi.indexOf(this.kind)-Zi.indexOf(e.kind):0}get avatarLetter(){return H(this.name)}get avatarColorNumber(){return z(this._avatarSource.avatarColorId)}avatarUrl(e){return ce(this._avatarSource.avatarUrl,e,this.platform,this._avatarSource.mediaRepository)}get avatarTitle(){return this.name}}class rh extends bs{constructor(e){super(e);const{room:t}=e;this._room=t,this._url=this.urlCreator.openRoomActionUrl(this._room.id)}get kind(){return"room"}get url(){return this._url}compare(e){const t=super.compare(e);if(t!==0)return t;const s=this._room,i=e._room;if(s.isLowPriority!==i.isLowPriority)return s.isLowPriority?1:-1;const r=s.lastMessageTimestamp,o=i.lastMessageTimestamp,a=Number.isSafeInteger(r),c=Number.isSafeInteger(o);if(a!==c)return c?1:-1;const h=o-r;if(h===0||!c||!a){const l=this.name.localeCompare(e.name);return l===0?this._room.id.localeCompare(e._room.id):l}return h}get isUnread(){return this._room.isUnread}get name(){return this._room.name||this.i18n`Empty Room`}get badgeCount(){return this._room.notificationCount}get isHighlighted(){return this._room.highlightCount!==0}get _avatarSource(){return this._room}}function Ss(n,e){return n===e?0:n<e?-1:1}class nh extends bs{constructor(e){super(e);const{invite:t}=e;this._invite=t,this._url=this.urlCreator.openRoomActionUrl(this._invite.id)}get busy(){return this._invite.accepting||this._invite.rejecting}get kind(){return"invite"}get url(){return this._url}get name(){return this._invite.name}get isHighlighted(){return!0}get isUnread(){return!0}get badgeCount(){return this.i18n`!`}get _avatarSource(){return this._invite}compare(e){const t=super.compare(e);if(t!==0)return t;const s=e._invite.timestamp-this._invite.timestamp;return s!==0?s:Ss(this._invite.id,e._invite.id)}}class oh extends bs{constructor(e){super(e);const{roomBeingCreated:t}=e;this._roomBeingCreated=t,this._url=this.urlCreator.openRoomActionUrl(this._roomBeingCreated.id)}get busy(){return!this._roomBeingCreated.error}get kind(){return"roomBeingCreated"}get isHighlighted(){return!this.busy}get badgeCount(){return!this.busy&&this.i18n`Failed`}get url(){return this._url}get name(){return this._roomBeingCreated.name}get _avatarSource(){return this._roomBeingCreated}compare(e){const t=super.compare(e);if(t!==0)return t;const s=Ss(this.name,e.name);return s===0?Ss(this._roomBeingCreated.id,e._roomBeingCreated.id):s}avatarUrl(e){var t;return(t=this._roomBeingCreated.avatarBlobUrl)!=null?t:super.avatarUrl(e)}}class ah{constructor(e){this._parts=e.split(" ").map(t=>t.toLowerCase().trim())}matches(e){const t=e.name.toLowerCase();return this._parts.every(s=>t.includes(s))}}class ch extends Oe{constructor(e,t){super();this._source=e,this._apply=t,this._subscription=null}hasApply(){return!!this._apply}setApply(e){this._apply=e,e&&this.applyOnce(this._apply)}applyOnce(e){for(const[t,s]of this._source)e(t,s)}onAdd(e,t){this._apply&&this._apply(e,t),this.emitAdd(e,t)}onRemove(e,t){this.emitRemove(e,t)}onUpdate(e,t,s){this._apply&&this._apply(e,t,s),this.emitUpdate(e,t,s)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._apply&&this.applyOnce(this._apply),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription()}onReset(){this._apply&&this.applyOnce(this._apply),this.emitReset()}[Symbol.iterator](){return this._source[Symbol.iterator]()}get size(){return this._source.size}get(e){return this._source.get(e)}}class hh{constructor(e){this._allowsChild=e,this._path=new he([],e),this._observables=new Map,this._pathObservable=new Q(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,t=void 0){return this.applyPath(this.path.with(new $(e,t)))}applyPath(e){const t=this._path;this._path=e;for(let s=t.segments.length-1;s>=0;s-=1){const i=t.segments[s];if(!this._path.get(i.type)){const r=this._observables.get(i.type);r==null||r.emitIfChanged()}}for(const s of this._path.segments){const i=this._observables.get(s.type);i==null||i.emitIfChanged()}this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new dh(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,s;for(s=0;s<e.length;s+=1){if(!this._allowsChild(t,e[s]))return new he(e.slice(0,s),this._allowsChild);t=e[s]}return new he(e,this._allowsChild)}segment(e,t){return new $(e,t)}}function lh(n,e){if(n===e)return!0;if(Array.isArray(n)&&Array.isArray(e)){const t=Math.max(n.length,e.length);for(let s=0;s<t;s+=1)if(n[s]!==e[s])return!1;return!0}return!1}class ${constructor(e,t){this.type=e,this.value=t===void 0?!0:t}}class he{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new he(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const s=this._segments.slice(0,t+1);return s.push(e),new he(s,this._allowsChild)}t-=1}while(t>=-1);return null}until(e){const t=this._segments.findIndex(s=>s.type===e);return t!==-1?new he(this._segments.slice(0,t+1),this._allowsChild):new he([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){const t=this._segments.findIndex(s=>s.type===e.type);if(t!==-1){const s=this._segments[t-1];if(this._allowsChild(s,e)){const i=this._segments[t+1];if(!i||this._allowsChild(e,i)){const r=this._segments.slice();return r[t]=e,new he(r,this._allowsChild)}}}return null}get segments(){return this._segments}}class dh extends Ue{constructor(e,t){super();var s;this._navigation=e,this._type=t,this._lastSetValue=(s=e.path.get(t))==null?void 0:s.value}get(){const t=this._navigation.path.get(this._type);return t==null?void 0:t.value}emitIfChanged(){const e=this.get();lh(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}class uh{constructor({history:e,navigation:t,parseUrlPath:s,stringifyPath:i}){this._history=e,this._navigation=t,this._parseUrlPath=s,this._stringifyPath=i,this._subscription=null,this._pathSubscription=null,this._isApplyingUrl=!1,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){var s;const t=(s=this._urlAsNavPath(this._history.getLastUrl()||"").get("session"))==null?void 0:s.value;return typeof t=="string"?t:null}attach(){this._subscription=this._history.subscribe(e=>this._applyUrl(e)),this._pathSubscription=this._navigation.pathObservable.subscribe(e=>this._applyNavPathToHistory(e)),this._applyUrl(this._history.get())}dispose(){this._subscription=this._subscription(),this._pathSubscription=this._pathSubscription()}_applyNavPathToHistory(e){const t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){const t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){const t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){const e=this._urlAsNavPath(this._history.getLastUrl()||"");return e.segments.length!==0?(this._applyNavPathToNavigation(e),!0):!1}urlForSegments(e){let t=this._navigation.path;for(const s of e)if(t=t.with(s),!t)return;return this.urlForPath(t)}urlForSegment(e,t){return this.urlForSegments([this._navigation.segment(e,t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){const t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${e}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.origin}normalizeUrl(){this._history.replaceUrlSilently(`${window.location.origin}/${window.location.hash}`)}}function mh(){return new hh(ph)}function _h({history:n,navigation:e}){return new uh({history:n,navigation:e,stringifyPath:yh,parseUrlPath:fh})}function ph(n,e){const{type:t}=e;switch(n==null?void 0:n.type){case void 0:return t==="login"||t==="session"||t==="sso"||t==="logout";case"session":return t==="room"||t==="rooms"||t==="settings"||t==="create-room";case"rooms":return t==="room"||t==="empty-grid-tile";case"room":return t==="lightbox"||t==="right-panel";case"right-panel":return t==="details"||t==="members"||t==="member";default:return!1}}function gh(n,e,t){if(n.value.includes(e))return n;{const s=t.get("empty-grid-tile"),i=t.get("room");let r=0;s?r=s.value:i&&(r=n.value.indexOf(i.value));const o=n.value.slice();return o[r]=e,new $("rooms",o)}}function er(n,e,t=!0){n.push(new $("right-panel")),n.push(new $(e,t))}function Is(n,e){const t=n.path.segments,s=t.findIndex(r=>r.type==="right-panel");let i=e;return s!==-1&&(i=e.until("room"),i=i.with(t[s]),i=i.with(t[s+1])),i}function fh(n,e,t){const s=n.substr(1).split("/"),i=s[Symbol.iterator](),r=[];let o;for(;!(o=i.next()).done;){const a=o.value;if(a==="rooms"){const c=i.next().value;if(c===void 0)break;const h=c.split(",");r.push(new $(a,h));const l=parseInt(i.next().value||"0",10),d=h[l];d?r.push(new $("room",d)):r.push(new $("empty-grid-tile",l))}else if(a==="open-room"){const c=i.next().value;if(!c)break;const h=e.get("rooms");if(h&&r.push(gh(h,c,e)),r.push(new $("room",c)),s.findIndex(u=>u==="open-room")>=s.length-2){const u=e.segments,m=u.findIndex(_=>_.type==="right-panel");m!==-1&&r.push(...u.slice(m))}}else if(a==="last-session"){let c=e.get("session");typeof(c==null?void 0:c.value)!="string"&&t&&(c=new $("session",t)),c&&r.push(c)}else if(a==="details"||a==="members")er(r,a);else if(a==="member"){const c=i.next().value;if(!c)break;er(r,a,c)}else if(a.includes("loginToken")){const c=a.split("=").pop();r.push(new $("sso",c))}else{const c=i.next().value;r.push(new $(a,c))}}return r}function yh(n){let e="",t;for(const s of n.segments){switch(s.type){case"rooms":e+=`/rooms/${s.value.join(",")}`;break;case"empty-grid-tile":e+=`/${s.value}`;break;case"room":(t==null?void 0:t.type)==="rooms"?e+=`/${t.value.indexOf(s.value)}`:e+=`/${s.type}/${s.value}`;break;case"right-panel":case"sso":continue;default:e+=`/${s.type}`,s.value&&s.value!==!0&&(e+=`/${s.value}`)}t=s}return e}class wh extends w{constructor(e){super(e);const{session:t}=e;this._tileViewModelsMap=this._mapTileViewModels(t.roomsBeingCreated,t.invites,t.rooms),this._tileViewModelsFilterMap=new ch(this._tileViewModelsMap),this._tileViewModels=this._tileViewModelsFilterMap.sortValues((s,i)=>s.compare(i)),this._currentTileVM=null,this._setupNavigation(),this._closeUrl=this.urlCreator.urlForSegment("session"),this._settingsUrl=this.urlCreator.urlForSegment("settings"),this._createRoomUrl=this.urlCreator.urlForSegment("create-room")}_mapTileViewModels(e,t,s){return t.join(e,s).mapValues((r,o)=>{var h;let a;return r.isBeingCreated?a=new oh(this.childOptions({roomBeingCreated:r,emitChange:o})):r.isInvite?a=new nh(this.childOptions({invite:r,emitChange:o})):a=new rh(this.childOptions({room:r,emitChange:o})),((h=this.navigation.path.get("room"))==null?void 0:h.value)===r.id&&(a.open(),this._updateCurrentVM(a)),a})}_updateCurrentVM(e){var t;(t=this._currentTileVM)==null||t.close(),this._currentTileVM=e}get closeUrl(){return this._closeUrl}get settingsUrl(){return this._settingsUrl}get createRoomUrl(){return this._createRoomUrl}_setupNavigation(){const e=this.navigation.observe("room");this.track(e.subscribe(s=>this._open(s)));const t=this.navigation.observe("rooms");this.gridEnabled=!!t.get(),this.track(t.subscribe(s=>{const i=this.gridEnabled^!!s;this.gridEnabled=!!s,i&&this.emitChange("gridEnabled")}))}_open(e){var t,s;(t=this._currentTileVM)==null||t.close(),this._currentTileVM=null,e&&(this._currentTileVM=this._tileViewModelsMap.get(e),(s=this._currentTileVM)==null||s.open())}toggleGrid(){const e=this.navigation.path.get("room");let t=this.navigation.path.until("session");this.gridEnabled?e&&(t=t.with(e),t=Is(this.navigation,t)):e?(t=t.with(this.navigation.segment("rooms",[e.value])),t=t.with(e),t=Is(this.navigation,t)):(t=t.with(this.navigation.segment("rooms",[])),t=t.with(this.navigation.segment("empty-grid-tile",0))),this.navigation.applyPath(t)}get tileViewModels(){return this._tileViewModels}clearFilter(){this._tileViewModelsFilterMap.setApply(null),this._tileViewModelsFilterMap.applyOnce((e,t)=>t.hidden=!1)}setFilter(e){if(e=e.trim(),e.length===0)return this.clearFilter(),!1;{const t=!this._tileViewModelsFilterMap.hasApply(),s=new ah(e);return this._tileViewModelsFilterMap.setApply((i,r)=>{r.hidden=!s.matches(r)}),t}}}class te{constructor(e,t,s,i){this._remove=e,this._update=t,this._replace=s,this._updateParams=i}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new te(!0,!1,!1,null)}static Update(e){return new te(!1,!0,!1,e)}static Nothing(){return new te(!1,!1,!1,null)}static Replace(e){return new te(!1,!1,!0,e)}}class vh extends Ke{constructor(e,t){super();this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileCreator=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_emitSpontanousUpdate(e,t){const s=e.lowerEntry,i=this._findTileIdx(s);this.emitUpdate(i,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._tiles=[];let e=null;for(let s of this._entries)(!e||!e.tryIncludeEntry(s))&&(e=this._tileCreator(s),e&&this._tiles.push(e));let t=null;for(let s of this._tiles)t&&t.updateNextSibling(s),s.updatePreviousSibling(t),t=s;t&&t.updateNextSibling(null);for(const s of this._tiles)s.setUpdateEmit(this._emitSpontanousUpdate)}_findTileIdx(e){return ye(this._tiles,e,(t,s)=>-s.compareEntry(t))}_findTileAtIdx(e,t){const s=this._getTileAtIdx(t);if(s&&s.compareEntry(e)===0)return s}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const s=this._findTileIdx(t),i=this._getTileAtIdx(s-1);if(i&&i.tryIncludeEntry(t)){this.emitUpdate(s-1,i);return}const r=this._getTileAtIdx(s);if(r&&r.tryIncludeEntry(t)){this.emitUpdate(s,r);return}const o=this._tileCreator(t);o&&(i&&(i.updateNextSibling(o),o.updatePreviousSibling(i)),r&&(o.updateNextSibling(r),r.updatePreviousSibling(o)),this._tiles.splice(s,0,o),this.emitAdd(s,o),o.setUpdateEmit(this._emitSpontanousUpdate))}onUpdate(e,t,s){if(!this._tiles)return;const i=this._findTileIdx(t),r=this._findTileAtIdx(t,i);if(r){const o=r.updateEntry(t,s,this._tileCreator);if(o.shouldReplace){const a=this._tileCreator(t);a?(this._replaceTile(i,r,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(i,r)}o.shouldRemove&&this._removeTile(i,r),o.shouldUpdate&&this.emitUpdate(i,r,o.updateParams)}}_replaceTile(e,t,s,i){t.dispose();const r=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=s,r==null||r.updateNextSibling(s),s.updatePreviousSibling(r),s.updateNextSibling(o),o==null||o.updatePreviousSibling(s),this.emitUpdate(e,s,i)}_removeTile(e,t){const s=this._getTileAtIdx(e-1),i=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),s==null||s.updateNextSibling(i),i==null||i.updatePreviousSibling(s)}onRemove(e,t){const s=this._findTileIdx(t),i=this._findTileAtIdx(t,s);i&&(i.removeEntry(t)?this._removeTile(s,i):this.emitUpdate(s,i))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=ye(this._tiles,e,(i,r)=>i.compare(r)),s=this._tiles[t];return(s==null?void 0:s.compare(e))===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class bh extends w{constructor(e){super(e);const{timeline:t,tilesCreator:s}=e;this._timeline=this.track(t),this._tiles=new vh(t.entries,s),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let s;if(e&&t){this._startTile=e,this._endTile=t;const i=this._tiles.getTileIndex(this._startTile),r=this._tiles.getTileIndex(this._endTile);for(const o of this._tiles.sliceIterator(i,r+1))o.notifyVisible();s=i<10,this._setShowJumpDown(r<this._tiles.length-1)}else s=!0,this._setShowJumpDown(!1);s&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(i=>{this._topLoadingPromise=null,i||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class Sh extends w{constructor(e){super();this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){var s;(new Boolean(e)!==new Boolean(this._replyVM)||!((s=this._replyVM)==null?void 0:s.id.equals(e.asEventKey())))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e)),this._replyVM.notifyVisible()),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}class at extends w{constructor(e){super(e);this._entry=e.entry}get shape(){return null}get isContinuation(){return!1}get hasDateSeparator(){return!1}get id(){return this._entry.asEventKey()}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==v.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}abortSending(){var e;(e=this._entry.pendingEvent)==null||e.abort()}setUpdateEmit(e){this.updateOptions({emitChange:t=>{e&&e(this,t)}})}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}compare(e){return this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const s=this.shape==="redacted";return!e.isGap&&e.isRedacted!==s?te.Replace("shape"):(this._entry=e,te.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(){}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(null),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this._options.roomVM}get _timeline(){return this._options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this._options.timeline.me}}class Ih extends at{constructor(e){super(e);this._loading=!1,this._error=null,this._isAtTop=!0,this._siblingChanged=!1}async fill(){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(e){throw console.error(`room.fillGap(): ${e.message}:
${e.stack}`),this._error=e,this.emitChange("error"),e}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t,s){return super.updateEntry(e,t,s),e.isGap?te.Nothing():te.Remove()}get shape(){return"gap"}get isLoading(){return this._loading}get error(){return this._error?`Could not load ${this._entry.prev_batch?"previous":"next"} messages: ${this._error.message}`:null}}class Eh{constructor(e){this._parentTile=e,this._map=new tt,this._reactions=this._map.sortValues((t,s)=>t._compare(s))}update(e,t){if(e){for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],r=this._map.get(s);r?r._tryUpdate(i)&&this._map.update(s):this._map.add(s,new tr(s,i,null,this._parentTile))}}if(t)for(const[s,i]of t.entries()){const r=this._map.get(s);r?(r._tryUpdatePending(i),this._map.update(s)):this._map.add(s,new tr(s,null,i,this._parentTile))}for(const s of this._map.keys()){const i=t==null?void 0:t.has(s),r=e==null?void 0:e.hasOwnProperty(s);!r&&!i?this._map.remove(s):r?i||this._map.get(s)._tryUpdatePending(null)&&this._map.update(s):this._map.get(s)._tryUpdate(null)&&this._map.update(s)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class tr{constructor(e,t,s,i){this._key=e,this._annotation=t,this._pending=s,this._parentTile=i,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,i=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||i?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){var e,t;return(((e=this._pending)==null?void 0:e.count)||0)+(((t=this._annotation)==null?void 0:t.count)||0)}get isPending(){return this._pending!==null}get isActive(){var e;return((e=this._annotation)==null?void 0:e.me)||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}class we extends at{constructor(e){super(e);this._date=this._entry.timestamp?new Date(this._entry.timestamp):null,this._isContinuation=!1,this._reactions=null,this._replyTile=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions(),this._updateReplyTileIfNeeded(e.tilesCreator,void 0)}notifyVisible(){var e;super.notifyVisible(),(e=this._replyTile)==null||e.notifyVisible()}get _mediaRepository(){return this._room.mediaRepository}get permaLink(){return`https://matrix.to/#/${encodeURIComponent(this._room.id)}/${encodeURIComponent(this._entry.id)}`}get senderProfileLink(){return`https://matrix.to/#/${encodeURIComponent(this.sender)}`}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}get memberPanelLink(){return`${this.urlCreator.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return z(this._entry.sender)}avatarUrl(e){return ce(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return H(this.sender)}get avatarTitle(){return this.displayName}get date(){return this._date&&this._date.toLocaleDateString({},{month:"numeric",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}get isReply(){return this._entry.isReply}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof we&&e.sender===this.sender){const s=this._entry.timestamp,i=e._entry.timestamp;t=s-i<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t,s){const i=super.updateEntry(e,t,s);return i.shouldUpdate&&this._updateReactions(),this._updateReplyTileIfNeeded(s,t),i}_updateReplyTileIfNeeded(e,t){var i,r;const s=this._entry.contextEntry;if(s){const o=(i=this._replyTile)==null?void 0:i.updateEntry(s,t,e);((o==null?void 0:o.shouldReplace)||!this._replyTile)&&(this.disposeTracked(this._replyTile),this._replyTile=e(s)),(o==null?void 0:o.shouldUpdate)&&((r=this._replyTile)==null||r.emitChange())}}startReply(){this._roomVM.startReply(this._entry)}reply(e,t,s=null){return this._room.sendEvent("m.room.message",this._entry.reply(e,t),null,s)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async s=>{var r,o;if(!this.canReact){s.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){s.set("already_reacted",!0);return}const i=(o=(r=this._entry.pendingAnnotations)==null?void 0:r.get(e))==null?void 0:o.redactionEntry;i&&!i.pendingEvent.hasStartedSending?(s.set("abort_redaction",!0),await i.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,s)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async s=>{var r,o;if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){s.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){s.set("not_yet_reacted",!0);return}let i=(o=(r=this._entry.pendingAnnotations)==null?void 0:r.get(e))==null?void 0:o.annotationEntry;i||(i=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),i?await this._room.sendRedaction(i.id,null,s):s.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async s=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,s):await this.react(e,s)})}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new Eh(this)),this._reactions.update(e,t))}get replyTile(){return this._entry.contextEventId?this._replyTile:null}}const kh="(?:https|http|ftp):\\/\\/",sr="[^\\s.,?!)]",ir="[a-zA-Z0-9:.\\[\\]-]",Rh=`${ir}*(?=${ir})${sr}`,Ch=`(?:[\\/#](?:[^\\s]*${sr})?)`,Mh=`${kh}${Rh}${Ch}?`,Th=new RegExp(Mh,"gi");function rr(n,e){const t=n.matchAll(Th);let s=0;for(let r of t){const o=n.slice(s,r.index);e(o,!1),e(r[0],!0);const a=r[0].length;s=r.index+a}const i=n.slice(s);e(i,!1)}function Ah(n){const e=[],t=n.split(`
`),s=(i,r)=>{r?e.push(new Es(i,[new qe(i)])):e.push(new qe(i))};for(let i=0;i<t.length;i+=1){const r=t[i];r.length&&rr(r,s),i>=t.length-1||e.push(new or)}return new ks(n,e)}function xh(n){return new ks(n,[new qe(n)])}class Nh{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class nr{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class Vh{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class Ph{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class Uh{get type(){return"rule"}}class or{get type(){return"newline"}}class Pt{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class Dh{constructor(e,t,s,i,r){this.src=e,this.width=t,this.height=s,this.alt=i,this.title=r}get type(){return"image"}}class Bh{constructor(e,t,s){this.id=e,this.href=t,this.children=s}get type(){return"pill"}get avatarColorNumber(){return z(this.id)}get avatarInitials(){return H(this.id)}}class Es{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class qe{constructor(e){this.text=e}get type(){return"text"}}function Lh(n){return n.type==="format"&&n.format==="blockquote"}class ks{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&Lh(this.parts[t]);t++);this.parts.splice(t,0,new qe(e))}}const ct=se("Plain","Html");class ar extends we{constructor(e){super(e);this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return xh(e)}_getBodyFormat(){return ct.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const Kh=["EM","STRONG","CODE","DEL","SPAN"],Oh=["DIV","BLOCKQUOTE"],Fh=["https","http","ftp","mailto","magnet"].map(n=>`${n}://`),$h="https://matrix.to",cr=`${$h}/#/`;class qh{constructor(e,t){this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(cr))return null;const t=e.substring(cr.length);return t[0]==="@"?t:null}parseLink(e,t){const s=this.result.getAttributeValue(e,"href"),i=s==null?void 0:s.toLowerCase();if(!i||!Fh.some(o=>i.startsWith(o)))return new Pt("span",t);const r=this.parsePillLink(s);return r?new Bh(r,s,t):new Es(s,t)}parseList(e){const t=this.result;let s=null;t.getNodeElementName(e)==="OL"&&(s=parseInt(t.getAttributeValue(e,"start"))||1);const i=[];for(const r of t.getChildNodes(e)){if(t.getNodeElementName(r)!=="LI")continue;const o=this.parseAnyNodes(t.getChildNodes(r));i.push(o)}return new Vh(s,i)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let s;for(const o of t.getChildNodes(e)){s=o;break}let i=null;if(!this._ensureElement(s,"CODE"))return new nr(i,this.result.getNodeText(e));const r=t.getAttributeValue(s,"class")||"";for(const o of r.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){i=o.substring(9);break}return new nr(i,this.result.getNodeText(s))}parseImage(e){const t=this.result,s=t.getAttributeValue(e,"src")||"",i=this.mediaRepository.mxcUrl(s);if(!i)return null;const r=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),c=t.getAttributeValue(e,"title");return new Dh(i,r,o,a,c)}parseTableRow(e,t){const s=[];for(const i of this.result.getChildNodes(e)){if(!this._ensureElement(i,t))continue;const r=this.result.getChildNodes(i),o=this.parseInlineNodes(r);s.push(o)}return s}parseTableHead(e){let t=null;for(const s of this.result.getChildNodes(e)){t=s;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const s of this.result.getChildNodes(e))!this._ensureElement(s,"TR")||t.push(this.parseTableRow(s,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let s,i;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(s=this.parseTableHead(t[0]),i=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(s=null,i=this.parseTableBody(t[0])),new Ph(s,i)}parseInlineElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"A":{const r=this.parseInlineNodes(i);return this.parseLink(e,r)}case"BR":return new or;default:{if(!Kh.includes(s))return null;const r=this.parseInlineNodes(i);return new Pt(s,r)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const r=this.parseInlineNodes(i);return new Nh(parseInt(s[1]),r)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new Uh;case"IMG":return this.parseImage(e);case"P":{const r=this.parseInlineNodes(i);return new Pt(s,r)}case"TABLE":return this.parseTable(e);default:{if(!Oh.includes(s))return null;const r=this.parseAnyNodes(i);return new Pt(s,r)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;const s=(i,r)=>{r?t.push(new Es(i,[new qe(i)])):t.push(new qe(i))};return rr(this.result.getNodeText(e),s),!0}_isAllowedNode(e){return!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseInlineNodes(this.result.getChildNodes(s),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s)||this.parseBlockNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseAnyNodes(this.result.getChildNodes(s),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}function jh(n,e,t){const s=n.parseHTML(t),r=new qh(s,e).parseAnyNodes(s.rootNodes);return new ks(t,r)}class Wh extends ar{_getContentString(e){var t;return((t=this._getContent())==null?void 0:t[e])||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===ct.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){var e;return((e=this._getContent())==null?void 0:e.format)==="org.matrix.custom.html"?ct.Html:ct.Plain}_parseBody(e,t){var i;let s;return t===ct.Html?s=jh(this.platform,this._mediaRepository,e):s=Ah(e),((i=this._getContent())==null?void 0:i.msgtype)==="m.emote"&&s.insertEmote(`* ${this.displayName} `),s}}class hr extends we{get shape(){return"redacted"}get description(){const{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})…`:this.i18n`This message is being deleted…`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}}const Hh=300,zh=400;class lr extends we{constructor(e){super(e);this._decryptedThumbnail=null,this._decryptedFile=null,this._isVisible=!1,this._error=null}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===v.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get sendStatus(){const{pendingEvent:e}=this._entry;switch(e==null?void 0:e.status){case v.Waiting:return this.i18n`Waiting…`;case v.EncryptingAttachments:case v.Encrypting:return this.i18n`Encrypting…`;case v.UploadingAttachments:return this.i18n`Uploading…`;case v.Sending:return this.i18n`Sending…`;case v.Error:return this.i18n`Error: ${e.error.message}`;default:return""}}get thumbnailUrl(){var e,t;if(!this._isVisible)return"";if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const s=(e=this._getContent().info)==null?void 0:e.thumbnail_url;if(s)return this._mediaRepository.mxcUrlThumbnail(s,this.width,this.height,"scale")}if(this._entry.isPending){const s=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return s&&s.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const s=(t=this._getContent())==null?void 0:t.url;if(typeof s=="string")return this._mediaRepository.mxcUrlThumbnail(s,this.width,this.height,"scale")}}return""}notifyVisible(){super.notifyVisible(),this._isVisible=!0,this.emitChange("thumbnailUrl"),this.isPending||this._tryLoadEncryptedThumbnail()}get width(){var t;const e=(t=this._getContent())==null?void 0:t.info;return Math.round((e==null?void 0:e.w)*this._scaleFactor())}get height(){var t;const e=(t=this._getContent())==null?void 0:t.info;return Math.round((e==null?void 0:e.h)*this._scaleFactor())}get mimeType(){var t;const e=(t=this._getContent())==null?void 0:t.info;return e==null?void 0:e.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){var e;try{const t=(e=this._getContent().info)==null?void 0:e.thumbnail_file,s=this._getContent().file;t?(this._decryptedThumbnail=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl")):s&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(s),this.emitChange("thumbnailUrl"))}catch(t){this._error=t,this.emitChange("error")}}_scaleFactor(){var i;const e=(i=this._getContent())==null?void 0:i.info,t=Hh/(e==null?void 0:e.h),s=zh/(e==null?void 0:e.w);return Math.min(s,t,1)}_isMainResourceImage(){return!0}}class Gh extends lr{constructor(e){super(e);this._lightboxUrl=this.urlCreator.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class Jh extends lr{async loadVideo(){const e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){var t;if(this._decryptedFile)return this._decryptedFile.url;const e=(t=this._getContent())==null?void 0:t.url;return typeof e=="string"?this._mediaRepository.mxcUrl(e):""}get shape(){return"video"}_isMainResourceImage(){return!1}}function Qh(n,e=2){if(Number.isSafeInteger(n)){const t=Math.min(3,Math.floor(Math.log(n)/Math.log(1024))),s=Math.round(n/Math.pow(1024,t)).toFixed(e);switch(t){case 0:return`${s} bytes`;case 1:return`${s} KB`;case 2:return`${s} MB`;case 3:return`${s} GB`}}return""}class Yh extends we{constructor(e){super(e);this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("label");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s==null||s.dispose(),this._downloading=!1}this.emitChange("label")}get label(){var s;if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;const t=this._getContent().body;if(this._entry.isPending){const{pendingEvent:i}=this._entry;switch(i==null?void 0:i.status){case v.Waiting:return this.i18n`Waiting to send ${t}…`;case v.EncryptingAttachments:case v.Encrypting:return this.i18n`Encrypting ${t}…`;case v.UploadingAttachments:{const r=Math.round(i.attachmentsSentBytes/i.attachmentsTotalBytes*100);return this.i18n`Uploading ${t}: ${r}%`}case v.Sending:case v.Sent:return this.i18n`Sending ${t}…`;case v.Error:return this.i18n`Error: could not send ${t}: ${i.error.message}`;default:return`Unknown send status for ${t}`}}else{const i=Qh((s=this._getContent().info)==null?void 0:s.size);return this._downloading?this.i18n`Downloading ${t} (${i})…`:this.i18n`Download ${t} (${i})`}}get shape(){return"file"}}class Xh extends we{get shape(){return"location"}get mapsLink(){try{const e=new URL(this._getContent().geo_uri);if(e.protocol!=="geo:")return"";const[t,...s]=e.pathname.split(";"),[i,r]=t.split(","),o=parseFloat(i),a=parseFloat(r);let c;for(const h of s){const[l,d]=h.split("=");l==="u"&&(c=parseFloat(d))}if(this.platform.isIOS)return`http://maps.apple.com/?ll=${o},${a}`;{let h=`geo:${o},${a}`;return c&&(h=h+`;u=${c}`),h}}catch{return""}}get label(){return this.i18n`${this.displayName} sent their location`}}class Zh extends at{get shape(){return"announcement"}get announcement(){const e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e==null?void 0:e.name}"`}}class el extends at{get shape(){return"announcement"}get announcement(){var h,l;const{sender:e,content:t,prevContent:s,stateKey:i}=this._entry,r=this._entry.displayName||e,o=e===i?r:((h=this._entry.content)==null?void 0:h.displayname)||i,a=t&&t.membership,c=s&&s.membership;if(c==="join"&&a==="join"){if(t.avatar_url!==s.avatar_url)return`${r} changed their avatar`;if(t.displayname!==s.displayname)return t.displayname?`${(l=s.displayname)!=null?l:i} changed their name to ${t.displayname}`:`${i} removed their name (${s.displayname})`}else{if(a==="join")return`${o} joined the room`;if(a==="invite")return`${o} was invited to the room by ${r}`;if(c==="invite"){if(a==="join")return`${o} accepted the invitation to join the room`;if(a==="leave")return`${o} declined the invitation to join the room`}else if(a==="leave"){if(i===e)return`${o} left the room`;{const d=t.reason;return`${o} was kicked from the room by ${r}${d?`: ${d}`:""}`}}else if(a==="ban")return`${o} was banned from the room by ${r}`}return`${e} membership changed to ${t.membership}`}}class tl extends ar{updateEntry(e,t,s){const i=super.updateEntry(e,t,s);return e.eventType!=="m.room.encrypted"?te.Replace("shape"):i}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e==null?void 0:e.code;let s;return t==="MEGOLM_NO_SESSION"?s=this.i18n`The sender hasn't sent us the key for this message yet.`:s=(e==null?void 0:e.message)||this.i18n`Could not decrypt message because of unknown reason.`,s}}class sl extends at{get shape(){return"announcement"}get announcement(){const e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}}class il extends we{get shape(){return"missing-attachment"}get label(){const e=this._getContent().body;return this._getContent().msgtype==="m.image"?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}}function rl(n){return function t(s,i){const r=Object.assign({entry:s,emitUpdate:i,tilesCreator:t},n);if(s.isGap)return new Ih(r);if(s.isPending&&s.pendingEvent.isMissingAttachments)return new il(r);if(s.eventType)switch(s.eventType){case"m.room.message":{if(s.isRedacted)return new hr(r);const o=s.content;switch(o&&o.msgtype){case"m.text":case"m.notice":case"m.emote":return new Wh(r);case"m.image":return new Gh(r);case"m.video":return new Jh(r);case"m.file":return new Yh(r);case"m.location":return new Xh(r);default:return null}}case"m.room.name":return new Zh(r);case"m.room.member":return new el(r);case"m.room.encrypted":return s.isRedacted?new hr(r):new tl(r);case"m.room.encryption":return new sl(r);default:return null}}}function ht(n){return{w:n.width,h:n.height,mimetype:n.blob.mimeType,size:n.blob.size}}class dr extends w{constructor(e){super(e);const{room:t}=e;this._room=t,this._timelineVM=null,this._tilesCreator=null,this._onRoomChange=this._onRoomChange.bind(this),this._timelineError=null,this._sendError=null,this._composerVM=null,t.isArchived?this._composerVM=new ol(this.childOptions({archivedRoom:t})):this._composerVM=new Sh(this),this._clearUnreadTimout=null,this._closeUrl=this.urlCreator.urlUntilSegment("session")}async load(){this._room.on("change",this._onRoomChange);try{const e=await this._room.openTimeline();this._tilesCreator=rl(this.childOptions({roomVM:this,timeline:e})),this._timelineVM=this.track(new bh(this.childOptions({tilesCreator:this._tilesCreator,timeline:e}))),this.emitChange("timelineViewModel")}catch(e){console.error(`room.openTimeline(): ${e.message}:
${e.stack}`),this._timelineError=e,this.emitChange("error")}this._clearUnreadAfterDelay()}async _clearUnreadAfterDelay(){if(!(this._room.isArchived||this._clearUnreadTimout)){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(),this._clearUnreadTimout=null}catch(e){if(e.name!=="AbortError")throw e}}}focus(){this._clearUnreadAfterDelay()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){this._composerVM.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get error(){return this._timelineError?`Something went wrong loading the timeline: ${this._timelineError.message}`:this._sendError?`Something went wrong sending your message: ${this._sendError.message}`:""}get avatarLetter(){return H(this.name)}get avatarColorNumber(){return z(this._room.avatarColorId)}avatarUrl(e){return ce(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){return this._tilesCreator(e)}async _sendMessage(e,t){if(!this._room.isArchived&&e){try{let s="m.text";e.startsWith("/me ")&&(e=e.substr(4).trim(),s="m.emote"),t?await t.reply(s,e):await this._room.sendEvent("m.room.message",{msgtype:s,body:e})}catch(s){return console.error(`room.sendMessage(): ${s.message}:
${s.stack}`),this._sendError=s,this._timelineError=null,this.emitChange("error"),!1}return!0}return!1}async _pickAndSendFile(){try{const e=await this.platform.openFile();return e?this._sendFile(e):void 0}catch(e){console.error(e)}}async _sendFile(e){const t={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",t,{url:this._room.createAttachment(e.blob,e.name)})}async _pickAndSendVideo(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const e=await this.platform.openFile("video/*");if(!e)return;if(!e.blob.mimeType.startsWith("video/"))return this._sendFile(e);let t;try{t=await this.platform.loadVideo(e.blob)}catch(c){throw c instanceof window.MediaError&&c.code===4?new Error(`this browser does not support videos of type ${e==null?void 0:e.blob.mimeType}.`):c}const s={body:e.name,msgtype:"m.video",info:nl(t)},i={url:this._room.createAttachment(t.blob,e.name)},o=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(t.maxDimension,800),a=await t.scale(o);s.info.thumbnail_info=ht(a),i["info.thumbnail_url"]=this._room.createAttachment(a.blob,e.name),await this._room.sendEvent("m.room.message",s,i)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}async _pickAndSendPicture(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const e=await this.platform.openFile("image/*");if(!e)return;if(!e.blob.mimeType.startsWith("image/"))return this._sendFile(e);let t=await this.platform.loadImage(e.blob);const s=await this.platform.settingsStorage.getInt("sentImageSizeLimit");if(s&&t.maxDimension>s){const o=await t.scale(s);t.dispose(),t=o}const i={body:e.name,msgtype:"m.image",info:ht(t)},r={url:this._room.createAttachment(t.blob,e.name)};if(t.maxDimension>600){const o=await t.scale(400);i.info.thumbnail_info=ht(o),r["info.thumbnail_url"]=this._room.createAttachment(o.blob,e.name)}await this._room.sendEvent("m.room.message",i,r)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}get room(){return this._room}get composerViewModel(){return this._composerVM}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}}function nl(n){const e=ht(n);return e.duration=n.duration,e}class ol extends w{constructor(e){super(e);this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"archived"}}class al extends w{constructor(e){super(e);const{roomIdOrAlias:t,session:s}=e;this._session=s,this.roomIdOrAlias=t,this._error=null,this._busy=!1}get error(){var e;return(e=this._error)==null?void 0:e.message}async join(){this._busy=!0,this.emitChange("busy");try{const e=await this._session.joinRoom(this.roomIdOrAlias);this.navigation.push("room",e)}catch(e){this._error=e,this._busy=!1,this.emitChange("error")}}get busy(){return this._busy}get kind(){return"unknown"}}class cl extends w{constructor(e){super(e);const{invite:t,mediaRepository:s}=e;this._invite=t,this._mediaRepository=s,this._onInviteChange=this._onInviteChange.bind(this),this._error=null,this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._invite.on("change",this._onInviteChange),this._inviter=null,this._invite.inviter&&(this._inviter=new hl(this._invite.inviter,s,this.platform)),this._roomDescription=this._createRoomDescription()}get kind(){return"invite"}get closeUrl(){return this._closeUrl}get name(){return this._invite.name}get id(){return this._invite.id}get isEncrypted(){return this._invite.isEncrypted}get isDirectMessage(){return this._invite.isDirectMessage}get inviter(){return this._inviter}get busy(){return this._invite.accepting||this._invite.rejecting}get error(){return this._error?`Something went wrong: ${this._error.message}`:""}get avatarLetter(){return H(this.name)}get avatarColorNumber(){return z(this._invite.avatarColorId)}avatarUrl(e){return ce(this._invite.avatarUrl,e,this.platform,this._mediaRepository)}_createRoomDescription(){const e=[];return this._invite.isPublic?e.push("Public room"):e.push("Private room"),this._invite.canonicalAlias&&e.push(this._invite.canonicalAlias),e.join(" \u2022 ")}get roomDescription(){return this._roomDescription}get avatarTitle(){return this.name}focus(){}async accept(){try{await this._invite.accept()}catch(e){this._error=e,this.emitChange("error")}}async reject(){try{await this._invite.reject()}catch(e){this._error=e,this.emitChange("error")}}_onInviteChange(){this.emitChange()}dispose(){super.dispose(),this._invite.off("change",this._onInviteChange)}}class hl{constructor(e,t,s){this._member=e,this._mediaRepository=t,this._platform=s}get id(){return this._member.userId}get name(){return this._member.name}get avatarLetter(){return H(this.name)}get avatarColorNumber(){return z(this._member.userId)}avatarUrl(e){return ce(this._member.avatarUrl,e,this._platform,this._mediaRepository)}get avatarTitle(){return this.name}}class ll extends w{constructor(e){super(e);const{roomBeingCreated:t,mediaRepository:s}=e;this._roomBeingCreated=t,this._mediaRepository=s,this._onRoomChange=this._onRoomChange.bind(this),this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._roomBeingCreated.on("change",this._onRoomChange)}get kind(){return"roomBeingCreated"}get closeUrl(){return this._closeUrl}get name(){return this._roomBeingCreated.name}get id(){return this._roomBeingCreated.id}get isEncrypted(){return this._roomBeingCreated.isEncrypted}get error(){const{error:e}=this._roomBeingCreated;return e?e.name==="ConnectionError"?this.i18n`You seem to be offline`:e.message:""}get avatarLetter(){return H(this.name)}get avatarColorNumber(){return z(this._roomBeingCreated.avatarColorId)}get avatarTitle(){return this.name}avatarUrl(e){var t;return(t=this._roomBeingCreated.avatarBlobUrl)!=null?t:ce(this._roomBeingCreated.avatarUrl,e,this.platform,this._mediaRepository)}focus(){}_onRoomChange(){this.emitChange()}cancel(){this._roomBeingCreated.cancel(),this.navigation.applyPath(this.navigation.path.until("session"))}dispose(){super.dispose(),this._roomBeingCreated.off("change",this._onRoomChange)}}class dl extends w{constructor(e){super(e);this._eventId=e.eventId,this._unencryptedImageUrl=null,this._decryptedImage=null,this._closeUrl=this.urlCreator.urlUntilSegment("room"),this._eventEntry=null,this._date=null,this._subscribeToEvent(e.room,e.eventId)}_subscribeToEvent(e,t){const s=e.observeEvent(t);this.track(s.subscribe(i=>{this._loadEvent(e,i)})),this._loadEvent(e,s.get())}async _loadEvent(e,t){if(!t)return;const{mediaRepository:s}=e;this._eventEntry=t;const{content:i}=this._eventEntry;this._date=this._eventEntry.timestamp?new Date(this._eventEntry.timestamp):null,i.url?(this._unencryptedImageUrl=s.mxcUrl(i.url),this.emitChange("imageUrl")):i.file&&(this._decryptedImage=this.track(await s.downloadEncryptedFile(i.file)),this.emitChange("imageUrl"))}get imageWidth(){var e,t,s;return(s=(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.info)==null?void 0:s.w}get imageHeight(){var e,t,s;return(s=(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.info)==null?void 0:s.h}get name(){var e,t;return(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.body}get sender(){var e;return(e=this._eventEntry)==null?void 0:e.displayName}get imageUrl(){return this._decryptedImage?this._decryptedImage.url:this._unencryptedImageUrl?this._unencryptedImageUrl:""}get date(){return this._date&&this._date.toLocaleDateString({},{weekday:"long",year:"numeric",month:"long",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get closeUrl(){return this._closeUrl}close(){this.platform.history.pushUrl(this.closeUrl)}}const V=se("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");class ul extends w{constructor(e){super(e);const{sync:t,reconnector:s,session:i}=e;this._sync=t,this._reconnector=s,this._status=this._calculateState(s.connectionStatus.get(),t.status.get()),this._session=i,this._setupKeyBackupUrl=this.urlCreator.urlForSegment("settings"),this._dismissSecretStorage=!1}start(){const e=()=>this._updateStatus();this.track(this._sync.status.subscribe(e)),this.track(this._reconnector.connectionStatus.subscribe(e)),this.track(this._session.needsKeyBackup.subscribe(()=>{this.emitChange()}))}get setupKeyBackupUrl(){return this._setupKeyBackupUrl}get isShown(){return this._session.needsKeyBackup.get()&&!this._dismissSecretStorage||this._status!==V.Syncing}get statusLabel(){switch(this._status){case V.Disconnected:{const e=Math.round(this._reconnector.retryIn/1e3);return this.i18n`Disconnected, trying to reconnect in ${e}s…`}case V.Connecting:return this.i18n`Trying to reconnect now…`;case V.FirstSync:return this.i18n`Catching up with your conversations…`;case V.SyncError:return this.i18n`Sync failed because of ${this._sync.error}`}return this._session.needsKeyBackup.get()?this.i18n`Set up session backup to decrypt older messages.`:""}get isWaiting(){switch(this._status){case V.Connecting:case V.FirstSync:return!0;default:return!1}}_updateStatus(){const e=this._calculateState(this._reconnector.connectionStatus.get(),this._sync.status.get());e!==this._status&&(e===V.Disconnected?this._retryTimer=this.track(this.clock.createInterval(()=>{this.emitChange("statusLabel")},1e3)):this._retryTimer=this.disposeTracked(this._retryTimer),this._status=e,this.emitChange())}_calculateState(e,t){if(e!==De.Online)switch(e){case De.Reconnecting:return V.Connecting;case De.Waiting:return V.Disconnected}else if(t!==S.Syncing)switch(t){case S.InitialSync:case S.CatchupSync:return V.FirstSync;case S.Stopped:return V.SyncError}else return V.Syncing}get isConnectNowShown(){return this._status===V.Disconnected}get isSecretStorageShown(){return this._status===V.Syncing&&this._session.needsKeyBackup.get()&&!this._dismissSecretStorage}get canDismiss(){return this.isSecretStorageShown}dismiss(){this.isSecretStorageShown&&(this._dismissSecretStorage=!0,this.emitChange())}connectNow(){this.isConnectNowShown&&this._reconnector.tryNow()}}function ur(n){return n.map((e,t)=>{if(!n.slice(0,t).includes(e))return e})}class ml extends w{constructor(e){super(e);this._width=e.width,this._height=e.height,this._createRoomViewModelObservable=e.createRoomViewModelObservable,this._selectedIndex=0,this._viewModelsObservables=[],this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("empty-grid-tile");this.track(e.subscribe(s=>{typeof s=="number"&&this._setFocusIndex(s)})),typeof e.get()=="number"&&(this._selectedIndex=e.get());const t=this.navigation.observe("room");this.track(t.subscribe(s=>{s&&this._setFocusRoom(s)}))}roomViewModelAt(e){var t;return(t=this._viewModelsObservables[e])==null?void 0:t.get()}get focusIndex(){return this._selectedIndex}get width(){return this._width}get height(){return this._height}_switchToRoom(e){let t=this.navigation.path.until("rooms");t=t.with(this.navigation.segment("room",e)),t=Is(this.navigation,t),this.navigation.applyPath(t)}focusTile(e){if(e===this._selectedIndex)return;const t=this._viewModelsObservables[e];t?this._switchToRoom(t.id):this.navigation.push("empty-grid-tile",e)}initializeRoomIdsAndTransferVM(e,t){e=ur(e);let s=!1;if(t){const r=e.indexOf(t.id);r!==-1&&(this._viewModelsObservables[r]=this.track(t),t.subscribe(o=>this._refreshRoomViewModel(o)),s=!0)}this.setRoomIds(e);const i=this.navigation.path.get("room");if(i){const r=this._viewModelsObservables.findIndex(o=>o&&o.id===i.value);r!==-1&&(this._selectedIndex=r)}return s}setRoomIds(e){e=ur(e);let t=!1;const s=this._height*this._width;for(let i=0;i<s;i+=1){const r=e[i],o=this._viewModelsObservables[i];if(!o&&r||o&&o.id!==r){if(o&&(this._viewModelsObservables[i]=this.disposeTracked(o)),r){const a=this._createRoomViewModelObservable(r);this._viewModelsObservables[i]=this.track(a),a.subscribe(c=>this._refreshRoomViewModel(c)),a.initialize()}t=!0}}return t&&this.emitChange(),t}_refreshRoomViewModel(e){this.emitChange(),e==null||e.focus()}releaseRoomViewModel(e){const t=this._viewModelsObservables.findIndex(s=>s&&s.id===e);if(t!==-1){const s=this._viewModelsObservables[t];return this.untrack(s),s.unsubscribeAll(),this._viewModelsObservables[t]=null,s}}_setFocusIndex(e){var s;if(e===this._selectedIndex||e>=this._width*this._height)return;this._selectedIndex=e;const t=this._viewModelsObservables[this._selectedIndex];(s=t==null?void 0:t.get())==null||s.focus(),this.emitChange("focusIndex")}_setFocusRoom(e){const t=this._viewModelsObservables.findIndex(s=>(s==null?void 0:s.id)===e);t>=0&&this._setFocusIndex(t)}}const D=se("Enabled","SetupKey","SetupPhrase","Pending","NewVersionAvailable"),lt=se("Writing","Stopped","Done","Pending");class _l extends w{constructor(e){super(e);this._session=e.session,this._error=null,this._isBusy=!1,this._dehydratedDeviceId=void 0,this._status=void 0,this._backupOperation=this._session.keyBackup.flatMap(t=>t.operationInProgress),this._progress=this._backupOperation.flatMap(t=>t.progress),this.track(this._backupOperation.subscribe(()=>{this._reevaluateStatus(),this.emitChange("isBackingUp")})),this.track(this._progress.subscribe(()=>this.emitChange("backupPercentage"))),this._reevaluateStatus(),this.track(this._session.keyBackup.subscribe(()=>{this._reevaluateStatus()&&this.emitChange("status")}))}_reevaluateStatus(){if(this._isBusy)return!1;let e;const t=this._session.keyBackup.get();t?e=t.needsNewKey?D.NewVersionAvailable:D.Enabled:t===null?e=this.showPhraseSetup()?D.SetupPhrase:D.SetupKey:e=D.Pending;const s=e!==this._status;return this._status=e,s}get decryptAction(){return this.i18n`Set up`}get purpose(){return this.i18n`set up key backup`}offerDehydratedDeviceSetup(){return!0}get dehydratedDeviceId(){return this._dehydratedDeviceId}get isBusy(){return this._isBusy}get backupVersion(){var e;return(e=this._session.keyBackup.get())==null?void 0:e.version}get backupWriteStatus(){const e=this._session.keyBackup.get();if(e){if(e.hasStopped)return lt.Stopped}else return lt.Pending;return e.operationInProgress.get()?lt.Writing:e.hasBackedUpAllKeys?lt.Done:lt.Pending}get backupError(){var e,t;return(t=(e=this._session.keyBackup.get())==null?void 0:e.error)==null?void 0:t.message}get status(){return this._status}get error(){var e;return(e=this._error)==null?void 0:e.message}showPhraseSetup(){this._status===D.SetupKey&&(this._status=D.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===D.SetupPhrase&&(this._status=D.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t,s){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const i=await this._session.enableSecretStorage(e,t);s&&(this._dehydratedDeviceId=await this._session.setupDehydratedDevice(i))}catch(i){console.error(i),this._error=i,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}enterSecurityPhrase(e,t){this._enterCredentials($e.Passphrase,e,t)}enterSecurityKey(e,t){this._enterCredentials($e.RecoveryKey,e,t)}async disable(){try{this._isBusy=!0,this.emitChange("isBusy"),await this._session.disableSecretStorage()}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}get isBackingUp(){return!!this._backupOperation.get()}get backupPercentage(){const e=this._progress.get();return e?Math.round(e.finished/e.total*100):0}get backupInProgressLabel(){const e=this._progress.get();return e?this.i18n`${e.finished} of ${e.total}`:this.i18n`…`}cancelBackup(){var e;(e=this._backupOperation.get())==null||e.abort()}startBackup(){var e;(e=this._session.keyBackup.get())==null||e.flush()}}class pl{constructor(){this.supported=null,this.enabled=!1,this.updating=!1,this.enabledOnServer=null,this.serverError=null}}function gl(n){const e=4,t=Math.ceil(n.length/e);let s="";for(let i=0;i<t;i+=1)s+=(s.length?" ":"")+n.slice(i*e,(i+1)*e);return s}class fl extends w{constructor(e){super(e);this._updateService=e.updateService;const{client:t}=e;this._client=t,this._keyBackupViewModel=this.track(new _l(this.childOptions({session:this._session}))),this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._estimate=null,this.sentImageSizeLimit=null,this.minSentImageSizeLimit=400,this.maxSentImageSizeLimit=4e3,this.pushNotifications=new pl}get _session(){return this._client.session}async logout(){this.navigation.push("logout",this._client.sessionId)}setSentImageSizeLimit(e){e>this.maxSentImageSizeLimit||e<this.minSentImageSizeLimit?(this.sentImageSizeLimit=null,this.platform.settingsStorage.remove("sentImageSizeLimit")):(this.sentImageSizeLimit=Math.round(e),this.platform.settingsStorage.setInt("sentImageSizeLimit",e)),this.emitChange("sentImageSizeLimit")}async load(){this._estimate=await this.platform.estimateStorageUsage(),this.sentImageSizeLimit=await this.platform.settingsStorage.getInt("sentImageSizeLimit"),this.pushNotifications.supported=await this.platform.notificationService.supportsPush(),this.pushNotifications.enabled=await this._session.arePushNotificationsEnabled(),this.emitChange("")}get closeUrl(){return this._closeUrl}get fingerprintKey(){const e=this._session.fingerprintKey;return e?gl(e):null}get deviceId(){return this._session.deviceId}get userId(){return this._session.userId}get version(){const{updateService:e}=this.platform;return e?`${e.version} (${e.buildHash})`:this.i18n`development version`}checkForUpdate(){var e;(e=this.platform.updateService)==null||e.checkForUpdate()}get showUpdateButton(){return!!this.platform.updateService}get keyBackupViewModel(){return this._keyBackupViewModel}get storageQuota(){var e;return this._formatBytes((e=this._estimate)==null?void 0:e.quota)}get storageUsage(){var e;return this._formatBytes((e=this._estimate)==null?void 0:e.usage)}_formatBytes(e){return typeof e=="number"?Math.round(e/(1024*1024)).toFixed(1)+" MB":this.i18n`unknown`}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async togglePushNotifications(){this.pushNotifications.updating=!0,this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null,this.emitChange("pushNotifications.updating");try{await this._session.enablePushNotifications(!this.pushNotifications.enabled)&&(this.pushNotifications.enabled=!this.pushNotifications.enabled,this.pushNotifications.enabled&&this.platform.notificationService.showNotification(this.i18n`Push notifications are now enabled`))}finally{this.pushNotifications.updating=!1,this.emitChange("pushNotifications.updating")}}async checkPushEnabledOnServer(){this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null;try{this.pushNotifications.enabledOnServer=await this._session.checkPusherEnabledOnHomeserver(),this.emitChange("pushNotifications.enabledOnServer")}catch(e){this.pushNotifications.serverError=e,this.emitChange("pushNotifications.serverError")}}}class yl extends w{constructor(e){super(e);const{session:t}=e;this._session=t,this._name=void 0,this._topic=void 0,this._roomAlias=void 0,this._isPublic=!1,this._isEncrypted=!0,this._isAdvancedShown=!1,this._isFederationDisabled=!1,this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0}get isPublic(){return this._isPublic}get isEncrypted(){return this._isEncrypted}get canCreate(){return!!this._name}avatarUrl(){return this._avatarScaledBlob.url}get avatarTitle(){return this._name}get avatarLetter(){return""}get avatarColorNumber(){return 0}get hasAvatar(){return!!this._avatarScaledBlob}get isFederationDisabled(){return this._isFederationDisabled}get isAdvancedShown(){return this._isAdvancedShown}setName(e){this._name=e,this.emitChange("canCreate")}setRoomAlias(e){this._roomAlias=e}setTopic(e){this._topic=e}setPublic(e){this._isPublic=e,this.emitChange("isPublic")}setEncrypted(e){this._isEncrypted=e,this.emitChange("isEncrypted")}setFederationDisabled(e){this._isFederationDisabled=e,this.emitChange("isFederationDisabled")}toggleAdvancedShown(){this._isAdvancedShown=!this._isAdvancedShown,this.emitChange("isAdvancedShown")}create(){var s,i;let e;this._avatarScaledBlob&&(e={info:this._avatarInfo,name:this._avatarFileName,blob:this._avatarScaledBlob});const t=this._session.createRoom({type:this.isPublic?L.Public:L.Private,name:(s=this._name)!=null?s:void 0,topic:(i=this._topic)!=null?i:void 0,isEncrypted:!this.isPublic&&this._isEncrypted,isFederationDisabled:this._isFederationDisabled,alias:this.isPublic?wl(this._roomAlias):void 0,avatar:e});this.navigation.push("room",t.id)}async selectAvatar(){if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}this._avatarScaledBlob&&this._avatarScaledBlob.dispose(),this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0;const e=await this.platform.openFile("image/*");if(!e||!e.blob.mimeType.startsWith("image/")){this.emitChange("hasAvatar");return}let t=await this.platform.loadImage(e.blob);const s=800;if(t.maxDimension>s){const i=await t.scale(s);t.dispose(),t=i}this._avatarScaledBlob=t.blob,this._avatarInfo=ht(t),this._avatarFileName=e.name,this.emitChange("hasAvatar")}}function wl(n){n.startsWith("#")&&(n=n.substr(1));const e=n.indexOf(":");return e!==-1&&(n=n.substr(0,e)),n}class mr extends Q{constructor(e,t){super(null);this._statusSubscription=null,this._sessionViewModel=e,this.id=t}async initialize(){const{session:e}=this._sessionViewModel._client,t=await e.observeRoomStatus(this.id);this.set(await this._statusToViewModel(t.get())),this._statusSubscription=t.subscribe(async s=>{var i;(i=this.get())==null||i.dispose(),this.set(await this._statusToViewModel(s))})}async _statusToViewModel(e){if(e&k.Replaced)if(e&k.BeingCreated){const{session:t}=this._sessionViewModel._client,s=t.roomsBeingCreated.get(this.id);this._sessionViewModel.notifyRoomReplaced(s.id,s.roomId)}else throw new Error("Don't know how to replace a room with this status: "+(e^k.Replaced));else return e&k.BeingCreated?this._sessionViewModel._createRoomBeingCreatedViewModel(this.id):e&k.Invited?this._sessionViewModel._createInviteViewModel(this.id):e&k.Joined?this._sessionViewModel._createRoomViewModelInstance(this.id):e&k.Archived?await this._sessionViewModel._createArchivedRoomViewModel(this.id):this._sessionViewModel._createUnknownRoomViewModel(this.id)}dispose(){var e;this._statusSubscription&&(this._statusSubscription=this._statusSubscription()),this.unsubscribeAll(),(e=this.get())==null||e.dispose()}}class vl extends w{constructor(e){super(e);this._room=e.room,this._onRoomChange=this._onRoomChange.bind(this),this._room.on("change",this._onRoomChange)}get type(){return"room-details"}get shouldShowBackButton(){return!1}get previousSegmentName(){return!1}get roomId(){return this._room.id}get canonicalAlias(){return this._room.canonicalAlias}get name(){return this._room.name}get isEncrypted(){return!!this._room.isEncrypted}get memberCount(){return this._room.joinedMemberCount}get avatarLetter(){return H(this.name)}get avatarColorNumber(){return z(this._room.avatarColorId)}avatarUrl(e){return ce(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}_onRoomChange(){this.emitChange()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange)}openPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}class bl extends w{constructor(e){super(e);this._member=this._options.member,this._mediaRepository=e.mediaRepository,this._previousName=null,this._nameChanged=!0}get name(){return`${this._member.name}${this._disambiguationPart}`}get _disambiguationPart(){return this._disambiguate?` (${this.userId})`:""}get userId(){return this._member.userId}get previousName(){return this._previousName}get nameChanged(){return this._nameChanged}get detailsUrl(){const e=this.navigation.path.get("room").value;return`${this.urlCreator.openRoomActionUrl(e)}/member/${this._member.userId}`}_updatePreviousName(e){const t=this._member.name;t!==e?(this._previousName=t,this._nameChanged=!0):this._nameChanged=!1}setDisambiguation(e){this._disambiguate=e,this.emitChange()}updateFrom(e){this._updatePreviousName(e.name),this._member=e}get avatarLetter(){return H(this.name)}get avatarColorNumber(){return z(this.userId)}avatarUrl(e){return ce(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}}function Sl(n){const e=new Intl.Collator,t=s=>s.charAt(0)==="@"?s.slice(1):s;return function(i,r){const o=n.getUserLevel(i.userId),a=n.getUserLevel(r.userId);if(o!==a)return a-o;const c=t(i.name),h=t(r.name);return e.compare(c,h)}}class Il{constructor(){this._map=new Map}_unDisambiguate(e,t){const s=t.indexOf(e);if(s!==-1){const[i]=t.splice(s,1);i.setDisambiguation(!1)}}_handlePreviousName(e){const t=e.previousName;if(typeof t!="string")return;const s=this._map.get(t);if(Array.isArray(s)){if(this._unDisambiguate(e,s),s.length===1){const i=s[0];i.setDisambiguation(!1),this._map.set(t,i)}}else this._map.delete(t)}_updateMap(e){const t=e.name,s=this._map.get(t);if(s){if(Array.isArray(s))return s.findIndex(i=>i.userId===e.userId)!==-1?void 0:(s.push(e),s);if(e.userId!==s.userId){const i=[s,e];return this._map.set(t,i),i}}else this._map.set(t,e)}disambiguate(e){if(!e.nameChanged)return;this._handlePreviousName(e);const t=this._updateMap(e);t==null||t.forEach(s=>s.setDisambiguation(!0))}}class El extends w{constructor(e){super(e);const t=e.members,s=e.powerLevelsObservable;this.track(s.subscribe(()=>{}));const i=s.get();this.memberTileViewModels=this._mapTileViewModels(t.members.filterValues(r=>r.membership==="join")).sortValues(Sl(i)),this.nameDisambiguator=new Il,this.mediaRepository=e.mediaRepository}get type(){return"member-list"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"details"}_mapTileViewModels(e){const t=(i,r)=>{const o=this.mediaRepository,a=new bl(this.childOptions({member:i,emitChange:r,mediaRepository:o}));return this.nameDisambiguator.disambiguate(a),a},s=(i,r,o)=>{i.updateFrom(o),this.nameDisambiguator.disambiguate(i)};return e.mapValues(t,s)}}class kl extends w{constructor(e){super(e);this._observableMember=e.observableMember,this._mediaRepository=e.mediaRepository,this._member=this._observableMember.get(),this._isEncrypted=e.isEncrypted,this._powerLevelsObservable=e.powerLevelsObservable,this._session=e.session,this.track(this._powerLevelsObservable.subscribe(()=>this._onPowerLevelsChange())),this.track(this._observableMember.subscribe(()=>this._onMemberChange()))}get name(){return this._member.name}get userId(){return this._member.userId}get type(){return"member-details"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"members"}get role(){return this.powerLevel>=100?this.i18n`Admin`:this.powerLevel>=50?this.i18n`Moderator`:this.powerLevel===0?this.i18n`Default`:this.i18n`Custom (${this.powerLevel})`}_onMemberChange(){this._member=this._observableMember.get(),this.emitChange("member")}_onPowerLevelsChange(){this.emitChange("role")}get avatarLetter(){return H(this.name)}get avatarColorNumber(){return z(this.userId)}avatarUrl(e){return ce(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}get isEncrypted(){return this._isEncrypted}get powerLevel(){var e;return(e=this._powerLevelsObservable.get())==null?void 0:e.getUserLevel(this._member.userId)}get linkToUser(){return`https://matrix.to/#/${encodeURIComponent(this._member.userId)}`}async openDirectMessage(){const e=this._session.findDirectMessageForUserId(this.userId);let t=e==null?void 0:e.id;t||(t=(await this._session.createRoom({type:L.DirectMessage,invites:[this.userId]})).id),this.navigation.push("room",t)}}class Rl extends w{constructor(e){super(e);this._room=e.room,this._session=e.session,this._members=null,this._setupNavigation()}get activeViewModel(){return this._activeViewModel}async _getMemberListArguments(){this._members||(this._members=await this._room.loadMemberList(),this.track(()=>this._members.release()));const e=this._room,t=await this._room.observePowerLevels();return{members:this._members,powerLevelsObservable:t,mediaRepository:e.mediaRepository}}async _getMemberDetailsArguments(){const t=this.navigation.path.get("member").value,s=await this._room.observeMember(t);if(!s)return!1;const i=this._room.isEncrypted,r=await this._room.observePowerLevels();return{observableMember:s,isEncrypted:i,powerLevelsObservable:r,mediaRepository:this._room.mediaRepository,session:this._session}}_setupNavigation(){this._hookUpdaterToSegment("details",vl,()=>({room:this._room})),this._hookUpdaterToSegment("members",El,()=>this._getMemberListArguments()),this._hookUpdaterToSegment("member",kl,()=>this._getMemberDetailsArguments(),()=>{const e=`${this.urlCreator.urlUntilSegment("room")}/members`;this.urlCreator.pushUrl(e)})}_hookUpdaterToSegment(e,t,s,i){const r=this.navigation.observe(e),o=this._setupUpdater(e,t,s,i);this.track(r.subscribe(o))}_setupUpdater(e,t,s,i){const r=async(o=!1)=>{var c;if(o||(this._activeViewModel=this.disposeTracked(this._activeViewModel)),!!((c=this.navigation.path.get(e))==null?void 0:c.value)){const h=await s();if(!h&&i){i();return}this._activeViewModel=this.track(new t(this.childOptions(h)))}this.emitChange("activeViewModel")};return r(!0),r}closePanel(){const e=this.navigation.path.until("room");this.navigation.applyPath(e)}showPreviousPanel(){const e=this.activeViewModel.previousSegmentName;if(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}}class Cl extends w{constructor(e){super(e);const{client:t}=e;this._client=this.track(t),this._sessionStatusViewModel=this.track(new ul(this.childOptions({sync:t.sync,reconnector:t.reconnector,session:t.session}))),this._leftPanelViewModel=this.track(new wh(this.childOptions({session:this._client.session}))),this._settingsViewModel=null,this._roomViewModelObservable=null,this._gridViewModel=null,this._createRoomViewModel=null,this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("rooms");this.track(e.subscribe(a=>{this._updateGrid(a)})),e.get()&&this._updateGrid(e.get());const t=this.navigation.observe("room");this.track(t.subscribe(a=>{this._gridViewModel||this._updateRoom(a),this._updateRightPanel()})),this._gridViewModel||this._updateRoom(t.get());const s=this.navigation.observe("settings");this.track(s.subscribe(a=>{this._updateSettings(a)})),this._updateSettings(s.get());const i=this.navigation.observe("create-room");this.track(i.subscribe(a=>{this._updateCreateRoom(a)})),this._updateCreateRoom(i.get());const r=this.navigation.observe("lightbox");this.track(r.subscribe(a=>{this._updateLightbox(a)})),this._updateLightbox(r.get());const o=this.navigation.observe("right-panel");this.track(o.subscribe(()=>this._updateRightPanel())),this._updateRightPanel()}get id(){return this._client.sessionId}start(){this._sessionStatusViewModel.start()}get activeMiddleViewModel(){var e;return((e=this._roomViewModelObservable)==null?void 0:e.get())||this._gridViewModel||this._settingsViewModel||this._createRoomViewModel}get roomGridViewModel(){return this._gridViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get sessionStatusViewModel(){return this._sessionStatusViewModel}get settingsViewModel(){return this._settingsViewModel}get currentRoomViewModel(){var e;return(e=this._roomViewModelObservable)==null?void 0:e.get()}get rightPanelViewModel(){return this._rightPanelViewModel}get createRoomViewModel(){return this._createRoomViewModel}_updateGrid(e){var i;const t=!(this._gridViewModel&&e),s=this.navigation.path.get("room");if(e)this._gridViewModel?this._gridViewModel.setRoomIds(e):(this._gridViewModel=this.track(new ml(this.childOptions({width:3,height:2,createRoomViewModelObservable:r=>new mr(this,r)}))),(i=this._roomViewModelObservable)==null||i.unsubscribeAll(),this._gridViewModel.initializeRoomIdsAndTransferVM(e,this._roomViewModelObservable)?this._roomViewModelObservable=this.untrack(this._roomViewModelObservable):this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)));else if(this._gridViewModel&&!e){if(s){const r=this._gridViewModel.releaseRoomViewModel(s.value);r&&(this._roomViewModelObservable=this.track(r),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}))}this._gridViewModel=this.disposeTracked(this._gridViewModel)}t&&this.emitChange("activeMiddleViewModel")}_createRoomViewModelInstance(e){const t=this._client.session.rooms.get(e);if(t){const s=new dr(this.childOptions({room:t}));return s.load(),s}return null}_createUnknownRoomViewModel(e){return new al(this.childOptions({roomIdOrAlias:e,session:this._client.session}))}async _createArchivedRoomViewModel(e){const t=await this._client.session.loadArchivedRoom(e);if(t){const s=new dr(this.childOptions({room:t}));return s.load(),s}return null}_createInviteViewModel(e){const t=this._client.session.invites.get(e);return t?new cl(this.childOptions({invite:t,mediaRepository:this._client.session.mediaRepository})):null}_createRoomBeingCreatedViewModel(e){const t=this._client.session.roomsBeingCreated.get(e);return t?new ll(this.childOptions({roomBeingCreated:t,mediaRepository:this._client.session.mediaRepository})):null}_updateRoom(e){var s;if(((s=this._roomViewModelObservable)==null?void 0:s.id)===e)return;if(this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)),!e){this.emitChange("activeMiddleViewModel");return}const t=new mr(this,e);this._roomViewModelObservable=this.track(t),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}),t.initialize()}_updateSettings(e){this._settingsViewModel&&(this._settingsViewModel=this.disposeTracked(this._settingsViewModel)),e&&(this._settingsViewModel=this.track(new fl(this.childOptions({client:this._client}))),this._settingsViewModel.load()),this.emitChange("activeMiddleViewModel")}_updateCreateRoom(e){this._createRoomViewModel&&(this._createRoomViewModel=this.disposeTracked(this._createRoomViewModel)),e&&(this._createRoomViewModel=this.track(new yl(this.childOptions({session:this._client.session})))),this.emitChange("activeMiddleViewModel")}_updateLightbox(e){if(this._lightboxViewModel&&(this._lightboxViewModel=this.disposeTracked(this._lightboxViewModel)),e){const t=this._roomFromNavigation();this._lightboxViewModel=this.track(new dl(this.childOptions({eventId:e,room:t})))}this.emitChange("lightboxViewModel")}get lightboxViewModel(){return this._lightboxViewModel}_roomFromNavigation(){var s;const e=(s=this.navigation.path.get("room"))==null?void 0:s.value;return this._client.session.rooms.get(e)}_updateRightPanel(){var t;if(this._rightPanelViewModel=this.disposeTracked(this._rightPanelViewModel),!!((t=this.navigation.path.get("right-panel"))==null?void 0:t.value)){const s=this._roomFromNavigation();this._rightPanelViewModel=this.track(new Rl(this.childOptions({room:s,session:this._client.session})))}this.emitChange("rightPanelViewModel")}notifyRoomReplaced(e,t){this.navigation.push("room",t)}}class Ml extends w{constructor(e){super();this._accountSetup=e,this._dehydratedDevice=void 0,this._decryptDehydratedDeviceViewModel=void 0,this._accountSetup.encryptedDehydratedDevice&&(this._decryptDehydratedDeviceViewModel=new Tl(this,t=>{this._dehydratedDevice=t,this._decryptDehydratedDeviceViewModel=void 0,this.emitChange("deviceDecrypted")}))}get decryptDehydratedDeviceViewModel(){return this._decryptDehydratedDeviceViewModel}get deviceDecrypted(){return!!this._dehydratedDevice}get dehydratedDeviceId(){return this._accountSetup.encryptedDehydratedDevice.deviceId}finish(){this._accountSetup.finish(this._dehydratedDevice)}}class Tl extends w{constructor(e,t){super();this._accountSetupViewModel=e,this._isBusy=!1,this._status=D.SetupKey,this._error=void 0,this._decryptedCallback=t}get decryptAction(){return this.i18n`Restore`}get purpose(){return this.i18n`claim your dehydrated device`}get offerDehydratedDeviceSetup(){return!1}get dehydratedDeviceId(){var e;return(e=this._accountSetupViewModel._dehydratedDevice)==null?void 0:e.deviceId}get isBusy(){return this._isBusy}get backupVersion(){return 0}get status(){return this._status}get error(){var e;return(e=this._error)==null?void 0:e.message}showPhraseSetup(){this._status===D.SetupKey&&(this._status=D.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===D.SetupPhrase&&(this._status=D.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const{encryptedDehydratedDevice:s}=this._accountSetupViewModel._accountSetup,i=await s.decrypt(e,t);this._decryptedCallback(i)}catch(s){console.error(s),this._error=s,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange("")}}enterSecurityPhrase(e){this._enterCredentials($e.Passphrase,e)}enterSecurityKey(e){this._enterCredentials($e.RecoveryKey,e)}disable(){}}class _r extends w{constructor(e){super(e);const{client:t,ready:s,homeserver:i,deleteSessionOnCancel:r}=e;this._client=t,this._ready=s,this._homeserver=i,this._deleteSessionOnCancel=r,this._loading=!1,this._error=null,this.backUrl=this.urlCreator.urlForSegment("session",!0),this._accountSetupViewModel=void 0}async start(){if(!this._loading)try{this._loading=!0,this.emitChange("loading"),this._waitHandle=this._client.loadStatus.waitFor(s=>(s===y.AccountSetup?this._accountSetupViewModel=new Ml(this._client.accountSetup):this._accountSetupViewModel=void 0,this.emitChange("loadLabel"),s===y.FirstSync&&this._client.sync.status.get()===S.CatchupSync||s===y.LoginFailed||s===y.Error||s===y.Ready));try{await this._waitHandle.promise}catch{return}const e=this._client.loadStatus.get(),t=this._client.loadError;if(e===y.FirstSync||e===y.Ready){const s=this._client;this._client=null,this._ready(s)}t&&console.error("session load error",t)}catch(e){this._error=e,console.error("error thrown during session load",e.stack)}finally{this._loading=!1,this.emitChange("loading")}}dispose(){this._client&&(this._client.dispose(),this._client=null),this._waitHandle&&(this._waitHandle.dispose(),this._waitHandle=null)}get loading(){const e=this._client;return e&&e.loadStatus.get()===y.AccountSetup?!1:this._loading}get loadLabel(){const e=this._client,t=this._getError();if(t||e&&e.loadStatus.get()===y.Error)return`Something went wrong: ${t&&t.message}.`;if(e)switch(e.loadStatus.get()){case y.QueryAccount:return"Querying account encryption setup\u2026";case y.AccountSetup:return"";case y.SessionSetup:return"Setting up your encryption keys\u2026";case y.Loading:return"Loading your conversations\u2026";case y.FirstSync:return"Getting your conversations from the server\u2026";default:return this._client.loadStatus.get()}return"Preparing\u2026"}_getError(){var e;return this._error||((e=this._client)==null?void 0:e.loadError)}get hasError(){return!!this._getError()}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async logout(){await this._client.logout(),this.navigation.push("session",!0)}get accountSetupViewModel(){return this._accountSetupViewModel}}class Al extends w{constructor(e){super(e);const{loginOptions:t,attemptLogin:s}=e;this._loginOptions=t,this._attemptLogin=s,this._isBusy=!1,this._errorMessage=""}get isBusy(){return this._isBusy}get errorMessage(){return this._errorMessage}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async login(e,t){this._errorMessage="",this.emitChange("errorMessage");const s=await this._attemptLogin(this._loginOptions.password(e,t));let i="";switch(s){case ae.Credentials:i=this.i18n`Your username and/or password don't seem to be correct.`;break;case ae.Connection:i=this.i18n`Can't connect to ${this._loginOptions.homeserver}.`;break;case ae.Unknown:i=this.i18n`Something went wrong while checking your login and password.`;break}i&&this._showError(i)}}class xl extends w{constructor(e){super(e);this._sso=e.loginOptions.sso,this._isBusy=!1}get isBusy(){return this._isBusy}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}async startSSOLogin(){await this.platform.settingsStorage.setString("sso_ongoing_login_homeserver",this._sso.homeserver);const e=this._sso.createSSORedirectURL(this.urlCreator.createSSOCallbackURL());this.platform.openUrl(e)}}class Nl extends w{constructor(e){super(e);const{loginToken:t,client:s,attemptLogin:i}=e;this._loginToken=t,this._client=s,this._attemptLogin=i,this._errorMessage="",this.performSSOLoginCompletion()}get errorMessage(){return this._errorMessage}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async performSSOLoginCompletion(){if(!this._loginToken)return;const e=await this.platform.settingsStorage.getString("sso_ongoing_login_homeserver");let t;try{t=await this._client.queryLogin(e).result}catch(r){this._showError(r.message);return}if(!t.token){this.navigation.push("session");return}const s=await this._attemptLogin(t.token(this._loginToken));let i="";switch(s){case ae.Credentials:i=this.i18n`Your login token is invalid.`;break;case ae.Connection:i=this.i18n`Can't connect to ${e}.`;break;case ae.Unknown:i=this.i18n`Something went wrong while checking your login token.`;break}i&&this._showError(i)}}class Vl extends w{constructor(e){super(e);const{ready:t,defaultHomeserver:s,loginToken:i}=e;this._ready=t,this._loginToken=i,this._client=new vs(this.platform),this._loginOptions=null,this._passwordLoginViewModel=null,this._startSSOLoginViewModel=null,this._completeSSOLoginViewModel=null,this._loadViewModel=null,this._loadViewModelSubscription=null,this._homeserver=s,this._queriedHomeserver=null,this._errorMessage="",this._hideHomeserver=!1,this._isBusy=!1,this._abortHomeserverQueryTimeout=null,this._abortQueryOperation=null,this._initViewModels()}get passwordLoginViewModel(){return this._passwordLoginViewModel}get startSSOLoginViewModel(){return this._startSSOLoginViewModel}get completeSSOLoginViewModel(){return this._completeSSOLoginViewModel}get homeserver(){return this._homeserver}get resolvedHomeserver(){var e;return(e=this._loginOptions)==null?void 0:e.homeserver}get errorMessage(){return this._errorMessage}get showHomeserver(){return!this._hideHomeserver}get loadViewModel(){return this._loadViewModel}get isBusy(){return this._isBusy}get isFetchingLoginOptions(){return!!this._abortQueryOperation}goBack(){this.navigation.push("session")}async _initViewModels(){this._loginToken?(this._hideHomeserver=!0,this._completeSSOLoginViewModel=this.track(new Nl(this.childOptions({client:this._client,attemptLogin:e=>this.attemptLogin(e),loginToken:this._loginToken}))),this.emitChange("completeSSOLoginViewModel")):await this.queryHomeserver()}_showPasswordLogin(){this._passwordLoginViewModel=this.track(new Al(this.childOptions({loginOptions:this._loginOptions,attemptLogin:e=>this.attemptLogin(e)}))),this.emitChange("passwordLoginViewModel")}_showSSOLogin(){this._startSSOLoginViewModel=this.track(new xl(this.childOptions({loginOptions:this._loginOptions}))),this.emitChange("startSSOLoginViewModel")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}_setBusy(e){var t,s;this._isBusy=e,(t=this._passwordLoginViewModel)==null||t.setBusy(e),(s=this._startSSOLoginViewModel)==null||s.setBusy(e),this.emitChange("isBusy")}async attemptLogin(e){this._setBusy(!0),this._client.startWithLogin(e,{inspectAccountSetup:!0});const t=this._client.loadStatus;return await t.waitFor(r=>r!==y.Login).promise,this._setBusy(!1),t.get()===y.LoginFailed?this._client.loginFailure:(this._hideHomeserver=!0,this.emitChange("hideHomeserver"),this._disposeViewModels(),this._createLoadViewModel(),null)}_createLoadViewModel(){this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription),this._loadViewModel=this.disposeTracked(this._loadViewModel),this._loadViewModel=this.track(new _r(this.childOptions({ready:e=>{this._client=null,this._ready(e)},client:this._client,homeserver:this._homeserver}))),this._loadViewModel.start(),this.emitChange("loadViewModel"),this._loadViewModelSubscription=this.track(this._loadViewModel.disposableOn("change",()=>{this._loadViewModel.loading||(this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription)),this._setBusy(!1)}))}_disposeViewModels(){this._startSSOLoginViewModel=this.disposeTracked(this._ssoLoginViewModel),this._passwordLoginViewModel=this.disposeTracked(this._passwordLoginViewModel),this._completeSSOLoginViewModel=this.disposeTracked(this._completeSSOLoginViewModel),this.emitChange("disposeViewModels")}async setHomeserver(e){this._homeserver=e,this._loginOptions=null,this._queriedHomeserver=null,this._showError(""),this._disposeViewModels(),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange(),this.disposeTracked(this._abortHomeserverQueryTimeout);const t=this.clock.createTimeout(1e3);this._abortHomeserverQueryTimeout=this.track(()=>t.abort());try{await t.elapsed()}catch(s){if(s.name==="AbortError")return;throw s}this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this.queryHomeserver()}async queryHomeserver(){if(!(this._homeserver===this._queriedHomeserver||this._homeserver==="")){this._queriedHomeserver=this._homeserver,this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation);try{const e=this._client.queryLogin(this._homeserver);this._abortQueryOperation=this.track(()=>e.abort()),this.emitChange("isFetchingLoginOptions"),this._loginOptions=await e.result,this.emitChange("resolvedHomeserver")}catch(e){if(e.name==="AbortError")return;this._loginOptions=null}finally{this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("isFetchingLoginOptions")}this._loginOptions?(this._loginOptions.sso&&this._showSSOLogin(),this._loginOptions.password&&this._showPasswordLogin(),!this._loginOptions.sso&&!this._loginOptions.password&&this._showError("This homeserver supports neither SSO nor password based login flows")):this._showError(`Could not query login methods supported by ${this.homeserver}`)}}dispose(){super.dispose(),this._client&&this._client.deleteSession()}}class Pl extends w{constructor(e){super(e);this._sessionId=e.sessionId,this._busy=!1,this._showConfirm=!0,this._error=void 0}get showConfirm(){return this._showConfirm}get busy(){return this._busy}get cancelUrl(){return this.urlCreator.urlForSegment("session",!0)}async logout(){this._busy=!0,this._showConfirm=!1,this.emitChange("busy");try{await new vs(this.platform).startLogout(this._sessionId),this.navigation.push("session",!0)}catch(e){this._error=e,this._busy=!1,this.emitChange("busy")}}get status(){return this._error?this.i18n`Could not log out of device: ${this._error.message}`:this.i18n`Logging out… Please don't close the app.`}}class Ul extends w{constructor(e,t){super(e);this._pickerVM=t,this._sessionInfo=e.sessionInfo,this._isDeleting=!1,this._isClearing=!1,this._error=null,this._exportDataUrl=null}get error(){return this._error&&this._error.message}get id(){return this._sessionInfo.id}get openUrl(){return this.urlCreator.urlForSegment("session",this.id)}get label(){const{userId:e,comment:t}=this._sessionInfo;return t?`${e} (${t})`:e}get sessionInfo(){return this._sessionInfo}get exportDataUrl(){return this._exportDataUrl}get avatarColorNumber(){return z(this._sessionInfo.userId)}get avatarInitials(){return H(this._sessionInfo.userId)}}class Dl extends w{constructor(e){super(e);this._sessions=new is((t,s)=>t.id.localeCompare(s.id)),this._loadViewModel=null,this._error=null}async load(){const e=await this.platform.sessionInfoStorage.getAll();this._sessions.setManyUnsorted(e.map(t=>new Ul(this.childOptions({sessionInfo:t}),this)))}get loadViewModel(){return this._loadViewModel}get sessions(){return this._sessions}get cancelUrl(){return this.urlCreator.urlForSegment("login")}}class Bl extends w{constructor(e){super(e);this._error=null,this._sessionPickerViewModel=null,this._sessionLoadViewModel=null,this._loginViewModel=null,this._logoutViewModel=null,this._sessionViewModel=null,this._pendingClient=null}async load(){this.track(this.navigation.observe("login").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("session").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("sso").subscribe(()=>this._applyNavigation())),this._applyNavigation(!0)}async _applyNavigation(e){var o,a,c;const t=this.navigation.path.get("login"),s=(o=this.navigation.path.get("logout"))==null?void 0:o.value,i=(a=this.navigation.path.get("session"))==null?void 0:a.value,r=(c=this.navigation.path.get("sso"))==null?void 0:c.value;if(t)this.activeSection!=="login"&&this._showLogin();else if(s)this.activeSection!=="logout"&&this._showLogout(s);else if(i===!0)this.activeSection!=="picker"&&this._showPicker();else if(i){if(!this._sessionViewModel||this._sessionViewModel.id!==i)if(this._pendingClient&&this._pendingClient.sessionId===i){const h=this._pendingClient;this._pendingClient=null,this._showSession(h)}else this._pendingClient&&(this._pendingClient.dispose(),this._pendingClient=null),this._showSessionLoader(i)}else if(r)this.urlCreator.normalizeUrl(),this.activeSection!=="login"&&this._showLogin(r);else try{if(!(e&&this.urlCreator.tryRestoreLastUrl())){const h=await this.platform.sessionInfoStorage.getAll();h.length===0?this.navigation.push("login"):h.length===1?this.navigation.push("session",h[0].id):this.navigation.push("session")}}catch(h){this._setSection(()=>this._error=h)}}async _showPicker(){this._setSection(()=>{this._sessionPickerViewModel=new Dl(this.childOptions())});try{await this._sessionPickerViewModel.load()}catch(e){this._setSection(()=>this._error=e)}}_showLogin(e){this._setSection(()=>{this._loginViewModel=new Vl(this.childOptions({defaultHomeserver:this.platform.config.defaultHomeServer,ready:t=>{this._pendingClient=t,this.navigation.push("session",t.sessionId)},loginToken:e}))})}_showLogout(e){this._setSection(()=>{this._logoutViewModel=new Pl(this.childOptions({sessionId:e}))})}_showSession(e){this._setSection(()=>{this._sessionViewModel=new Cl(this.childOptions({client:e})),this._sessionViewModel.start()})}_showSessionLoader(e){const t=new vs(this.platform);t.startWithExistingSession(e),this._setSection(()=>{this._sessionLoadViewModel=new _r(this.childOptions({client:t,ready:s=>this._showSession(s)})),this._sessionLoadViewModel.start()})}get activeSection(){return this._error?"error":this._sessionViewModel?"session":this._loginViewModel?"login":this._logoutViewModel?"logout":this._sessionPickerViewModel?"picker":this._sessionLoadViewModel?"loading":"redirecting"}_setSection(e){this._error=null,this._sessionPickerViewModel=this.disposeTracked(this._sessionPickerViewModel),this._sessionLoadViewModel=this.disposeTracked(this._sessionLoadViewModel),this._loginViewModel=this.disposeTracked(this._loginViewModel),this._logoutViewModel=this.disposeTracked(this._logoutViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),e(),this._sessionPickerViewModel&&this.track(this._sessionPickerViewModel),this._sessionLoadViewModel&&this.track(this._sessionLoadViewModel),this._loginViewModel&&this.track(this._loginViewModel),this._logoutViewModel&&this.track(this._logoutViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}get error(){return this._error}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}get logoutViewModel(){return this._logoutViewModel}get sessionPickerViewModel(){return this._sessionPickerViewModel}get sessionLoadViewModel(){return this._sessionLoadViewModel}}async function Ll(n){try{const e=mh();n.setNavigation(e);const t=_h({navigation:e,history:n.history});t.attach();const s=new Bl({platform:n,urlCreator:t,navigation:e});await s.load(),n.createAndMountRootView(s)}catch(e){console.error(`${e.message}:
${e.stack}`)}}function Kl(n,e,t,s){const i=n(e);let r=!1;return i.elapsed().then(()=>{r=!0,t.abort()},()=>{}),s.then(o=>(i.abort(),o),o=>{throw i.abort(),o.name==="AbortError"&&r?new ue(`Request timed out after ${e}ms`,!0):o})}function pr(n,e=Math.random){return n.includes("?")?n=n+"&":n=n+"?",n+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}class Ol{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function Fl(n,{method:e,headers:t,timeout:s,format:i,uploadProgress:r}){const o=new XMLHttpRequest;if(r&&o.upload.addEventListener("progress",a=>r(a.loaded)),o.open(e,n),i==="buffer"&&(o.responseType="arraybuffer"),t)for(const[a,c]of t.entries())try{o.setRequestHeader(a,c)}catch(h){console.info(`Could not set ${a} header: ${h.message}`)}return s&&(o.timeout=s),o}function $l(n,e,t){return new Promise((s,i)=>{n.addEventListener("load",()=>s(n)),n.addEventListener("abort",()=>i(new J)),n.addEventListener("error",()=>i(new ue(`Error ${e} ${t}`))),n.addEventListener("timeout",()=>i(new ue(`Timeout ${e} ${t}`,!0)))})}function gr(n,e){let{cache:t,format:s,body:i,method:r}=e;t||(n=pr(n));const o=Fl(n,e),a=$l(o,r,n).then(c=>{const{status:h}=c;let l=null;return s==="buffer"?l=c.response:c.getResponseHeader("Content-Type")==="application/json"&&(l=JSON.parse(c.responseText)),{status:h,body:l}});return(i==null?void 0:i.nativeBlob)&&(i=i.nativeBlob),o.send(i||null),new Ol(a,o)}class fr{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const s=new Promise((i,r)=>{this._controller={abort(){const o=new Error("fetch request aborted");o.name="AbortError",r(o)}}});this.promise=Promise.race([e,s])}}abort(){this._controller.abort()}response(){return this.promise}}function ql(n,e){return function(s,i){if(e==null?void 0:e.haltRequests)return new fr(new Promise(()=>{}),{});if(i==null?void 0:i.uploadProgress)return gr(s,i);let{method:r,headers:o,body:a,timeout:c,format:h,cache:l=!1}=i;const d=typeof AbortController=="function"?new AbortController:null;(a==null?void 0:a.nativeBlob)&&(a=a.nativeBlob);let u={method:r,body:a};if(d&&(u=Object.assign(u,{signal:d.signal})),l||(s=pr(s)),u=Object.assign(u,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const p=new Headers;for(const[b,R]of o.entries())p.append(b,R);u.headers=p}const m=fetch(s,u).then(async p=>{const{status:b}=p;let R;try{h==="json"?R=await p.json():h==="buffer"&&(R=await p.arrayBuffer())}catch(G){if(!(G.name==="SyntaxError"&&b>=400))throw G}return{status:b,body:R}},p=>{throw p.name==="AbortError"?new J:p instanceof TypeError?new ue(`${r} ${s}: ${p.message}`):p}),_=new fr(m,d);return c&&(_.promise=Kl(n,c,_,_.promise)),_}}class jl{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){const s=await this.getAll();if(s){const i=s.find(r=>r.id===e);i&&(i.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(s)))}}async get(e){const t=await this.getAll();if(t)return t.find(s=>s.id===e)}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(s=>s.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}}class Wl{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?parseInt(s,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?s==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class Hl{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}class zl{encodeUnpadded(e){const t=Ge.encode(e),s=t.indexOf("=");return s!==-1?t.substr(0,s):t}encode(e){return Ge.encode(e)}decode(e){return Ge.decode(e)}}class Gl{encode(e){return Ds.encode(e)}decode(e){return Ds.decode(e)}}class Jl{constructor(){this.utf8=new Hl,this.base64=new zl,this.base58=new Gl}}class Ql{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const s=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:s})}async createAccountAndOTKs(e,t){let s;window.msCrypto&&(s=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);const i=await this._workerPool.send({type:"olm_create_account_otks",randomValues:s,otkAmount:t}).response();e.unpickle("",i)}async createOutboundOlmSession(e,t,s,i){const r=e.pickle("");let o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:r,theirIdentityKey:s,theirOneTimeKey:i,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}}class dt{constructor(e,t,s,i){this._logger=s,this.start=s._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=i}runDetached(e,t,s,i){return this._logger.runDetached(e,t,s,i)}wrapDetached(e,t,s,i){this.refDetached(this.runDetached(e,t,s,i))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,s,i){return this.child(e,s,i).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,s)=>{const i=s.durationOfType(e);return t+(i!=null?i:0)},0):0}log(e,t){const s=this.child(e,t);return s.end=s.start,s}set(e,t){if(typeof e=="object"){const s=e;Object.assign(this._values,s)}else this._values[e]=t;return this}serialize(e,t,s){if(this._filterCreator)try{e=this._filterCreator(new es(e),this)}catch(o){console.error("Error creating log filter",o)}let i=null;if(this._children&&(i=this._children.reduce((o,a)=>{const c=a.serialize(e,this.start,!1);return c&&(o===null&&(o=[]),o.push(c)),o},null)),e&&!e.filter(this,i))return;const r={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(r.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),s&&(r.f=!0),i&&(r.c=i),r}run(e){this.end!==void 0&&console.trace("log item is finished, additional logs will likely not be recorded");try{const t=e(this);return t instanceof Promise?t.then(s=>(this.finish(),s),s=>{throw this.catch(s)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}get level(){return q}catch(e){return this.error=e,this.logLevel=q.Error,this.finish(),e}child(e,t,s){this.end&&console.trace("log item is finished, additional logs will likely not be recorded"),t||(t=this.logLevel||q.Info);const i=new dt(e,t,this._logger,s);return this._children||(this._children=[]),this._children.push(i),i}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class yr{constructor({platform:e,serializedTransformer:t=s=>s}){this._openItems=new Set,this._platform=e,this._serializedTransformer=t}log(e,t=q.Info){const s=new dt(e,t,this);s.end=s.start,this._persistItem(s,void 0,!1)}wrapOrRun(e,t,s,i,r){return e?e.wrap(t,s,i,r):this.run(t,s,i,r)}runDetached(e,t,s,i){s||(s=q.Info);const r=new dt(e,s,this);return this._run(r,t,s,!1,i),r}run(e,t,s,i){s===void 0&&(s=q.Info);const r=new dt(e,s,this);return this._run(r,t,s,!0,i)}_run(e,t,s,i,r){this._openItems.add(e);const o=()=>{let a=new es;if(r)try{a=r(a,e)}catch(c){console.error("Error while creating log filter",c)}else a=a.minLevel(s);try{this._persistItem(e,a,!1)}catch(c){console.error("Could not persist log item",c)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(c=>(o(),c),c=>{if(o(),i)throw c}),i)return a}else if(o(),i)return a}catch(a){if(o(),i)throw a}}_finishOpenItems(){for(const e of this._openItems){e.finish();try{this._persistItem(e,new es,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}get level(){return q}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class Yl extends yr{constructor(e){super(e);const{name:t,flushInterval:s=60*1e3,limit:i=3e3}=e;this._name=t,this._limit=i,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this._platform.clock.createInterval(()=>this._tryFlush(),s)}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){const e=await this._openDB();try{const t=e.transaction(["logs"],"readwrite"),s=t.objectStore("logs"),i=this._queuedItems.length;for(const o of this._queuedItems)s.add(o);const r=await N(s.count());if(r>this._limit){let o=r-this._limit+Math.round(.1*this._limit);await M(s.openCursor(),(a,c,h)=>(h.delete(),o-=1,{done:o===0}))}await Ye(t),this._queuedItems.splice(0,i)}catch(t){console.error("Could not flush logs",t)}finally{try{e.close()}catch{}}}_finishAllAndFlush(){this._finishOpenItems(),this.log({l:"pagehide, closing logs",t:"navigation"}),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this._name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return Xt(this._name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}_persistItem(e,t,s){const i=e.serialize(t,void 0,s);if(i){const r=this._serializedTransformer(i);this._queuedItems.push({json:JSON.stringify(r)})}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this._name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async export(){const e=await this._openDB();try{const s=e.transaction(["logs"],"readonly").objectStore("logs"),r=(await Jn(s.openCursor(),()=>!1)).concat(this._queuedItems);return new Xl(r,this,this._platform)}finally{try{e.close()}catch{}}}async _removeItems(e){const t=await this._openDB();try{const s=t.transaction(["logs"],"readwrite"),i=s.objectStore("logs");for(const r of e)if(typeof r.id=="number")i.delete(r.id);else{const o=this._queuedItems.indexOf(r);o===-1&&this._queuedItems.splice(o,1)}await Ye(s)}finally{try{t.close()}catch{}}}}class Xl{constructor(e,t,s){this._items=e,this._logger=t,this._platform=s}get count(){return this._items.length}removeFromStore(){return this._logger._removeItems(this._items)}asBlob(){var r;const e={formatVersion:1,appVersion:(r=this._platform.updateService)==null?void 0:r.version,items:this._items.map(o=>JSON.parse(o.json))},t=JSON.stringify(e),s=this._platform.encoding.utf8.encode(t);return this._platform.createBlob(s,"application/json")}}class Zl extends yr{_persistItem(e){wr(e)}async export(){}}const ed=["l","id"];function td(n){return Object.entries(n).filter(([e])=>!ed.includes(e)).reduce((e,[t,s])=>(e=e||{},e[t]=s,e),null)}function wr(n){const e=`${sd(n)} (${n.duration}ms)`,t=td(n.values),s=n.children||t;if(s?(n.error?console.group(e):console.groupCollapsed(e),n.error&&console.error(n.error)):n.error?console.error(n.error):console.log(e),t&&console.table(t),n.children)for(const i of n.children)wr(i);s&&console.groupEnd()}function sd(n){return n.values.t==="network"?`${n.values.method} ${n.values.url}`:n.values.l&&typeof n.values.id!="undefined"?`${n.values.l} ${n.values.id}`:n.values.l&&typeof n.values.status!="undefined"?`${n.values.l} (${n.values.status})`:n.values.l&&n.error?`${n.values.l} failed`:typeof n.values.ref!="undefined"?`ref ${n.values.ref}`:n.values.l||n.values.type}function vr(n){return typeof n!="object"||"nodeType"in n||Array.isArray(n)}function je(n,e){return Object.entries(n).reduce((t,[s,i])=>(typeof i=="function"&&(i=i(e)),i?t+(t.length?" ":"")+s:t),"")}function We(n,e,t){e==="className"&&(e="class"),t===!1?n.removeAttribute(e):(t===!0&&(t=e),n.setAttribute(e,t))}function id(n,e,t){return br(Rs,n,e,t)}function br(n,e,t,s){t&&vr(t)&&(s=t,t=void 0);const i=document.createElementNS(n,e);if(t)for(let[r,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&r==="className"?je(o,void 0):!1),We(i,r,o);if(s){Array.isArray(s)||(s=[s]);for(let r of s)typeof r=="string"&&(r=le(r)),i.appendChild(r)}return i}function le(n){return document.createTextNode(n)}const Rs="http://www.w3.org/1999/xhtml",rd="http://www.w3.org/2000/svg",Sr={[Rs]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","main","article","aside","del","blockquote","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","label","form","progress","output","video"],[rd]:["svg","circle"]},f={};for(const[n,e]of Object.entries(Sr))for(const t of e)f[t]=function(s,i){return br(n,t,s,i)};function ut(n,e){let t;try{t=n.mount(e)}catch(s){t=nd(s)}return t}function nd(n){const e=new Error().stack;let t=null;return e&&(t=e.split(`
`)[1]),f.div([f.h2("Something went wrong\u2026"),f.h3(n.message),f.p(`This occurred while running ${t}.`),f.pre(n.stack)])}function Ir(n,e,t){if(e===n.childElementCount)n.appendChild(t);else{const i=n.children[e];n.insertBefore(t,i)}}function od(n){n.innerHTML=""}class mt{constructor({list:e,onItemClick:t,className:s,tagName:i="ul",parentProvidesUpdates:r=!0},o){this._onItemClick=t,this._list=e,this._className=s,this._tagName=i,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:r}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=id(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const s=Array.prototype.indexOf.call(this._root.childNodes,t),i=this._childInstances[s];i&&this._onItemClick(i,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const s=this._childCreator(t);this._childInstances.push(s),e.appendChild(ut(s,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,s){this.moveChild(e,t)}onUpdate(e,t,s){this.updateChild(e,t,s)}addChild(e,t){const s=this._childCreator(t);this._childInstances.splice(e,0,s),Ir(this._root,e,ut(s,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[s]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,s),s.root().remove(),Ir(this._root,t,s.root())}updateChild(e,t,s){if(this._childInstances){const i=this._childInstances[e];i&&i.update(t,s)}}recreateItem(e,t){if(this._childInstances){const s=this._childCreator(t);if(!s)this.onRemove(e,t);else{const[i]=this._childInstances.splice(e,1,s);this._root.replaceChild(s.mount(this._mountArgs),i.root()),i.unmount()}}}getChildInstanceByIndex(e){var t;return(t=this._childInstances)==null?void 0:t[e]}}class Er{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){var e;typeof((e=this._value)==null?void 0:e.on)=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function ad(n){for(const e of Object.values(n))if(typeof e=="function")return!0;return!1}class g extends Er{constructor(){super(...arguments);this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.addEventListener(t,s,i)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.removeEventListener(t,s,i)}mount(e){const t=new kr(this);try{this._root=this.render(t,this._value)}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const s of this._bindings)s()}_addEventListener(e,t,s,i=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:s,useCapture:i})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const s of this._subViews)s.update(e,t)}}class kr{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,s,i=!1){this._templateView._addEventListener(e,t,s,i)}_addAttributeBinding(e,t,s){let i;const r=()=>{const o=s(this._value);i!==o&&(i=o,We(e,t,o))};this._addBinding(r),r()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",s=>je(t,s))}_addTextBinding(e){const t=e(this._value),s=le(t);let i=t;const r=()=>{const o=e(this._value);i!==o&&(i=o,s.textContent=o+"")};return this._addBinding(r),s}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[s,i]of Object.entries(t))if(typeof i=="object"){if(s!=="className"||i===null)continue;ad(i)?this._addClassNamesBinding(e,i):We(e,s,je(i,this._value))}else if(this._isEventHandler(s,i)){const r=s.substr(2,1).toLowerCase()+s.substr(3),o=i;this._templateView._addEventListener(e,r,o)}else typeof i=="function"?this._addAttributeBinding(e,s,i):We(e,s,i)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let s of t)typeof s=="function"?s=this._addTextBinding(s):typeof s=="string"&&(s=le(s)),e.appendChild(s)}_addReplaceNodeBinding(e,t){let s=e(this._value),i=t(null);const r=()=>{const o=e(this._value);if(s!==o){s=o;const a=t(i);i.parentNode&&i.parentNode.replaceChild(a,i),i=a}};return this._addBinding(r),i}el(e,t,s){return this.elNS(Rs,e,t,s)}elNS(e,t,s,i){s!==void 0&&vr(s)&&(i=s,s=void 0);const r=document.createElementNS(e,t);return s&&this._setNodeAttributes(r,s),i&&this._setNodeChildren(r,i),r}view(e,t){return this._templateView.addSubView(e),ut(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,s=>{if(s&&s.nodeType!==Node.COMMENT_NODE){const r=this._templateView._subViews;if(r){const o=r.findIndex(a=>a.root()===s);if(o!==-1){const[a]=r.splice(o,1);a.unmount()}}}const i=t(e(this._value));return i?this.view(i):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,s=>new Ut(this._value,(i,r)=>{const o=t(s,i,r);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(s=>!!e(s),s=>s?t(this._value):null)}if(e,t){return this.ifView(e,s=>new Ut(s,t))}mapSideEffect(e,t){let s=e(this._value);const i=()=>{const r=e(this._value);s!==r&&(t(r,s),s=r)};this._addBinding(i),t(s,void 0)}}for(const[n,e]of Object.entries(Sr))for(const t of e)kr.prototype[t]=function(s,i){return this.elNS(n,t,s,i)};class Ut extends g{constructor(e,t){super(e);this._render=t}render(e,t){return this._render(e,t)}}function Ae(n,e,t=void 0){const s=!!n.avatarUrl(e);let i=je({avatar:!0,[`size-${e}`]:!0,[`usercolor${n.avatarColorNumber}`]:!s});t&&(i+=` ${t}`);const r=s?Rr(n,e):le(n.avatarLetter),o=f.div({className:i},[r]);return s&&(We(o,"data-avatar-letter",n.avatarLetter),We(o,"data-avatar-color",n.avatarColorNumber)),o}function Rr(n,e){const t=e.toString();return f.img({src:n.avatarUrl(e),width:t,height:t,title:n.avatarTitle})}function cd(n){const e=n.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function Cr(n){if(!cd(n))return;const e=n.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);const s=e.getAttribute("data-avatar-letter");e.textContent=s}class xe extends Er{constructor(e,t){super(e);this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=Ae(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const s=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(Rr(e,this._size),this._root.firstChild),this._root.classList.remove(s)):(this._root.textContent=e.avatarLetter,this._root.classList.add(s))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const s=this._root.firstChild;s.tagName==="IMG"&&s.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}let _t;function de(n,e=void 0){_t===void 0&&(_t=document.querySelector(".hydrogen"));const t=Object.assign({spinner:!0},e);return(_t==null?void 0:_t.classList.contains("legacy"))?n.div({className:t},[n.div(),n.div(),n.div(),n.div()]):n.svg({className:t,viewBox:"0 0 100 100"},n.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class hd extends g{render(e,t){const s={active:i=>i.isOpen,hidden:i=>i.hidden};return e.li({className:s},[e.a({href:t.url},[e.view(new xe(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:i=>i.isUnread}},i=>i.name),e.map(i=>i.busy,i=>i?de(e):e.div({className:{badge:!0,highlighted:r=>r.isHighlighted,hidden:r=>!r.badgeCount}},r=>r.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}class ld extends g{render(e,t){const s=()=>{i.value="",i.blur(),r.blur(),t.clear()},i=e.input({type:"text",placeholder:t==null?void 0:t.label,"aria-label":t==null?void 0:t.label,autocomplete:t==null?void 0:t.autocomplete,enterkeyhint:"search",name:t==null?void 0:t.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&s()},onFocus:()=>i.select()}),r=e.button({onClick:s,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[i,r])}}class dd extends g{render(e,t){const s=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,i=e.view(new mt({className:"RoomList",list:t.tileViewModels},o=>new hd(o))),r=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new ld({i18n:t.i18n,label:t.i18n`Filter rooms…`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(i.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:s,"aria-label":s}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`}),e.a({className:"button-utility create",href:t.createRoomUrl,"aria-label":t.i18n`Create room`,title:t.i18n`Create room`})]);return e.div({className:"LeftPanel"},[r,i])}}class Cs{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=f.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=ud(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,s=this._popup.clientHeight,i=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>i.bottom||e.left>i.right||e.bottom<i.top||e.right<i.left)return!1;if(i.bottom>=e.bottom+s)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(i.top<=e.top-s)this._popup.style.top=`${e.top-s-this._verticalPadding}px`;else return!1;if(i.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(i.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}function ud(n){let e=n;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){const s=window.getComputedStyle(e).getPropertyValue("overflow-y");if(s==="auto"||s==="scroll")return e}while(e!==document.body)}class B extends g{static option(e,t){return new md(e,t)}constructor(e){super();this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}}class md{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}class _d extends mt{constructor(e){const t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:s=>s.onClick()};super(t,s=>new pd(s))}}class pd extends g{render(e,t){return e.button({className:{active:s=>s.isActive,pending:s=>s.isPending}},[t.key," ",s=>`${s.count}`])}onClick(){this.value.toggle()}}class He extends g{constructor(e,t,s="li"){super(e);this._menuPopup=null,this._tagName=s,this._renderFlags=t}get _interactive(){var e,t;return(t=(e=this._renderFlags)==null?void 0:e.interactive)!=null?t:!0}get _isReplyPreview(){var e;return(e=this._renderFlags)==null?void 0:e.reply}render(e,t){const s=[this.renderMessageBody(e,t)];this._interactive&&s.push(e.button({className:"Timeline_messageOptions"},"\u22EF"));const i=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:t.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation}},s);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)i.removeChild(i.querySelector(".Timeline_messageAvatar")),i.removeChild(i.querySelector(".Timeline_messageSender"));else if(!o&&!this._isReplyPreview){const c=f.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[Ae(t,30)]),h=f.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`},t.displayName);i.insertBefore(c,i.firstChild),i.insertBefore(h,i.firstChild)}});let r=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!r?(r=new _d(o),this.addSubView(r),i.appendChild(ut(r))):!o&&r&&(i.removeChild(r.root()),r.unmount(),this.removeSubView(r),r=null)}),i}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const s=()=>this.root().classList.remove("menuOpen");this._menuPopup=new Cs(new B(t),s),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&e.shape!=="redacted"&&!e.isPending&&(t.push(new gd(e)),t.push(B.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(B.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(B.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t}renderMessageBody(){}}class gd{constructor(e){this._vm=e}toDOM(e){const t=["\u{1F44D}","\u{1F44E}","\u{1F604}","\u{1F389}","\u{1F615}","\u2764\uFE0F","\u{1F680}","\u{1F440}"].map(i=>e.button({onClick:()=>this._vm.react(i)},i)),s=e.button({onClick:()=>{const i=prompt("Enter your reaction (emoji)");i&&this._vm.react(i)}},"\u2026");return e.li({className:"quick-reactions"},[...t,s])}}class fd extends g{render(e,t){const s=Bt(t);if(!s)throw new Error(`Shape ${t.shape} is unrecognized.`);const i=new s(t,{reply:!0,interactive:!1});return e.div({className:"ReplyPreviewView"},e.blockquote([e.a({className:"link",href:t.permaLink},"In reply to"),e.a({className:"pill",href:t.senderProfileLink},[Ae(t,12,void 0),t.displayName]),e.br(),e.view(i)]))}}class yd extends g{render(e){return e.blockquote({className:"ReplyPreviewView"},[e.div({className:"Timeline_messageBody statusMessage"},"This reply could not be found.")])}}class wd extends He{renderMessageBody(e,t){const s=e.time({className:{hidden:!t.date}},t.date+" "+t.time),i=e.div({className:{Timeline_messageBody:!0,statusMessage:o=>o.shape==="message-status"}},e.mapView(o=>o.replyTile,o=>this._isReplyPreview?null:t.isReply&&!o?new yd:o?new fd(o):null)),r=o=>(o==null?void 0:o.nodeType)!==Node.COMMENT_NODE&&o.className!=="ReplyPreviewView";return e.mapSideEffect(o=>o.body,o=>{for(;r(i.lastChild);)i.removeChild(i.lastChild);for(const a of o.parts)i.appendChild(Mr(a));i.appendChild(s)}),i}}function vd(n){const e=n.items.map(s=>f.li(Ne(s))),t=n.startOffset;return t?f.ol({start:t},e):f.ul(e)}function bd(n){const e={src:n.src};return n.width&&(e.width=n.width),n.height&&(e.height=n.height),n.alt&&(e.alt=n.alt),n.title&&(e.title=n.title),f.img(e)}function Sd(n){const e=`avatar size-12 usercolor${n.avatarColorNumber}`,t=f.div({class:e},le(n.avatarInitials)),s=Ne(n.children);return s.unshift(t),f.a({class:"pill",href:n.href,rel:"noopener",target:"_blank"},s)}function Id(n){const e=[];if(n.head){const s=n.head.map(i=>f.th(Ne(i)));e.push(f.thead(f.tr(s)))}const t=[];for(const s of n.body){const i=s.map(r=>f.td(Ne(r)));t.push(f.tr(i))}return e.push(f.tbody(t)),f.table(e)}const Ed={header:n=>f["h"+Math.min(6,n.level)](Ne(n.inlines)),codeblock:n=>f.pre(f.code(le(n.text))),table:n=>Id(n),code:n=>f.code(le(n.text)),text:n=>le(n.text),link:n=>f.a({href:n.url,className:"link",target:"_blank",rel:"noopener"},Ne(n.inlines)),pill:Sd,format:n=>f[n.format](Ne(n.children)),rule:()=>f.hr(),list:vd,image:bd,newline:()=>f.br()};function Mr(n){const e=Ed[n.type];return e?e(n):le(`[unknown part type ${n.type}]`)}function Ne(n){return Array.from(n,Mr)}class Tr extends He{renderMessageBody(e,t){let i=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(i=`height: ${t.height}px`);const r=[e.div({className:"spacer",style:i}),this.renderMedia(e,t),e.time(t.date+" "+t.time)];if(t.isPending){const o=e.div({className:{sendStatus:!0,hidden:c=>!c.sendStatus}},c=>c.sendStatus),a=e.progress({min:0,max:100,value:c=>c.uploadPercentage,className:{hidden:c=>!c.isUploading}});r.push(o,a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`},r),e.if(o=>o.error,o=>o.p({className:"error"},t.error))])}}class kd extends Tr{renderMedia(e,t){const s=e.img({src:i=>i.thumbnailUrl,alt:i=>i.label,title:i=>i.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending?s:e.a({href:t.lightboxUrl},s)}}function Dt(n,e){return new Promise((t,s)=>{let i;const r=a=>{i(),s(a.target.error)},o=()=>{i(),t()};i=()=>{n.removeEventListener(e,o),n.removeEventListener("error",r)},n.addEventListener(e,o),n.addEventListener("error",r)})}class Rd extends Tr{renderMedia(e){const t=e.video({src:s=>s.videoUrl||`data:${s.mimeType},`,title:s=>s.label,controls:!0,preload:"none",poster:s=>s.thumbnailUrl,onPlay:this._onPlay.bind(this),style:s=>`max-width: ${s.width}px; max-height: ${s.height}px;${s.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const s=e.target;await t.loadVideo();const i=Dt(s,"loadeddata");s.load(),await i,s.play()}catch{}}_onError(e){const t=this.value,s=e.target,i=s.error;if(i instanceof window.MediaError&&i.code===4)if(!s.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(i)}}class Cd extends He{renderMessageBody(e,t){const s=[];return t.isPending?s.push(i=>i.label):s.push(e.button({className:"link",onClick:()=>t.download()},i=>i.label),e.time(t.date+" "+t.time)),e.p({className:"Timeline_messageBody statusMessage"},s)}}class Md extends He{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},[e.span(t.label),e.a({className:"Timeline_locationLink",href:t.mapsLink,target:"_blank",rel:"noopener"},t.i18n`Open in maps`),e.time(t.date+" "+t.time)])}}class Td extends He{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class Ad extends g{render(e){return e.li({className:"AnnouncementView"},e.div(t=>t.announcement))}onClick(){}}class xd extends He{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(B.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}}class Nd extends g{render(e){const t={GapView:!0,isLoading:s=>s.isLoading,isAtTop:s=>s.isAtTop};return e.li({className:t},[de(e),e.div(s=>s.isLoading?s.i18n`Loading more messages …`:s.i18n`Not loading!`),e.if(s=>s.error,s=>s.strong(i=>i.error))])}onClick(){}}function Bt(n){switch(n.shape){case"gap":return Nd;case"announcement":return Ad;case"message":case"message-status":return wd;case"image":return kd;case"video":return Rd;case"file":return Cd;case"location":return Md;case"missing-attachment":return Td;case"redacted":return xd}}function Ar(n){return n.offsetTop+n.clientHeight}function xr(n,e,t=n.children.length-1){for(var s=t;s>=0;s--)if(n.children[s].offsetTop<e)return s;return 0}class Vd extends g{constructor(){super(...arguments);this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new Pd(t.tiles,()=>this.restoreScrollPosition());const s=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:i=>!i.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(s)),s}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,s=e.clientHeight-t.clientHeight;if(s>0){t.style.setProperty("margin-top",`${s}px`);const i=this.value.tiles.length;this.updateVisibleRange(0,i-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const i=Ar(this.anchoredNode);if(i!==this.anchoredBottom){const r=i-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,r):e.scrollTop=e.scrollTop+r,this.anchoredBottom=i}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:s,scrollTop:i,clientHeight:r}=e;let o;if(this.stickToBottom=Math.abs(s-(i+r))<1,this.stickToBottom)o=this.value.tiles.length-1;else{const c=i+r,h=xr(t,c);this.anchoredNode=t.childNodes[h],this.anchoredBottom=Ar(this.anchoredNode),o=h}let a=xr(t,i,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){const s=this.tilesView.getChildInstanceByIndex(e),i=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(s==null?void 0:s.value,i==null?void 0:i.value)}}class Pd extends mt{constructor(e,t){const s={list:e,onItemClick:(i,r)=>i.onClick(r)};super(s,i=>{const r=Bt(i);if(r)return new r(i)});this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,s){if(s==="shape"){const i=Bt(t),r=this.getChildInstanceByIndex(e);if(!i||!(r instanceof i)){super.recreateItem(e,t);return}}super.onUpdate(e,t,s),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,s){super.onMove(e,t,s),this.onChanged()}}class Ud extends g{render(e,t){return e.div({className:"TimelineLoadingView"},[de(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages…`:t.i18n`Loading messages…`)])}}class Dd extends g{constructor(e){super(e);this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({onKeydown:r=>this._onKeyDown(r),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:r=>r.isEncrypted?"Send an encrypted message\u2026":"Send a message\u2026",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const s=e.map(r=>r.replyViewModel,(r,o)=>{const a=r&&Bt(r);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(r,{interactive:!1},"div"))]):null}),i=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:r=>this._toggleAttachmentMenu(r)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:r=>r.canSend}},[s,i])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(s){t(),console.error(s)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new Cs(new B([B.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),B.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),B.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}}class Bd extends g{render(e){return e.div({className:"RoomArchivedView"},e.h3(t=>t.description))}}class Nr extends g{constructor(e){super(e);this._optionsPopup=null}render(e,t){let s;return t.composerViewModel.kind==="composer"?s=new Dd(t.composerViewModel):t.composerViewModel.kind==="archived"&&(s=new Bd(t.composerViewModel)),e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new xe(t,32)),e.div({className:"room-description"},[e.h2(i=>i.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:i=>this._toggleOptionsMenu(i)})]),e.div({className:"RoomView_body"},[e.div({className:"RoomView_error"},i=>i.error),e.mapView(i=>i.timelineViewModel,i=>i?new Vd(i):new Ud(t)),e.view(s)])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,s=[];if(s.push(B.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.canLeave&&s.push(B.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&s.push(B.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&s.push(B.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!s.length)return;this._optionsPopup=new Cs(new B(s)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class Ld extends g{render(e,t){return e.main({className:"UnknownRoomView middle"},e.div([e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:s=>s.busy},t.i18n`Join room`),e.if(s=>s.error,s=>s.p({className:"error"},t.error))]))}}class ze{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(f,e):this.render(f,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class Vr extends ze{constructor(e="Loading"){super(e,(t,s)=>t.div({className:"LoadingView"},[de(t),s]))}}class Pr extends g{render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new xe(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)])]),e.div({className:"RoomView_body"},[e.mapView(s=>s.error,s=>s?new Kd(t):new Vr(t.i18n`Setting up the room…`))])])}}class Kd extends g{render(e,t){return e.div({className:"RoomBeingCreated_error centered-column"},[e.h3(t.i18n`Could not create the room, something went wrong:`),e.div({className:"RoomView_error form-group"},t.error),e.div({className:"button-row"},e.button({className:"button-action primary destructive",onClick:()=>t.cancel()},t.i18n`Cancel`))])}}class Ur extends g{render(e,t){var r;let s=[];t.isDirectMessage&&s.push(Ae(t,128,"InviteView_dmAvatar"));let i;return t.isDirectMessage?i=[e.strong(t.name),` (${(r=t.inviter)==null?void 0:r.id}) wants to chat with you.`]:t.inviter?i=[Ae(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:i="You were invited to join.",s.push(e.p({className:"InviteView_inviter"},i)),t.isDirectMessage||s.push(e.div({className:"InviteView_roomProfile"},[Ae(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),Ae(t,32),e.div({className:"room-description"},[e.h2(o=>o.name)])]),e.if(o=>o.error,o=>o.div({className:"RoomView_error"},a=>a.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...s,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:o=>o.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:o=>o.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class Od extends g{render(e,t){const s=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),i=e.div({role:"img","aria-label":c=>c.name,title:c=>c.name,className:{picture:!0,hidden:c=>!c.imageUrl},style:c=>`background-image: url('${c.imageUrl}'); max-width: ${c.imageWidth}px; max-height: ${c.imageHeight}px;`}),r=e.div({className:{loading:!0,hidden:c=>!!c.imageUrl}},[de(e),e.div(t.i18n`Loading image…`)]),o=e.div({className:"details"},[e.strong(c=>c.name),e.br(),"uploaded by ",e.strong(c=>c.sender),c=>` at ${c.time} on ${c.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:c=>this.clickToClose(c),onKeydown:c=>this.closeOnEscKey(c)},[i,r,o,s]);return Fd(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}}function Fd(n,e){const t=$d(e),s=t[0],i=t[t.length-1];n.addEventListener(e,"keydown",r=>{r.key==="Tab"&&(r.shiftKey?document.activeElement===s&&(i.focus(),r.preventDefault()):document.activeElement===i&&(s.focus(),r.preventDefault()))},!0),Promise.resolve().then(()=>{s.focus()})}function $d(n){return n.querySelectorAll("a[href], button, textarea, input, select")}class qd extends g{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:s=>!s.isShown}},[de(e,{hidden:s=>!s.isWaiting}),e.p(s=>s.statusLabel),e.if(s=>s.isConnectNowShown,s=>s.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(s=>s.isSecretStorageShown,s=>s.a({href:t.setupKeyBackupUrl},"Go to settings")),e.if(s=>s.canDismiss,s=>s.div({className:"end"},s.button({className:"dismiss",onClick:()=>t.dismiss()})))])}}class jd extends g{render(e,t){const s=[];for(let i=0;i<t.height*t.width;i+=1)s.push(e.div({onClick:()=>t.focusTile(i),onFocusin:()=>t.focusTile(i),className:{container:!0,[`tile${i}`]:!0,focused:r=>r.focusIndex===i}},e.mapView(r=>r.roomViewModelAt(i),r=>r?r.kind==="roomBeingCreated"?new Pr(r):r.kind==="invite"?new Ur(r):new Nr(r):new ze(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return s.push(e.div({className:i=>`focus-ring tile${i.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},s)}}class Dr extends g{render(e){return e.div([e.map(t=>t.status,(t,s,i)=>{switch(t){case"Enabled":return Wd(s,i);case"NewVersionAvailable":return Hd(s,i);case"SetupKey":return zd(s,i);case"SetupPhrase":return Gd(s,i);case"Pending":return s.p(i.i18n`Waiting to go online…`)}}),e.map(t=>t.backupWriteStatus,(t,s,i)=>{switch(t){case"Writing":{const r=s.progress({min:0,max:100,value:o=>o.backupPercentage});return s.div(["Backup in progress ",r," ",o=>o.backupInProgressLabel])}case"Stopped":{let r;return i.backupError?r=`Backup has stopped because of an error: ${i.backupError}`:r="Backup has stopped",s.p(r," ",s.button({onClick:()=>i.startBackup()},"Backup now"))}case"Done":return s.p("All keys are backed up.");default:return null}})])}}function Wd(n,e){const t=[n.p([e.i18n`Key backup is enabled, using backup version ${e.backupVersion}. `,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(n.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),n.div(t)}function Hd(n,e){const t=[n.p([e.i18n`A new backup version has been created from another device. Disable key backup and enable it again with the new key.`,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return n.div(t)}function zd(n,e){const t=n.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return n.div([n.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),Lr(n),Br(n,e,e.i18n`Security key`,(s,i)=>e.enterSecurityKey(s,i)),n.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function Gd(n,e){const t=n.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return n.div([n.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),Lr(n),Br(n,e,e.i18n`Security phrase`,(s,i)=>e.enterSecurityPhrase(s,i)),n.p([e.i18n`You can also `,t,e.i18n`.`])])}function Br(n,e,t,s){let i;const r=()=>s(o.value,(i==null?void 0:i.checked)||!1),o=n.input({type:"password",disabled:c=>c.isBusy,placeholder:t}),a=[n.p([o,n.button({disabled:c=>c.isBusy,onClick:r},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){i=n.input({type:"checkbox",id:"enable-dehydrated-device"});const c=n.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(n.p([i,n.label({for:i.id},[e.i18n`Back up my device as well (`,c,")"])]))}return n.div({className:"row"},[n.div({className:"label"},t),n.div({className:"content"},a)])}function Lr(n){return n.if(e=>e.error,(e,t)=>e.div([e.p({className:"error"},s=>s.i18n`Could not enable key backup: ${s.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}class Jd extends g{render(e,t){let s=t.version;t.showUpdateButton&&(s=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const i=(o,a,c,h="")=>o.div({className:`row ${h}`},[o.div({className:"label"},a),o.div({className:"content"},c)]),r=[];return r.push(e.h3("Session"),i(e,t.i18n`User ID`,t.userId),i(e,t.i18n`Session ID`,t.deviceId,"code"),i(e,t.i18n`Session key`,t.fingerprintKey,"code"),i(e,"",e.button({onClick:()=>t.logout(),disabled:o=>o.isLoggingOut},t.i18n`Log out`))),r.push(e.h3("Key backup"),e.view(new Dr(t.keyBackupViewModel))),r.push(e.h3("Notifications"),e.map(o=>o.pushNotifications.supported,(o,a)=>{if(o===null)return a.p(t.i18n`Loading…`);if(o){const c=l=>l.pushNotifications.enabled?l.i18n`Push notifications are enabled`:l.i18n`Push notifications are disabled`,h=l=>l.pushNotifications.enabled?l.i18n`Disable`:l.i18n`Enable`;return i(a,c,a.button({onClick:()=>t.togglePushNotifications(),disabled:l=>l.pushNotifications.updating},h))}else return a.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(o=>o.pushNotifications.supported&&o.pushNotifications.enabled,o=>o.div([o.p(["If you think push notifications are not being delivered, ",o.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),o.map(a=>a.pushNotifications.enabledOnServer,(a,c)=>{if(a===!0)return c.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(a===!1)return c.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),o.map(a=>a.pushNotifications.serverError,(a,c)=>{if(a)return c.p("Couldn't not check on server: "+a.message)})]))),r.push(e.h3("Preferences"),i(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t))),r.push(e.h3("Application"),i(e,t.i18n`Version`,s),i(e,t.i18n`Storage usage`,o=>`${o.storageUsage} / ${o.storageQuota}`),i(e,t.i18n`Debug logs`,e.button({onClick:()=>t.exportLogs()},"Export")),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},r)])}_imageCompressionRange(e,t){const s=32,i=Math.ceil(t.minSentImageSizeLimit/s)*s,r=(Math.floor(t.maxSentImageSizeLimit/s)+1)*s,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:s,min:i,max:r,value:a=>a.sentImageSizeLimit||r,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}}class Qd extends g{render(e,t){return e.main({className:"middle"},e.div({className:"CreateRoomView centered-column"},[e.h2("Create room"),e.form({className:"CreateRoomView_detailsForm form",onChange:s=>this.onFormChange(s),onSubmit:s=>this.onSubmit(s)},[e.div({className:"vertical-layout"},[e.button({type:"button",className:"CreateRoomView_selectAvatar",onClick:()=>t.selectAvatar()},e.mapView(s=>s.hasAvatar,s=>s?new xe(t,64):new ze(void 0,i=>i.div({className:"CreateRoomView_selectAvatarPlaceholder"})))),e.div({className:"stretch form-row text"},[e.label({for:"name"},t.i18n`Room name`),e.input({onInput:s=>t.setName(s.target.value),type:"text",name:"name",id:"name",placeholder:t.i18n`Enter a room name`})])]),e.div({className:"form-row text"},[e.label({for:"topic"},t.i18n`Topic (optional)`),e.textarea({onInput:s=>t.setTopic(s.target.value),name:"topic",id:"topic",placeholder:t.i18n`Topic`})]),e.div({className:"form-group"},[e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPrivate",value:"false",checked:!t.isPublic}),e.label({for:"isPrivate"},t.i18n`Private room, only upon invitation.`)]),e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPublic",value:"true",checked:t.isPublic}),e.label({for:"isPublic"},t.i18n`Public room, anyone can join`)])]),e.div({className:{"form-row check":!0,hidden:s=>s.isPublic}},[e.input({type:"checkbox",name:"isEncrypted",id:"isEncrypted",checked:t.isEncrypted}),e.label({for:"isEncrypted"},t.i18n`Enable end-to-end encryption`)]),e.div({className:{"form-row text":!0,hidden:s=>!s.isPublic}},[e.label({for:"roomAlias"},t.i18n`Room alias`),e.input({onInput:s=>t.setRoomAlias(s.target.value),type:"text",name:"roomAlias",id:"roomAlias",placeholder:t.i18n`Room alias (<alias>, or #<alias> or #<alias>:hs.tld`})]),e.div({className:"form-group"},[e.div(e.button({className:"link",type:"button",onClick:()=>t.toggleAdvancedShown()},s=>s.isAdvancedShown?s.i18n`Hide advanced settings`:s.i18n`Show advanced settings`)),e.div({className:{"form-row check":!0,hidden:s=>!s.isAdvancedShown}},[e.input({type:"checkbox",name:"isFederationDisabled",id:"isFederationDisabled",checked:t.isFederationDisabled}),e.label({for:"isFederationDisabled"},[t.i18n`Disable federation`,e.p({className:"form-row-description"},t.i18n`Can't be changed later. This will prevent people on other homeservers from joining the room. This is typically used when only people from your own organisation (if applicable) should be allowed in the room, and is otherwise not needed.`)])])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s=>!s.canCreate},t.i18n`Create room`)])])]))}onFormChange(e){switch(e.target.name){case"isEncrypted":this.value.setEncrypted(e.target.checked);break;case"isPublic":this.value.setPublic(e.currentTarget.isPublic.value==="true");break;case"isFederationDisabled":this.value.setFederationDisabled(e.target.checked);break}}onSubmit(e){e.preventDefault(),this.value.create()}}class Yd extends g{render(e,t){const s=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new xe(t,52)),e.mapView(i=>i.isEncrypted,i=>new Xd(i))]),e.div({className:"RoomDetailsView_name"},[e.h2(i=>i.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},i=>i.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},s)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?f.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,s,i){const r=je(yt({RoomDetailsView_label:!0},s));return e.div({className:"RoomDetailsView_row"},[e.div({className:r},[t]),e.div({className:"RoomDetailsView_value"},i)])}_createRightPanelButtonRow(e,t,s,i,r){const o=je(yt({RoomDetailsView_label:!0},s));return e.button({className:"RoomDetailsView_row",onClick:r},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},i)])}}class Xd extends g{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class Zd{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let s=0;for(s=0;s<this.start;s+=1)e.next();for(s=0;s<this.length;s+=1){const i=e.next();if(i.done)break;t(i.value,this.start+s)}}[Symbol.iterator](){return new eu(this)}reverseIterable(){return new tu(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?ve.Before:e<this.end?ve.Inside:ve.After}}var ve;(function(n){n[n.Before=1]="Before",n[n.Inside=2]="Inside",n[n.After=3]="After"})(ve||(ve={}));class eu{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class tu{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}function su(n,e){let t=0;for(;t<e;)if(t+=1,n.next().done)return!1;return!0}function Lt(n,e){if(su(n,e)){const t=n.next();if(!t.done)return t.value}}var Ve;(function(n){n[n.Move=0]="Move",n[n.Add=1]="Add",n[n.Remove=2]="Remove",n[n.RemoveAndAdd=3]="RemoveAndAdd",n[n.UpdateRange=4]="UpdateRange"})(Ve||(Ve={}));class pt extends Zd{constructor(e,t,s,i=t-e){super(e,t);this._totalLength=s,this._viewportItemCount=i}expand(e){if(this.length===0)return this;const t=Math.max(0,this.start-e),s=Math.min(this.totalLength,this.end+e);return new pt(t,s,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,s,i){const r=Math.min(Math.max(0,Math.floor(i/t)),e),o=e-r,a=s!==0?Math.ceil(s/t):0,c=Math.min(a,o);return new pt(r,r+c,e,a)}queryAdd(e,t,s){const i=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=i){const r=this.clampIndex(e,i),o=r===e?t:Lt(s[Symbol.iterator](),r);return this.createAddResult(r,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const s=this.clampIndex(e);return this.createRemoveResult(s,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,s,i){const r=this.getIndexZone(e),o=this.getIndexZone(t);if(r===o){if(r===ve.Before||r===ve.After)return;if(r===ve.Inside)return{type:0,fromIdx:e,toIdx:t}}else{const a=this.clampIndex(t),c=this.clampIndex(e),h=a===t?s:Lt(i[Symbol.iterator](),a);return{type:3,removeIdx:c,addIdx:a,value:h}}}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{const s=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:3,removeIdx:s,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){const s=this.clampIndex(Number.MAX_SAFE_INTEGER),i=Lt(t[Symbol.iterator](),s);return{type:3,removeIdx:e,value:i,addIdx:s,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){const s=this.deriveRange(-1,0,1),i=s.start,r=Lt(t[Symbol.iterator](),i);return{type:3,removeIdx:e,value:r,addIdx:i,newRange:s}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,s=0){const i=this.start-s,r=this.totalLength+e,o=Math.min(Math.max(i,this.end-s+t),r);return new pt(i,o,r,this.viewportItemCount)}}class iu extends mt{constructor(r,i){var o=r,{itemHeight:e,overflowItems:t=20}=o,s=Ps(o,["itemHeight","overflowItems"]);super(s,i);this.itemHeight=e,this.overflowItems=t}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return pt.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){od(this._listElement);const t=document.createDocumentFragment(),s=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(s,i=>{const r=this._childCreator(i);this._childInstances.push(r),t.appendChild(ut(r,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const s of e.reverseIterable())if(!t.containsIndex(s)){const i=s-e.start;this.removeChild(i)}t.forEachInIterator(this._list[Symbol.iterator](),(s,i)=>{if(!e.containsIndex(i)){const r=i-t.start;this.addChild(r,s)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,s=(e.totalLength-e.end)*this.itemHeight,i=this._listElement.style;i.paddingTop=`${t}px`,i.paddingBottom=`${s}px`}mount(){const e=super.mount();return this.scrollContainer=f.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const s=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(s)}onRemove(e,t){const s=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(s)}onMove(e,t,s){const i=this.renderRange.queryMove(e,t,s,this._list);i&&(i.type===Ve.Move?this.moveChild(this.renderRange.toLocalIndex(i.fromIdx),this.renderRange.toLocalIndex(i.toIdx)):this.applyRemoveAddResult(i))}onUpdate(e,t,s){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,s)}applyRemoveAddResult(e){(e.type===Ve.Remove||e.type===Ve.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===Ve.Add||e.type===Ve.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class ru extends g{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new xe(t,32)),e.div({className:"MemberTileView_name"},s=>s.name)]))}}class nu extends iu{constructor(e){super({list:e.memberTileViewModels,className:"MemberListView",itemHeight:40},t=>new ru(t))}}class ou extends g{render(e,t){return e.div({className:"MemberDetailsView"},[e.view(new xe(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(s=>s.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,s=>s.role),this._createSection(e,t.i18n`Security`,t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`),this._createOptions(e,t)])}_createSection(e,t,s){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},s)])}_createOptions(e,t){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`),e.button({className:"text",onClick:()=>t.openDirectMessage()},t.i18n`Open direct message`)])])}}class au extends g{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new cu(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e==null?void 0:e.type){case"room-details":return new Yd(e);case"member-list":return new nu(e);case"member-details":return new ou(e);default:return new Vr}}}class cu extends g{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:!t.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class hu extends g{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":s=>!!s.activeMiddleViewModel,"right-shown":s=>!!s.rightPanelViewModel}},[e.view(new qd(t.sessionStatusViewModel)),e.view(new dd(t.leftPanelViewModel)),e.mapView(s=>s.activeMiddleViewModel,()=>t.roomGridViewModel?new jd(t.roomGridViewModel):t.settingsViewModel?new Jd(t.settingsViewModel):t.createRoomViewModel?new Qd(t.createRoomViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new Ur(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new Nr(t.currentRoomViewModel):t.currentRoomViewModel.kind==="roomBeingCreated"?new Pr(t.currentRoomViewModel):new Ld(t.currentRoomViewModel):new ze(s=>s.div({className:"room-placeholder"},s.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(s=>s.lightboxViewModel,s=>s?new Od(s):null),e.mapView(s=>s.rightPanelViewModel,s=>s?new au(s):null)])}}function Kr(n){return "2959901537"?n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web/releases/tag/v0.2.26"},`Hydrogen v0.2.26 (${"2959901537"}) on Github`):n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class lu extends g{render(e,t){const s=o=>!!o.isBusy,i=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:s}),r=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:s});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(i.value,r.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row text"},[e.label({for:"username"},t.i18n`Username`),i]),e.div({className:"form-row text"},[e.label({for:"password"},t.i18n`Password`),r]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s},t.i18n`Log In`)])])])}}class du extends g{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(s=>s.decryptDehydratedDeviceViewModel,s=>new Dr(s.decryptDehydratedDeviceViewModel)),e.map(s=>s.deviceDecrypted,(s,i)=>s?i.p(t.i18n`That worked out, you're good to go!`):i.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},s=>s.deviceDecrypted?s.i18n`Continue`:s.i18n`Continue without restoring`)])])}}class Kt extends g{render(e){const t=e.if(i=>i.hasError,(i,r)=>i.button({onClick:()=>r.exportLogs()},r.i18n`Export logs`)),s=e.if(i=>i.hasError,(i,r)=>i.button({onClick:()=>r.logout()},r.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[de(e,{hidden:i=>!i.loading}),e.p(i=>i.loadLabel),t,s]),e.ifView(i=>i.accountSetupViewModel,i=>new du(i.accountSetupViewModel))])}}class uu extends g{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,s)=>t.p({className:"error"},s.i18n(s.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new Kt(t):null)])}}class mu extends g{render(e,t){const s=i=>i.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:s}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(i=>i.completeSSOLoginViewModel,i=>i?new uu(i):null),e.if(i=>i.showHomeserver,(i,r)=>i.div({className:"LoginView_sso form-row text"},[i.label({for:"homeserver"},r.i18n`Homeserver`),i.input({id:"homeserver",type:"text",placeholder:r.i18n`Your matrix homeserver`,value:r.homeserver,disabled:s,onInput:o=>r.setHomeserver(o.target.value),onChange:()=>r.queryHomeserver()}),i.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),i.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(i=>i.isFetchingLoginOptions,i=>i.div({className:"LoginView_query-spinner"},[de(i),i.p("Fetching available login options...")])),e.mapView(i=>i.passwordLoginViewModel,i=>i?new lu(i):null),e.if(i=>i.passwordLoginViewModel&&i.startSSOLoginViewModel,i=>i.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(i=>i.startSSOLoginViewModel,i=>i?new _u(i):null),e.mapView(i=>i.loadViewModel,i=>i?new Kt(i):null),e.p(Kr(e))])}}class _u extends g{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:s=>s.isBusy},t.i18n`Log in with SSO`))}}class pu extends g{render(e,t){const s=new Ut(t,r=>r.div([r.p("Are you sure you want to log out?"),r.div({className:"button-row"},[r.a({className:"button-action",type:"submit",href:t.cancelUrl},["Cancel"]),r.button({className:"button-action primary destructive",type:"submit",onClick:()=>t.logout()},t.i18n`Log out`)])])),i=new Ut(t,r=>r.p({className:"status",hidden:o=>!o.showStatus},[de(r,{hidden:o=>!o.busy}),r.span(o=>o.status)]));return e.div({className:"LogoutScreen"},[e.div({className:"content"},[e.mapView(r=>r.showConfirm,r=>r?s:i)])])}}class gu extends g{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new Kt(t))]),e.div({className:{"button-row":!0,hidden:s=>s.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class fu extends g{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},s=>s.avatarInitials),e.div({className:"user-id"},s=>s.label)])])}}class yu extends g{render(e,t){const s=new mt({list:t.sessions,parentProvidesUpdates:!1},i=>new fu(i));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as \u2026"]),e.view(s),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(i=>i.loadViewModel,()=>new Kt(t.loadViewModel)),e.p(Kr(e))])])}}class wu extends g{render(e,t){return e.mapView(s=>s.activeSection,s=>{switch(s){case"error":return new ze(i=>i.div({className:"StatusView"},[i.h1("Something went wrong"),i.p(t.errorText)]));case"session":return new hu(t.sessionViewModel);case"login":return new mu(t.loginViewModel);case"logout":return new pu(t.logoutViewModel);case"picker":return new yu(t.sessionPickerViewModel);case"redirecting":return new ze(i=>i.p("Redirecting..."));case"loading":return new gu(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}}class vu{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,s)=>{this._reject=s,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new J),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class bu{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class Su{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class Iu{createMeasure(){return new Su}createTimeout(e){return new vu(e)}createInterval(e,t){return new bu(t,e)}now(){return Date.now()}}class Eu{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,s=t.replyTo;if(s){const i=this._waitingForReply.get(s);i&&(this._waitingForReply.delete(s),i(t.payload))}if(t.type==="hasSessionOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:i})}else if(t.type==="hasRoomOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId,r=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:i&&r})}else if(t.type==="closeSession"){const{sessionId:i}=t.payload;this._closeSessionIfNeeded(i).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){var s;const t=(s=this._navigation)==null?void 0:s.path.get("session");return e&&(t==null?void 0:t.value)===e?new Promise(i=>{const r=this._navigation.pathObservable.subscribe(o=>{const a=o.get("session");(!a||a.value!==e)&&(r(),i())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),s.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),this._messageIdCounter+=1;const i=this._messageIdCounter,r=new Promise(o=>{this._waitingForReply.set(i,o)});return s.postMessage({type:e,id:i,payload:t}),await r}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.2.26"}get buildHash(){return "2959901537"}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class ku{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){var i;const s=await((i=this._serviceWorkerHandler)==null?void 0:i.getRegistration());if(s==null?void 0:s.pushManager){const o=(await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),a=o.keys.p256dh,c={endpoint:o.endpoint,auth:o.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,a,c)}}async disablePush(){var t;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());if(e==null?void 0:e.pushManager){const s=await e.pushManager.getSubscription();s&&await s.unsubscribe()}}async isPushEnabled(){var t;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());return(e==null?void 0:e.pushManager)?!!await e.pushManager.getSubscription():!1}async supportsPush(){var t;if(!this._pushConfig)return!1;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());return e&&"pushManager"in e}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){var i;if("Notification"in window){new Notification(e,{body:t});return}const s=await((i=this._serviceWorkerHandler)==null?void 0:i.getRegistration());s==null||s.showNotification(e,{body:t})}}class Ru extends Ue{handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){var t;(t=window.localStorage)==null||t.setItem("hydrogen_last_url_hash",e)}getLastUrl(){var e;return(e=window.localStorage)==null?void 0:e.getItem("hydrogen_last_url_hash")}}class Cu extends Ue{constructor(){super();this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function P(n,e){return n instanceof Promise?n:new Promise((t,s)=>{n.oncomplete=i=>t(i.target.result),n.onerror=()=>s(new Error("Crypto error on "+e))})}class Mu{constructor(e){this._subtleCrypto=e}async verify(e,t,s,i){const r={name:"HMAC",hash:{name:Pe(i)}},o=await P(this._subtleCrypto.importKey("raw",e,r,!1,["verify"]),"importKey");return await P(this._subtleCrypto.verify(r,o,t,s),"verify")}async compute(e,t,s){const i={name:"HMAC",hash:{name:Pe(s)}},r=await P(this._subtleCrypto.importKey("raw",e,i,!1,["sign"]),"importKey"),o=await P(this._subtleCrypto.sign(i,r,t),"sign");return new Uint8Array(o)}}class Tu{constructor(e,t,s){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=s}async pbkdf2(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const o=await P(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await P(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:s,iterations:t,hash:Pe(i)},o,r),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,s,i,r);const o=await P(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await P(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:s,hash:Pe(i)},o,r),"deriveBits");return new Uint8Array(a)}}class Au{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){const o={name:"AES-CTR",counter:s,length:r};let a;try{const c=e||t,h=t?"jwk":"raw";a=await P(this._subtleCrypto.importKey(h,c,o,!1,["decrypt"]),"importKey")}catch(c){throw new Error(`Could not import key for AES-CTR decryption: ${c.message}`)}try{const c=await P(this._subtleCrypto.decrypt(o,a,i),"decrypt");return new Uint8Array(c)}catch(c){throw new Error(`Could not decrypt with AES-CTR: ${c.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){const r={name:"AES-CTR",counter:s,length:64};let o;const a=e||t,c=t?"jwk":"raw";try{o=await P(this._subtleCrypto.importKey(c,a,r,!1,["encrypt"]),"importKey")}catch(h){throw new Error(`Could not import key for AES-CTR encryption: ${h.message}`)}try{const h=await P(this._subtleCrypto.encrypt(r,o,i),"encrypt");return new Uint8Array(h)}catch(h){throw new Error(`Could not encrypt with AES-CTR: ${h.message}`)}}async generateKey(e,t=256){const s=await P(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return P(this._subtleCrypto.exportKey(e,s))}async generateIV(){return Or(this._crypto)}}function Or(n){const e=n.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let s=0;s<e.length;s+=1)t[s]=e[s];return t}function Fr(n){if(n.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${n.alg}`);if(!n.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(n.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${n.kty}`);const t=n.k.replace(/-/g,"+").replace(/_/g,"/");return Ge.decode(t)}function xu(n){const e=Ge.encode(n),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function Nu(n){return xu(n).replace(/\+/g,"-").replace(/\//g,"_")}function Vu(n){return{alg:"A256CTR",ext:!0,k:Nu(n),key_ops:["encrypt","decrypt"],kty:"oct"}}class Pu{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){if(r!==64)throw new Error(`Unsupported counter length: ${r}`);t&&(e=Fr(t));const o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(s)));return a.decrypt(new Uint8Array(i))}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){t&&(e=Fr(t));const r=this._aesjs;var o=new r.ModeOfOperation.ctr(new Uint8Array(e),new r.Counter(new Uint8Array(s)));return o.encrypt(new Uint8Array(i))}async generateKey(e,t=256){let s=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(s=Vu(s)),s}async generateIV(){return Or(this._crypto)}}function Pe(n){if(n!=="SHA-256"&&n!=="SHA-512")throw new Error(`Invalid hash name: ${n}`);return n}class Uu{constructor(e){const t=window.crypto||window.msCrypto,s=t.subtle||t.webkitSubtle;this._subtleCrypto=s,!s.deriveBits&&(e==null?void 0:e.aesjs)?this.aes=new Pu(e.aesjs,t):this.aes=new Au(s,t),this.hmac=new Mu(s),this.derive=new Tu(s,this,e)}async digest(e,t){return await P(this._subtleCrypto.digest(Pe(e),t))}digestSize(e){switch(Pe(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${Pe(e)}`)}}}async function Du(){var n;if((n=navigator==null?void 0:navigator.storage)==null?void 0:n.estimate){const{quota:e,usage:t}=await navigator.storage.estimate();return{quota:e,usage:t}}else return{quota:null,usage:null}}class Bu{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class Lu{constructor(e,t){this._promise=new Promise((s,i)=>{this._resolve=s,this._reject=i}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class Ku{constructor(e,t){this._workers=[];for(let s=0;s<t;++s){const i=new Bu(new Worker(e));i.attach(this),this._workers[s]=i}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise((t,s)=>{this._init={resolve:t,reject:s}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){const t=e.data,s=this._requests.get(t.replyToId);if(s){if(s._worker.busy=!1,s._isNotDisposed){if(t.type==="success")s._resolve(t.payload);else if(t.type==="error"){const i=new Error(t.message);i.stack=t.stack,s._reject(i)}s._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;const t=this._getPendingRequest();if(t){const s=this._getFreeWorker();s&&(this._sendWith(t,s),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new Lu(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),s=this._getFreeWorker();return s&&this._sendWith(t,s),t}sendAll(e){const t=this._workers.map(s=>{const i=this._enqueueRequest(Object.assign({},e));return this._sendWith(i,s),i.response()});return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new J),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}class gt{static async fromBlob(e){const t=await $r(e),{width:s,height:i}=t;return new gt(e,s,i,t)}constructor(e,t,s,i){this.blob=e,this.width=t,this.height=s,this._domElement=i}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await $r(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,s=Math.min(1,e/(t>=1?this.width:this.height)),i=Math.round(this.width*s),r=Math.round(this.height*s),o=document.createElement("canvas");o.width=i,o.height=r;const a=o.getContext("2d"),c=await this._getDomElement();a.drawImage(c,0,0,i,r);let h=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",l;if(o.toBlob)l=await new Promise(u=>o.toBlob(u,h));else if(o.msToBlob)h="image/png",l=o.msToBlob();else throw new Error("canvas can't be turned into blob");const d=Se.fromBlob(l);return new gt(d,i,r,null)}dispose(){this.blob.dispose()}}class Ms extends gt{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){const t=await Fu(e),{videoWidth:s,videoHeight:i}=t;return new Ms(e,s,i,t)}}function Ou(){const n=document.createElement("canvas");n.width=1,n.height=1;const e=n.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);const s=e.getImageData(0,0,1,1).data;return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]}async function $r(n){const e=document.createElement("img"),t=Dt(e,"load");return e.src=n.url,await t,e}async function Fu(n){const e=document.createElement("video");e.muted=!0;const t=Dt(e,"loadedmetadata");e.src=n.url,e.load(),await t;const s=Dt(e,"seeked");return await new Promise(i=>setTimeout(i,200)),e.currentTime=.1,await s,e}async function $u(n,e,t,s,i){let r=n.querySelector("iframe.downloadSandbox");if(!r){r=document.createElement("iframe"),r.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),r.setAttribute("src",e),r.className="hidden downloadSandbox",n.appendChild(r);let o;await new Promise((a,c)=>{o=()=>{r.removeEventListener("load",a),r.removeEventListener("error",c)},r.addEventListener("load",a),r.addEventListener("error",c)}),o()}if(i){const o=await t.readAsBuffer();r.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:s},"*")}else r.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:s},"*")}class qu{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const ju={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,FORBID_TAGS:["mx-reply"],KEEP_CONTENT:!1};function Wu(n){const e=Jr.sanitize(n,ju),t=new DOMParser().parseFromString(e,"text/html").body;return new qu(t)}function qr(n){return new Promise(function(e,t){var s=document.createElement("script");s.setAttribute("src",n),s.onload=e,s.onerror=t,document.body.appendChild(s)})}async function Hu(n){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),n?(window.WebAssembly?(await qr(n.wasmBundle),await window.Olm.init({locateFile:()=>n.wasm})):(await qr(n.legacyBundle),await window.Olm.init()),window.Olm):null}function zu(n){return n.startsWith("/")?n:new URL(n,document.location.href).pathname}async function Gu(n){const e=new Ku(n.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:zu(n.olm.legacyBundle)}),new Ql(e)}function Ju(n){if(!window.visualViewport)return;const e=()=>{const t=n.querySelector(".SessionView");if(!t)return;const s=n.querySelector(".bottom-aligned-scroll");let i,r,o;s&&(i=s.scrollTop,r=s.offsetHeight);const a=t.offsetTop+t.offsetHeight-window.visualViewport.height;n.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),n.style.setProperty("--ios-viewport-top",a.toString()+"px"),s&&(o=s.offsetHeight,s.scrollTop=i+r-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}class Qu{constructor(e,t,s,i=null,r=null){this._container=e,this._assetPaths=t,this._config=s,this.settingsStorage=new Wl("hydrogen_setting_v1_"),this.clock=new Iu,this.encoding=new Jl,this.random=Math.random,this._createLogger(i==null?void 0:i.development),this.history=new Ru,this.onlineStatus=new Cu,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new Eu,this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=new ku(this._serviceWorkerHandler,s.push),this.crypto=new Uu(r),this.storageFactory=new Ho(this._serviceWorkerHandler),this.sessionInfoStorage=new jl("hydrogen_sessions_v1"),this.estimateStorageUsage=Du,typeof fetch=="function"?this.request=ql(this.clock.createTimeout,this._serviceWorkerHandler):this.request=gr;const o=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=o;const a=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=a,this._disposables=new ns,this._olmPromise=void 0,this._workerPromise=void 0}_createLogger(e){const t=s=>{var i;return((i=s.e)==null?void 0:i.stack)&&(s.e.stack=s.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),s};e?this.logger=new Zl({platform:this}):this.logger=new Yl({name:"hydrogen_logs",platform:this,serializedTransformer:t})}get updateService(){return this._serviceWorkerHandler}loadOlm(){return this._olmPromise||(this._olmPromise=Hu(this._assetPaths.olm)),this._olmPromise}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return this._workerPromise||(this._workerPromise=Gu(this._assetPaths)),this._workerPromise}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const s=Ju(this._container);s&&this._disposables.track(s)}this._container.addEventListener("error",Cr,!0),this._disposables.track(()=>this._container.removeEventListener("error",Cr,!0)),window.__hydrogenViewModel=e;const t=new wu(e);this._container.appendChild(t.mount())}setNavigation(e){var t;(t=this._serviceWorkerHandler)==null||t.setNavigation(e)}createBlob(e,t){return Se.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):$u(this._container,this._assetPaths.downloadSandbox,e,t,this.isIOS)}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const s=new Promise(i=>{const r=()=>{t.removeEventListener("change",r,!0);const o=t.files[0];this._container.removeChild(t),o?i({name:o.name,blob:Se.fromBlob(o)}):i()};t.addEventListener("change",r,!0)});return this._container.appendChild(t),t.click(),s}openUrl(e){location.href=e}parseHTML(e){return Wu(e)}async loadImage(e){return gt.fromBlob(e)}async loadVideo(e){return Ms.fromBlob(e)}hasReadPixelPermission(){return Ou()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.2.26"}dispose(){this._disposables.dispose()}}var Yu=`{
  "push": {
    "appId": "io.element.hydrogen.web",
    "gatewayUrl": "https://matrix.org",
    "applicationServerKey": "BC-gpSdVHEXhvHSHS0AzzWrQoukv2BE7KzpoPO_FfPacqOo3l1pdqz7rSgmB04pZCWaHPz7XRe6fjLaC-WPDopM"
  },
  "defaultHomeServer": "boba.best"
}
`,Xu="./assets/download-sandbox.48a866e9.html",Zu="./assets/main.bdb9a925.js",jr={downloadSandbox:Xu,worker:Zu,olm:{wasm:Qr,legacyBundle:Yr,wasmBundle:Xr}};jr.serviceWorker="sw.js";const em=new Qu(document.body,jr,JSON.parse(Yu),{development:!1});Ll(em);
//# sourceMappingURL=index.e1505b4c.js.map
